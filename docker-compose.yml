version: '3.8'

services:
  health-monitor:
    build: .
    image: camunda-health-monitor:latest
    container_name: camunda-health-monitor
    ports:
      - "5000:5000"
    environment:
      # Database Configuration
      - DB_NAME=${DB_NAME:-camunda}
      - DB_USER=${DB_USER:-camunda}
      - DB_PASSWORD=${DB_PASSWORD:-camunda}
      - DB_HOST=${DB_HOST:-localhost}
      - DB_PORT=${DB_PORT:-5432}

      # Camunda Nodes
      - CAMUNDA_NODE_1_NAME=${CAMUNDA_NODE_1_NAME}
      - CAMUNDA_NODE_1_URL=${CAMUNDA_NODE_1_URL}
      - CAMUNDA_NODE_2_NAME=${CAMUNDA_NODE_2_NAME}
      - CAMUNDA_NODE_2_URL=${CAMUNDA_NODE_2_URL}
      - CAMUNDA_NODE_3_NAME=${CAMUNDA_NODE_3_NAME}
      - CAMUNDA_NODE_3_URL=${CAMUNDA_NODE_3_URL}
      - CAMUNDA_NODE_4_NAME=${CAMUNDA_NODE_4_NAME}
      - CAMUNDA_NODE_4_URL=${CAMUNDA_NODE_4_URL}

      # Camunda Authentication
      - CAMUNDA_API_USER=${CAMUNDA_API_USER}
      - CAMUNDA_API_PASSWORD=${CAMUNDA_API_PASSWORD}

      # JMX Endpoints
      - JMX_NODE_1_URL=${JMX_NODE_1_URL}
      - JMX_NODE_2_URL=${JMX_NODE_2_URL}
      - JMX_NODE_3_URL=${JMX_NODE_3_URL}
      - JMX_NODE_4_URL=${JMX_NODE_4_URL}

      # Application Configuration
      - JVM_METRICS_SOURCE=${JVM_METRICS_SOURCE:-jmx}
      - STUCK_INSTANCE_DAYS=${STUCK_INSTANCE_DAYS:-7}
      - PORT=${PORT:-5000}
      - DEBUG=${DEBUG:-false}
      - JSON_LOGGING=${JSON_LOGGING:-false}
      - SSL_VERIFY=${SSL_VERIFY:-false}

    volumes:
      # Persist logs
      - ./logs:/app/logs

    restart: unless-stopped

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Uncomment to use host network mode if monitoring Camunda on localhost
    # network_mode: host

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
