<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camunda Health Monitor</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <!-- Alpine.js with Intersect plugin -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 5px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Custom scrollbar for specific sections */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        /* Loading animation */
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #374151;
            border-top-color: #0ea5e9;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Status pulse animation */
        @keyframes statusPulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }

        .bg-green-500, .bg-yellow-500, .bg-red-500 {
            animation: statusPulse 2s ease-in-out infinite alternate;
        }

        /* Dark mode transitions */
        * {
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }

        /* Mobile menu */
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900" x-data="healthMonitor()">
<!-- Header -->
<header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
    <div class="mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center space-x-3">
                <i data-lucide="activity" class="h-8 w-8 text-sky-600 dark:text-sky-400"></i>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">
                        Champa Health Monitor
                    </h1>
                    <p class="hidden md:block text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Real-time Camunda cluster monitoring
                    </p>
                </div>
            </div>

            <!-- Tab Navigation in Header -->
            <div class="hidden lg:flex items-center space-x-2">
                <button @click="activeTab = 'dashboard'"
                        :class="activeTab === 'dashboard'
                            ? 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 border-cyan-300 dark:border-cyan-700'
                            : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'"
                        class="inline-flex items-center space-x-2 px-4 py-2 border rounded-lg font-medium text-sm transition-colors">
                    <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                    <span>Dashboard</span>
                </button>
                <button @click="activeTab = 'ai'; if(!aiData) loadAIInsights()"
                        :class="activeTab === 'ai'
                            ? 'bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300 border-sky-300 dark:border-sky-700'
                            : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'"
                        class="inline-flex items-center space-x-2 px-4 py-2 border rounded-lg font-medium text-sm transition-colors">
                    <i data-lucide="brain" class="h-4 w-4"></i>
                    <span>AI / ML Analysis</span>
                </button>
            </div>

            <div class="flex items-center space-x-4">
                <!-- Desktop Controls -->
                <div class="hidden md:flex items-center space-x-4">
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Dark mode</span>
                        <button @click="toggleDarkMode()"
                                :class="darkMode ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full">
                            <span :class="darkMode ? 'translate-x-6' : 'translate-x-1'"
                                  class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                        </button>
                    </div>

                    <!-- Auto-refresh Toggle -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Auto-refresh</span>
                        <button @click="toggleAutoRefresh()"
                                :class="autoRefresh ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full">
                            <span :class="autoRefresh ? 'translate-x-6' : 'translate-x-1'"
                                  class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                        </button>
                    </div>

                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Last updated: <span class="font-medium text-gray-700 dark:text-gray-300"
                                            x-text="formatTime(data.timestamp)"></span>
                    </div>
                </div>

                <!-- Refresh Button (visible on all sizes) -->
                <button @click="refreshData()"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i data-lucide="refresh-cw" class="h-4 w-4" :class="{ 'animate-spin': isLoading }"></i>
                    <span class="hidden sm:block ml-2">Refresh</span>
                </button>

                <!-- Mobile Menu Button -->
                <button @click="mobileMenuOpen = true"
                        class="md:hidden p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800">
                    <i data-lucide="menu" class="h-6 w-6"></i>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Mobile Off-Canvas Menu -->
<div x-show="mobileMenuOpen" x-cloak class="relative z-50 md:hidden" @keydown.escape.window="mobileMenuOpen = false">
    <!-- Backdrop -->
    <div x-show="mobileMenuOpen"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-75"></div>

    <!-- Panel -->
    <div class="fixed inset-0 flex justify-end">
        <div x-show="mobileMenuOpen"
             @click.away="mobileMenuOpen = false"
             x-transition:enter="transition ease-in-out duration-300 transform"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in-out duration-300 transform"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="relative flex w-full max-w-xs flex-col overflow-y-auto bg-white dark:bg-gray-800 pb-12 shadow-xl">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 pt-5 pb-2 border-b dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Menu</h3>
                <button type="button" class="-m-2 inline-flex items-center justify-center rounded-md p-2 text-gray-400"
                        @click="mobileMenuOpen = false">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <!-- Dashboard Controls -->
            <div class="space-y-6 border-b border-gray-200 dark:border-gray-700 px-4 py-6">
                <h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Navigation</h4>

                <!-- Tab Navigation for Mobile -->
                <div class="flex flex-col space-y-2">
                    <button @click="activeTab = 'dashboard'; mobileMenuOpen = false"
                            :class="activeTab === 'dashboard'
                                ? 'bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300 border-sky-300 dark:border-sky-700'
                                : 'bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-600'"
                            class="flex items-center space-x-2 px-4 py-3 border rounded-lg font-medium text-sm transition-colors">
                        <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                        <span>Dashboard</span>
                    </button>
                    <button @click="activeTab = 'ai'; if(!aiData) loadAIInsights(); mobileMenuOpen = false"
                            :class="activeTab === 'ai'
                                ? 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 border-purple-300 dark:border-purple-700'
                                : 'bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-600'"
                            class="flex items-center space-x-2 px-4 py-3 border rounded-lg font-medium text-sm transition-colors">
                        <i data-lucide="brain" class="h-4 w-4"></i>
                        <span>AI / ML Analysis</span>
                    </button>
                </div>
            </div>

            <div class="space-y-6 border-b border-gray-200 dark:border-gray-700 px-4 py-6">
                <h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Dashboard Controls</h4>

                <div class="flex items-center justify-between">
                    <span class="text-base text-gray-900 dark:text-gray-100">Dark Mode</span>
                    <button @click="toggleDarkMode()" :class="darkMode ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                            class="relative inline-flex h-6 w-11 items-center rounded-full">
                        <span :class="darkMode ? 'translate-x-6' : 'translate-x-1'"
                              class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-base text-gray-900 dark:text-gray-100">Auto-refresh</span>
                    <button @click="toggleAutoRefresh()"
                            :class="autoRefresh ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                            class="relative inline-flex h-6 w-11 items-center rounded-full">
                        <span :class="autoRefresh ? 'translate-x-6' : 'translate-x-1'"
                              class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                    </button>
                </div>

                <div class="flex items-center justify-between text-base text-gray-900 dark:text-gray-100">
                    <span>Last updated:</span>
                    <span class="font-medium" x-text="formatTime(data.timestamp)"></span>
                </div>

                <button @click="refreshData(); mobileMenuOpen = false;"
                        class="w-full inline-flex items-center justify-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i data-lucide="refresh-cw" class="h-4 w-4 mr-2" :class="{ 'animate-spin': isLoading }"></i>
                    Refresh Now
                </button>
            </div>
        </div>
    </div>
</div>

<main class="mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Issues Alert -->
    <div x-show="data.cluster_status.issues.length > 0"
         class="mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4">
        <div class="flex items-start">
            <i data-lucide="alert-octagon" class="h-6 w-6 text-red-600 dark:text-red-400 mt-0.5"></i>
            <div class="ml-3">
                <h3 class="text-lg font-semibold text-red-900 dark:text-red-200">System Issues Detected</h3>
                <div class="mt-2 space-y-1">
                    <template x-for="issue in data.cluster_status.issues" :key="issue">
                        <p class="text-sm text-red-700 dark:text-red-300" x-text="'â€¢ ' + issue"></p>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab Content -->
    <div x-show="activeTab === 'dashboard'">
    <!-- Main Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6">
        <!-- Engine Status -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-sky-500 to-sky-600 dark:from-sky-700/70 dark:to-sky-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="server" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">ENGINE STATUS</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        Overall health of the Camunda Engine cluster. Shows how many nodes are currently running out of
                        the total configured.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold"
                      :class="data.cluster_status.running_nodes === data.cluster_status.total_nodes
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-yellow-600 dark:text-yellow-400'"
                      x-text="data.cluster_status.running_nodes + '/' + data.cluster_status.total_nodes"></span>
                    <span class="text-xs px-2 py-1 rounded-full"
                          :class="data.cluster_status.running_nodes === data.cluster_status.total_nodes
                          ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                          : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'"
                          x-text="data.cluster_status.running_nodes === data.cluster_status.total_nodes ? 'ALL UP' : 'PARTIAL'"></span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                    Version: <span class="text-gray-700 dark:text-gray-300"
                                   x-text="data.cluster_status.engine_version"></span>
                </p>
            </div>
        </div>

        <!-- Database -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-green-500 to-green-600 dark:from-green-700/70 dark:to-green-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="database" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">DATABASE</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        Monitors the health of the connection to the backend database. Shows query latency and
                        connection pool utilization.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold"
                      :class="data.db_metrics.connectivity === 'OK'
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-red-600 dark:text-red-400'"
                      x-text="data.db_metrics.connectivity === 'OK' ? formatDuration(data.db_metrics.latency_ms) : 'ERROR'"></span>
                    <span class="text-xs px-2 py-1 rounded-full"
                          :class="data.db_metrics.connectivity === 'OK'
                          ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                          : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'"
                          x-text="data.db_metrics.connectivity"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 dark:text-gray-400">Connections:</span>
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                          x-text="data.db_metrics.active_connections + '/' + data.db_metrics.max_connections"></span>
                </div>
                <div class="mt-1">
                    <div class="h-1 bg-gray-200 dark:bg-gray-600 rounded-full">
                        <div class="h-1 bg-green-500 dark:bg-green-400 rounded-full"
                             :style="`width: ${data.db_metrics.connection_utilization}%`"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Executor -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"
             x-intersect.once="loadMetric('job-throughput')">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-700/70 dark:to-purple-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="cpu" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center space-x-2">
                    <div class="group relative flex items-center">
                        <span class="text-xs text-white font-medium opacity-90 mr-2">JOB EXECUTOR</span>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                        <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                            Health of the asynchronous job executor. Shows total pending jobs and execution throughput.
                        </div>
                    </div>
                    <button @click="refreshMetric('job-throughput')"
                            class="text-white opacity-70 hover:opacity-100 transition-opacity">
                        <i data-lucide="refresh-cw" class="h-4 w-4"
                           :class="{ 'animate-spin': metricLoading['job-throughput'] }"></i>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold text-gray-800 dark:text-gray-200"
                      x-text="formatNumber(data.totals.total_jobs)"></span>

                    <!-- Loading State -->
                    <template x-if="metricLoading['job-throughput']">
                        <div class="h-6 w-16 bg-gray-200 dark:bg-gray-600 rounded-full animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['job-throughput'] && !metricLoading['job-throughput']">
                    <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400"
                          x-text="(metricData['job-throughput']?.jobs_executed_per_min || 0).toFixed(1) + '/min'"></span>
                    </template>

                    <!-- Initial/Fallback Content -->
                    <template x-if="!metricLoading['job-throughput'] && !metricData['job-throughput']">
                    <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400">
                        --/min
                    </span>
                    </template>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">No Retries:</span>
                        <span class="text-xs font-medium"
                              :class="data.totals.failed_jobs > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-300'"
                              x-text="data.totals.failed_jobs"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Executable:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="formatNumber(data.totals.active_jobs)"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- External Tasks -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 dark:from-cyan-700/70 dark:to-cyan-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="plug-zap" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">EXTERNAL TASKS</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        State of the external task queue waiting for workers to fetch them.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold text-gray-800 dark:text-gray-200"
                      x-text="formatNumber(data.totals.external_tasks)"></span>
                    <span class="text-xs px-2 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400">QUEUED</span>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Processing:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="sumNodeMetric('external_tasks_locked')"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Failed:</span>
                        <span class="text-xs font-medium"
                              :class="sumNodeMetric('external_tasks_no_retries') > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-300'"
                              x-text="sumNodeMetric('external_tasks_no_retries')"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Definitions -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 dark:from-indigo-700/80 dark:to-indigo-800/80 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="package" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">DEFINITIONS</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        Total count of all deployed artifacts including process and decision models.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold text-gray-800 dark:text-gray-200"
                      x-text="formatNumber(data.totals.deployment_count)"></span>
                    <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400">DEPLOYMENTS</span>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Process Defs:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="data.totals.process_definitions"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">DMN Defs:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="data.totals.dmn_definitions"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Process Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
        <!-- Active Instances -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-sky-500 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center group relative">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Active Instances</p>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Total number of process instances currently running.
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                       x-text="formatNumber(data.totals.active_instances)"></p>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-sky-100 dark:bg-sky-900/30">
                    <i data-lucide="play-circle" class="h-6 w-6 text-sky-600 dark:text-sky-400"></i>
                </div>
            </div>
        </div>

        <!-- User Tasks -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-green-500 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center group relative">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300">User Tasks</p>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Human tasks waiting for user action.
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                       x-text="formatNumber(data.totals.user_tasks)"></p>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-green-100 dark:bg-green-900/30">
                    <i data-lucide="users" class="h-6 w-6 text-green-600 dark:text-green-400"></i>
                </div>
            </div>
        </div>

        <!-- Open Incidents -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 p-4"
             :class="data.totals.incidents > 0 ? 'border-l-red-500' : 'border-l-gray-300 dark:border-l-gray-600'">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center group relative">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Open Incidents</p>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Critical errors that have stopped process instances.
                        </div>
                    </div>
                    <p class="text-3xl font-bold mt-2"
                       :class="data.totals.incidents > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-200'"
                       x-text="formatNumber(data.totals.incidents)"></p>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg"
                     :class="data.totals.incidents > 0 ? 'bg-red-100 dark:bg-red-900/30' : 'bg-green-100 dark:bg-green-900/30'">
                    <i data-lucide="alert-triangle" class="h-6 w-6"
                       :class="data.totals.incidents > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"></i>
                </div>
            </div>
        </div>

        <!-- Stuck Instances -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-yellow-500 p-4"
             x-intersect.once="loadMetric('stuck-instances')">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center group relative justify-between">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Stuck Instances</p>
                            <i data-lucide="help-circle"
                               class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                            <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                                Active instances with no activity for over {{ stuck_days }} days.
                            </div>
                            <button @click="refreshMetric('stuck-instances')"
                                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors ml-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4"
                                   :class="{ 'animate-spin': metricLoading['stuck-instances'] }"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <template x-if="metricLoading['stuck-instances']">
                        <div class="mr-4 mt-2 h-10 bg-gray-200 dark:bg-gray-600 rounded animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['stuck-instances'] && !metricLoading['stuck-instances']">
                        <p class="text-3xl font-bold mt-2"
                           :class="(metricData['stuck-instances']?.value || 0) > 0 ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-900 dark:text-gray-200'"
                           x-text="formatNumber(metricData['stuck-instances']?.value || 0)"></p>
                    </template>

                    <!-- Error State -->
                    <template x-if="metricErrors['stuck-instances'] && !metricLoading['stuck-instances']">
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                            <span>Error</span>
                            <button @click="refreshMetric('stuck-instances')" class="ml-1 underline">Retry</button>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-yellow-100 dark:bg-yellow-900/30">
                    <i data-lucide="pause-circle" class="h-6 w-6 text-yellow-600 dark:text-yellow-400"></i>
                </div>
            </div>
        </div>

        <!-- Pending Messages -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-cyan-500 p-4"
             x-intersect.once="loadMetric('pending-messages')">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center group relative justify-between">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Pending Messages</p>
                            <i data-lucide="help-circle"
                               class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                            <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                                Instances waiting for message correlation.
                            </div>
                            <button @click="refreshMetric('pending-messages')"
                                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors ml-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4"
                                   :class="{ 'animate-spin': metricLoading['pending-messages'] }"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <template x-if="metricLoading['pending-messages']">
                        <div class="mr-4 mt-2 h-10 bg-gray-200 dark:bg-gray-600 rounded animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['pending-messages'] && !metricLoading['pending-messages']">
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                           x-text="formatNumber(metricData['pending-messages']?.value || 0)"></p>
                    </template>

                    <!-- Error State -->
                    <template x-if="metricErrors['pending-messages'] && !metricLoading['pending-messages']">
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                            <span>Error</span>
                            <button @click="refreshMetric('pending-messages')" class="ml-1 underline">Retry</button>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-cyan-100 dark:bg-cyan-900/30">
                    <i data-lucide="message-square" class="h-6 w-6 text-cyan-600 dark:text-cyan-400"></i>
                </div>
            </div>
        </div>

        <!-- Pending Signals -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-teal-500 p-4"
             x-intersect.once="loadMetric('pending-signals')">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center group relative justify-between">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Pending Signals</p>
                            <i data-lucide="help-circle"
                               class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                            <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                                Instances waiting for broadcast signal events.
                            </div>
                            <button @click="refreshMetric('pending-signals')"
                                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors ml-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4"
                                   :class="{ 'animate-spin': metricLoading['pending-signals'] }"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <template x-if="metricLoading['pending-signals']">
                        <div class="mr-4 mt-2 h-10 bg-gray-200 dark:bg-gray-600 rounded animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['pending-signals'] && !metricLoading['pending-signals']">
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                           x-text="formatNumber(metricData['pending-signals']?.value || 0)"></p>
                    </template>

                    <!-- Error State -->
                    <template x-if="metricErrors['pending-signals'] && !metricLoading['pending-signals']">
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                            <span>Error</span>
                            <button @click="refreshMetric('pending-signals')" class="ml-1 underline">Retry</button>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-teal-100 dark:bg-teal-900/30">
                    <i data-lucide="radio-tower" class="h-6 w-6 text-teal-600 dark:text-teal-400"></i>
                </div>
            </div>
        </div>
    </div>
    </div>  <!-- End of Dashboard Tab Content -->

    <!-- AI / ML Analysis Tab Content -->
    <div x-show="activeTab === 'ai'"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">

    <!-- AI Intelligence Layer -->
    <div class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50 dark:from-sky-900/20 dark:via-cyan-900/20 dark:to-blue-900/20 rounded-xl p-6 mb-6 border-2 border-sky-200 dark:border-sky-800 shadow-lg">

        <!-- Header - Always Visible -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <i data-lucide="brain" class="h-7 w-7 text-sky-600 dark:text-sky-400"></i>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                    AI Intelligence Layer
                </h2>
                <span class="ml-2 text-xs px-3 py-1 bg-sky-600 text-white rounded-full">POWERED BY ML</span>
            </div>
            <button @click="refreshAIInsights()"
                    :disabled="aiLoading"
                    class="inline-flex items-center px-4 py-2 border border-sky-300 dark:border-sky-600 shadow-sm text-sm font-medium rounded-md text-sky-700 dark:text-sky-300 bg-white dark:bg-gray-800 hover:bg-sky-50 dark:hover:bg-sky-900/30 disabled:opacity-50">
                <i data-lucide="refresh-cw" class="h-4 w-4 mr-2" :class="{ 'animate-spin': aiLoading }"></i>
                Refresh AI
            </button>
        </div>

        <!-- AI Content -->

            <!-- Loading State -->
            <template x-if="aiLoading && !aiData">
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">AI analyzing the Camunda cluster...</p>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="aiError && !aiData">
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                    <p class="text-red-700 dark:text-red-300 mb-2">Failed to load AI insights</p>
                    <button @click="refreshAIInsights()" class="text-sm text-red-600 dark:text-red-400 underline">Try Again</button>
                </div>
            </template>

            <!-- AI Content -->
            <template x-if="aiData">
                <div>
                <!-- Health Scores Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <!-- Cluster Health Score -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg border-l-4"
                         :class="aiData.health_score.overall_score >= 80 ? 'border-l-green-500' : aiData.health_score.overall_score >= 60 ? 'border-l-yellow-500' : 'border-l-red-500'">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Cluster Health</span>
                            <i data-lucide="activity" class="h-5 w-5 text-sky-600 dark:text-sky-400"></i>
                        </div>
                        <div class="flex items-baseline space-x-2 mb-2">
                            <span class="text-5xl font-bold"
                                  :class="aiData.health_score.overall_score >= 80 ? 'text-green-600 dark:text-green-400' : aiData.health_score.overall_score >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'"
                                  x-text="aiData.health_score.overall_score"></span>
                            <span class="text-2xl text-gray-500">/100</span>
                        </div>
                        <p class="text-xs font-semibold mb-1"
                           :class="aiData.health_score.overall_score >= 80 ? 'text-green-600' : aiData.health_score.overall_score >= 60 ? 'text-yellow-600' : 'text-red-600'"
                           x-text="aiData.health_score.grade"></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="aiData.health_score.factors"></p>
                    </div>

                    <!-- Anomalies Detected -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Anomalies</span>
                            <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <div class="text-4xl font-bold text-yellow-600 dark:text-yellow-400 mb-2"
                             x-text="aiData.anomalies.anomalies?.length || 0"></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Processes behaving abnormally
                        </p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1"
                           x-text="`Analyzed ${aiData.anomalies.total_analyzed || 0} processes`"></p>
                    </div>

                    <!-- SLA Risks -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">SLA Risks</span>
                            <i data-lucide="clock" class="h-5 w-5 text-red-600 dark:text-red-400"></i>
                        </div>
                        <div class="text-4xl font-bold text-red-600 dark:text-red-400 mb-2"
                             x-text="aiData.sla_predictions.at_risk_tasks?.length || 0"></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Tasks likely to breach SLA
                        </p>
                        <template x-if="aiData.sla_predictions.at_risk_tasks?.length > 0">
                            <p class="text-xs font-semibold text-red-600 dark:text-red-400 mt-1">
                                Action required!
                            </p>
                        </template>
                    </div>

                    <!-- Top Bottleneck Impact -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Top Bottleneck</span>
                            <i data-lucide="trending-down" class="h-5 w-5 text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <template x-if="aiData.bottlenecks.bottlenecks?.length > 0">
                            <div>
                                <div class="text-4xl font-bold text-orange-600 dark:text-orange-400 mb-2"
                                     x-text="aiData.bottlenecks.bottlenecks[0].impact_hours_per_week + 'h'"></div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    Wasted per week
                                </p>
                                <p class="text-xs text-gray-700 dark:text-gray-300 mt-1 truncate"
                                   :title="aiData.bottlenecks.bottlenecks[0].activity_name"
                                   x-text="aiData.bottlenecks.bottlenecks[0].activity_name"></p>
                            </div>
                        </template>
                        <template x-if="!aiData.bottlenecks.bottlenecks?.length">
                            <div>
                                <div class="text-4xl font-bold text-green-600 dark:text-green-400 mb-2">âœ“</div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">No bottlenecks detected</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- AI Recommendations -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                        <i data-lucide="lightbulb" class="mr-2 h-5 w-5 text-blue-600 dark:text-blue-400"></i>
                        AI Recommendations
                    </h4>
                    <div class="space-y-2">
                        <template x-for="(rec, index) in aiData.recommendations" :key="index">
                            <div class="flex items-start p-3 bg-white dark:bg-gray-800 rounded-lg border-l-4"
                                 :class="{
                                     'border-l-red-500': rec.priority === 'critical',
                                     'border-l-orange-500': rec.priority === 'high',
                                     'border-l-yellow-500': rec.priority === 'medium',
                                     'border-l-blue-500': rec.priority === 'low'
                                 }">
                                <div class="flex-shrink-0 mr-3">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold"
                                          :class="{
                                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': rec.priority === 'critical',
                                              'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': rec.priority === 'high',
                                              'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': rec.priority === 'medium',
                                              'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': rec.priority === 'low'
                                          }"
                                          x-text="rec.priority.toUpperCase()"></span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-700 dark:text-gray-300 font-medium mb-1" x-text="rec.message"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        <span class="font-semibold">Action:</span> <span x-text="rec.action"></span>
                                    </p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Detailed Insights Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Process Anomalies -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="alert-triangle" class="mr-2 h-4 w-4 text-yellow-600"></i>
                                <span>Process Execution Anomalies</span>
                                <span class="group relative ml-2">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        ML-powered detection of processes running significantly slower than baseline. Uses statistical analysis (Z-score) and compares recent performance to historical averages.
                                    </span>
                                </span>
                            </div>
                            <span class="text-xs text-gray-500" x-text="`Last ${aiData.anomalies.detection_window_days || 7} days`"></span>
                        </h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.anomalies.anomalies?.length > 0">
                                <template x-for="anomaly in aiData.anomalies.anomalies.slice(0, aiDisplayLimits.anomalies)" :key="anomaly.process_key">
                                    <div class="flex items-center justify-between py-2 px-3 rounded border-l-4"
                                         :class="{
                                             'bg-red-50 dark:bg-red-900/20 border-l-red-600': anomaly.severity === 'critical',
                                             'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': anomaly.severity === 'high',
                                             'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': anomaly.severity === 'medium',
                                             'bg-blue-50 dark:bg-blue-900/20 border-l-blue-500': anomaly.severity === 'low'
                                         }">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                                   :title="anomaly.process_key"
                                                   x-text="anomaly.process_key"></p>
                                                <span class="text-xs px-2 py-0.5 rounded-full font-semibold uppercase"
                                                      :class="{
                                                          'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400': anomaly.severity === 'critical',
                                                          'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400': anomaly.severity === 'high',
                                                          'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400': anomaly.severity === 'medium',
                                                          'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400': anomaly.severity === 'low'
                                                      }"
                                                      x-text="anomaly.severity"></span>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">
                                                Baseline: <span x-text="formatDuration(anomaly.baseline_avg_ms)"></span> â†’
                                                Recent: <span x-text="formatDuration(anomaly.recent_avg_ms)"></span>
                                            </p>
                                            <template x-if="anomaly.max_duration_ms && anomaly.max_duration_ms > 3600000">
                                                <p class="text-xs text-red-600 dark:text-red-400 mt-1">
                                                    âš ï¸ Max: <span x-text="formatDuration(anomaly.max_duration_ms)"></span>
                                                </p>
                                            </template>
                                            <template x-if="anomaly.anomaly_types?.includes('extreme_duration')">
                                                <p class="text-xs text-red-600 dark:text-red-400 mt-1">
                                                    ðŸ”´ Potential stuck/hanging process detected
                                                </p>
                                            </template>
                                        </div>
                                        <div class="ml-2 text-right">
                                            <span class="text-sm font-bold"
                                                  :class="anomaly.deviation_pct > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"
                                                  x-text="(anomaly.deviation_pct > 0 ? '+' : '') + anomaly.deviation_pct + '%'"></span>
                                            <template x-if="anomaly.z_score > 0">
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    Z: <span x-text="anomaly.z_score"></span>
                                                </p>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.anomalies.anomalies?.length">
                                <div class="text-center py-8">
                                    <template x-if="aiData.anomalies.health_status === 'excellent'">
                                        <div>
                                            <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">Stable Performance!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 px-4" x-text="aiData.anomalies.message || 'All processes executing consistently'"></p>
                                        </div>
                                    </template>
                                    <template x-if="aiData.anomalies.health_status !== 'excellent'">
                                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="aiData.anomalies.message || 'No anomalies detected'"></p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Incident Patterns -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="alert-circle" class="mr-2 h-4 w-4 text-orange-600"></i>
                                <span>Top Incident Patterns</span>
                                <span class="group relative ml-2">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        Analyzes historical incident data or runtime job failures to identify recurring error patterns. Groups by error type and frequency to help prioritize fixes.
                                    </span>
                                </span>
                            </div>
                            <span class="text-xs text-gray-500" x-text="`${aiData.incidents.unique_patterns || 0} unique patterns`"></span>
                        </h4>

                        <!-- Data source warning if from runtime jobs -->
                        <template x-if="aiData.incidents.data_source === 'runtime_jobs'">
                            <div class="mb-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-xs">
                                <i data-lucide="info" class="h-3 w-3 inline mr-1"></i>
                                <span class="text-yellow-700 dark:text-yellow-300">Analyzing active job exceptions (incident history not logged)</span>
                            </div>
                        </template>

                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.incidents.patterns?.length > 0">
                                <template x-for="(pattern,index) in aiData.incidents.patterns.slice(0, aiDisplayLimits.incidents)" :key="pattern.incident_type + index">
                                    <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded border-l-2 border-l-orange-500">
                                        <div class="flex items-start justify-between mb-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="pattern.incident_type"></p>
                                            <span class="text-xs px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-full font-semibold"
                                                  x-text="pattern.occurrence_count + 'x'"></span>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2 truncate"
                                           :title="pattern.error_message"
                                           x-text="pattern.error_message"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500">
                                            <template x-if="pattern.source === 'runtime_jobs'">
                                                <span>
                                                    <span x-text="pattern.retries_exhausted"></span> with no retries left Â·
                                                    <span x-text="pattern.affected_processes.length"></span> instance(s)
                                                </span>
                                            </template>
                                            <template x-if="pattern.source !== 'runtime_jobs'">
                                                <span>
                                                    <span x-text="pattern.frequency_per_day"></span> per day Â·
                                                    <span x-text="pattern.affected_processes.length"></span> process(es) affected
                                                </span>
                                            </template>
                                        </p>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.incidents.patterns?.length">
                                <div class="text-center py-8">
                                    <template x-if="aiData.incidents.health_status === 'excellent'">
                                        <div>
                                            <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">System Healthy!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="aiData.incidents.message || 'No incidents detected'"></p>
                                        </div>
                                    </template>
                                    <template x-if="aiData.incidents.health_status !== 'excellent'">
                                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="aiData.incidents.message || 'No incident patterns found'"></p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Process Bottlenecks -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="trending-down" class="mr-2 h-4 w-4 text-red-600"></i>
                                <span>Top Process Bottlenecks</span>
                                <span class="group relative ml-2">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        Identifies activities with longest execution times using P95 percentile analysis. Shows potential optimization targets and estimated time savings per week.
                                    </span>
                                </span>
                            </div>
                            <span class="text-xs text-gray-500" x-text="`${aiData.bottlenecks.total_activities_analyzed || 0} activities`"></span>
                        </h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.bottlenecks.bottlenecks?.length > 0">
                                <template x-for="(bottleneck, index) in aiData.bottlenecks.bottlenecks.slice(0, aiDisplayLimits.bottlenecks)" :key="bottleneck.activity_id + index">
                                    <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded border-l-2 border-l-red-500">
                                        <div class="flex items-start justify-between mb-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                               :title="bottleneck.activity_name"
                                               x-text="bottleneck.activity_name"></p>
                                            <span class="text-sm font-bold text-red-600 dark:text-red-400 ml-2"
                                                  x-text="bottleneck.impact_hours_per_week + 'h/wk'"></span>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                            Avg: <span x-text="formatDuration(bottleneck.avg_duration_ms)"></span> Â·
                                            P95: <span x-text="formatDuration(bottleneck.p95_duration_ms)"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500" x-text="`${bottleneck.executions} executions in ${bottleneck.process_key}`"></p>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.bottlenecks.bottlenecks?.length">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No significant bottlenecks detected</p>
                            </template>
                        </div>
                    </div>

                    <!-- Job Failure Predictions -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="zap" class="mr-2 h-4 w-4 text-purple-600"></i>
                                <span>Job Failure Predictions</span>
                                <span class="group relative ml-2">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        Predicts which job types are at risk of failure based on historical failure rates. Helps prioritize preventive maintenance and error handling improvements.
                                    </span>
                                </span>
                            </div>
                            <span class="text-xs text-gray-500" x-text="`${aiData.job_failures.total_jobs_analyzed || 0} job types`"></span>
                        </h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.job_failures.predictions?.length > 0">
                                <template x-for="pred in aiData.job_failures.predictions.slice(0, aiDisplayLimits.jobPredictions)" :key="pred.job_type">
                                    <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded border-l-2"
                                         :class="{
                                             'border-l-red-500': pred.risk_level === 'high',
                                             'border-l-yellow-500': pred.risk_level === 'medium',
                                             'border-l-green-500': pred.risk_level === 'low'
                                         }">
                                        <div class="flex items-start justify-between mb-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                               :title="pred.job_type"
                                               x-text="pred.job_type"></p>
                                            <span class="text-sm font-bold ml-2"
                                                  :class="{
                                                      'text-red-600 dark:text-red-400': pred.risk_level === 'high',
                                                      'text-yellow-600 dark:text-yellow-400': pred.risk_level === 'medium',
                                                      'text-green-600 dark:text-green-400': pred.risk_level === 'low'
                                                  }"
                                                  x-text="pred.failure_rate_pct + '%'"></span>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                            <span x-text="pred.failed_count"></span> failed /
                                            <span x-text="pred.total_executions"></span> total executions
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500" x-text="pred.recommendation"></p>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.job_failures.predictions?.length">
                                <div class="text-center py-8">
                                    <template x-if="aiData.job_failures.data_source === 'none'">
                                        <div>
                                            <i data-lucide="info" class="h-12 w-12 text-blue-500 dark:text-blue-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Job History Not Available</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 px-4" x-text="aiData.job_failures.message || 'Job logging may be disabled or processes use sync execution'"></p>
                                        </div>
                                    </template>
                                    <template x-if="aiData.job_failures.data_source !== 'none'">
                                        <div>
                                            <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">All Jobs Healthy!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="aiData.job_failures.message || 'All jobs executing successfully'"></p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Node Performance Rankings & Process Leaderboard -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Node Performance Rankings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                            <i data-lucide="award" class="mr-2 h-4 w-4 text-indigo-600"></i>
                            <span>Node Performance Rankings</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Ranks cluster nodes based on JVM health metrics (CPU, memory, GC efficiency). Helps identify underperforming nodes that may need attention.
                                </span>
                            </span>
                        </h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.node_performance.rankings?.length > 0">
                                <template x-for="node in aiData.node_performance.rankings" :key="node.node_name">
                                    <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm mr-3"
                                             :class="{
                                                 'bg-yellow-400 text-yellow-900': node.rank === 1,
                                                 'bg-gray-300 text-gray-700': node.rank === 2,
                                                 'bg-orange-300 text-orange-900': node.rank === 3,
                                                 'bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-200': node.rank > 3
                                             }"
                                             x-text="node.rank"></div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="node.node_name"></p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400" x-text="node.recommendation"></p>
                                        </div>
                                        <div class="ml-2 text-right">
                                            <span class="text-lg font-bold"
                                                  :class="{
                                                      'text-green-600 dark:text-green-400': node.performance_score >= 80,
                                                      'text-yellow-600 dark:text-yellow-400': node.performance_score >= 60 && node.performance_score < 80,
                                                      'text-red-600 dark:text-red-400': node.performance_score < 60
                                                  }"
                                                  x-text="node.performance_score"></span>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.node_performance.rankings?.length">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Need at least 2 nodes for comparison</p>
                            </template>
                        </div>
                    </div>

                    <!-- Process Performance Leaderboard -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="trophy" class="mr-2 h-4 w-4 text-yellow-600"></i>
                                <span>Process Performance Leaderboard</span>
                                <span class="group relative ml-2">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        Ranks processes by performance grade (A-F) based on completion rate, average duration, and consistency. Shows best and worst performing processes.
                                    </span>
                                </span>
                            </div>
                            <span class="text-xs text-gray-500" x-text="`${aiData.process_leaderboard.total_processes || 0} processes`"></span>
                        </h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.process_leaderboard.leaderboard?.length > 0">
                                <template x-for="proc in aiData.process_leaderboard.leaderboard.slice(0, aiDisplayLimits.leaderboard)" :key="proc.process_key">
                                    <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <div class="flex-shrink-0 w-10 h-10 rounded flex items-center justify-center font-bold text-lg mr-3"
                                             :class="{
                                                 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': proc.grade === 'A',
                                                 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': proc.grade === 'B',
                                                 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': proc.grade === 'C',
                                                 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': proc.grade === 'D',
                                                 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': proc.grade === 'F'
                                             }"
                                             x-text="proc.grade"></div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                               :title="proc.process_key"
                                               x-text="proc.process_key"></p>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">
                                                <span x-text="proc.instance_count"></span> instances Â·
                                                Avg: <span x-text="formatDuration(proc.avg_duration_ms)"></span>
                                            </p>
                                        </div>
                                        <div class="ml-2 text-right text-xs">
                                            <p class="text-green-600 dark:text-green-400" x-text="proc.completion_rate_pct + '%'"></p>
                                            <p class="text-gray-500 dark:text-gray-400">complete</p>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.process_leaderboard.leaderboard?.length">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No process data available</p>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Advanced ML Features Row -->
                <div class="bg-gradient-to-r from-cyan-100/70 to-sky-50 dark:from-cyan-900/20 dark:to-sky-900/20 rounded-lg p-4 mt-6 mb-6 border border-cyan-200 dark:border-cyan-700"
                     x-intersect.once="loadAdvancedMLFeatures()">
                    <div class="flex items-center mb-4">
                        <i data-lucide="sparkles" class="h-5 w-5 text-cyan-600 dark:text-cyan-400 mr-2"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Advanced ML Features</h3>
                    </div>

                    <!-- Smart Stuck Activities & Capacity Forecast -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Smart Stuck Activity Detection -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                    <i data-lucide="hourglass" class="mr-2 h-4 w-4 text-red-600"></i>
                                    Smart Stuck Activities
                                </h4>
                                <div class="group relative">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <div class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        Statistical P95-based detection. Identifies activities taking abnormally long compared to historical patterns (not hardcoded timeouts).
                                    </div>
                                </div>
                            </div>

                            <!-- Loading/fetch button -->
                            <template x-if="!stuckActivitiesData && !stuckActivitiesLoading">
                                <div class="text-center py-8">
                                    <button @click="loadStuckActivities()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">
                                        <i data-lucide="play-circle" class="h-4 w-4 mr-2"></i>
                                        Analyze Activities
                                    </button>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to detect stuck activities</p>
                                </div>
                            </template>

                            <!-- Loading state -->
                            <template x-if="stuckActivitiesLoading">
                                <div class="flex flex-col items-center justify-center py-8">
                                    <div class="loader mb-2"></div>
                                    <p class="text-xs text-gray-500">Analyzing activity patterns...</p>
                                </div>
                            </template>

                            <!-- Results -->
                            <template x-if="stuckActivitiesData && !stuckActivitiesLoading">
                                <div>
                                    <div class="flex items-center justify-between mb-3 p-2 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <span class="text-sm text-gray-600 dark:text-gray-400">
                                            Found: <span class="font-bold" x-text="stuckActivitiesData.total_found"></span> stuck
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            P<span x-text="stuckActivitiesData.threshold_percentile"></span> Ã— <span x-text="stuckActivitiesData.threshold_multiplier"></span>
                                        </span>
                                    </div>

                                    <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                                        <template x-if="stuckActivitiesData.stuck_activities?.length > 0">
                                            <template x-for="activity in stuckActivitiesData.stuck_activities.slice(0, 10)" :key="activity.activity_instance_id">
                                                <div class="p-3 rounded border-l-4"
                                                     :class="{
                                                         'bg-red-50 dark:bg-red-900/20 border-l-red-600': activity.severity === 'critical',
                                                         'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': activity.severity === 'high',
                                                         'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': activity.severity === 'medium'
                                                     }">
                                                    <div class="flex items-start justify-between">
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                                               :title="activity.activity_name"
                                                               x-text="activity.activity_name"></p>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                                Process: <span x-text="activity.process_key"></span>
                                                            </p>
                                                        </div>
                                                        <div class="ml-2 text-right">
                                                            <span class="text-lg font-bold"
                                                                  :class="{
                                                                      'text-red-600 dark:text-red-400': activity.severity === 'critical',
                                                                      'text-orange-600 dark:text-orange-400': activity.severity === 'high',
                                                                      'text-yellow-600 dark:text-yellow-400': activity.severity === 'medium'
                                                                  }"
                                                                  x-text="activity.duration_ratio + 'x'"></span>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 flex items-center justify-between text-xs">
                                                        <span class="text-gray-500 dark:text-gray-400">
                                                            Stuck for: <span class="font-semibold" x-text="activity.stuck_for_hours + 'h'"></span>
                                                        </span>
                                                        <template x-if="activity.z_score">
                                                            <span class="text-gray-500 dark:text-gray-400">
                                                                Z-score: <span class="font-semibold" x-text="activity.z_score"></span>
                                                            </span>
                                                        </template>
                                                    </div>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="activity.message"></p>
                                                </div>
                                            </template>
                                        </template>

                                        <template x-if="!stuckActivitiesData.stuck_activities?.length">
                                            <div class="text-center py-6">
                                                <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                                <p class="text-sm font-semibold text-green-600 dark:text-green-400">All Clear!</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="stuckActivitiesData.message"></p>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Capacity Forecast -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                    <i data-lucide="trending-up" class="mr-2 h-4 w-4 text-blue-600"></i>
                                    Capacity Forecast
                                </h4>
                                <div class="group relative">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <div class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        30-day load prediction using time series analysis. Helps with infrastructure and budget planning.
                                    </div>
                                </div>
                            </div>

                            <!-- Loading/fetch button -->
                            <template x-if="!capacityForecastData && !capacityForecastLoading">
                                <div class="text-center py-8">
                                    <button @click="loadCapacityForecast()"
                                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                        <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                                        Generate Forecast
                                    </button>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to forecast capacity needs</p>
                                </div>
                            </template>

                            <!-- Loading state -->
                            <template x-if="capacityForecastLoading">
                                <div class="flex flex-col items-center justify-center py-8">
                                    <div class="loader mb-2"></div>
                                    <p class="text-xs text-gray-500">Forecasting capacity...</p>
                                </div>
                            </template>

                            <!-- Results -->
                            <template x-if="capacityForecastData && !capacityForecastLoading">
                                <div>
                                    <!-- Summary stats -->
                                    <div class="grid grid-cols-2 gap-3 mb-4">
                                        <div class="p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Growth Rate</p>
                                            <p class="text-lg font-bold"
                                               :class="{
                                                   'text-green-600 dark:text-green-400': capacityForecastData.growth_rate_per_day < 5,
                                                   'text-yellow-600 dark:text-yellow-400': capacityForecastData.growth_rate_per_day >= 5 && capacityForecastData.growth_rate_per_day < 15,
                                                   'text-red-600 dark:text-red-400': capacityForecastData.growth_rate_per_day >= 15
                                               }"
                                               x-text="capacityForecastData.growth_rate_per_day + '/day'"></p>
                                        </div>
                                        <div class="p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Confidence</p>
                                            <p class="text-lg font-bold text-blue-600 dark:text-blue-400"
                                               x-text="Math.round(capacityForecastData.trend_confidence * 100) + '%'"></p>
                                        </div>
                                    </div>

                                    <!-- Peak patterns -->
                                    <template x-if="capacityForecastData.patterns">
                                        <div class="mb-3">
                                            <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Peak Hours:</p>
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="hour in capacityForecastData.patterns.peak_hours?.slice(0, 3)" :key="hour.hour">
                                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400">
                                                        <span x-text="hour.hour + ':00'"></span>
                                                        <span class="ml-1 text-blue-500" x-text="'(' + Math.round(hour.avg_instances) + ')'"></span>
                                                    </span>
                                                </template>
                                            </div>

                                            <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3">Busiest Days:</p>
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="day in capacityForecastData.patterns.busiest_days?.slice(0, 3)" :key="day.day">
                                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-400">
                                                        <span x-text="day.day"></span>
                                                        <span class="ml-1 text-purple-500" x-text="'(' + Math.round(day.avg_instances) + ')'"></span>
                                                    </span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- 7-day forecast preview -->
                                    <div class="mt-3">
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Next 7 Days:</p>
                                        <div class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar">
                                            <template x-for="day in capacityForecastData.forecast?.slice(0, 7)" :key="day.day">
                                                <div class="flex items-center justify-between text-xs py-1">
                                                    <span class="text-gray-600 dark:text-gray-400" x-text="day.date"></span>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="font-semibold text-gray-900 dark:text-gray-100"
                                                              x-text="day.predicted_instances + ' instances'"></span>
                                                        <span class="px-1 rounded text-xs"
                                                              :class="{
                                                                  'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': day.trend === 'increasing',
                                                                  'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': day.trend === 'decreasing',
                                                                  'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-400': day.trend === 'stable'
                                                              }"
                                                              x-text="day.trend"></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Duration Prediction Tool -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                <i data-lucide="timer" class="mr-2 h-4 w-4 text-green-600"></i>
                                Process Duration Analysis
                            </h4>
                            <div class="flex items-center space-x-2">
                                <span class="group relative">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        ML-powered prediction using Random Forest. Trained on historical patterns including time-of-day and day-of-week factors. Shows all processes sorted by longest predicted duration.
                                    </span>
                                </span>
                                <button @click="loadAllDurationPredictions()"
                                        :disabled="durationPredictionsLoading"
                                        class="inline-flex items-center px-3 py-1.5 border border-green-300 dark:border-green-600 text-xs font-medium rounded-md text-green-700 dark:text-green-300 bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-900/30 disabled:opacity-50">
                                    <i data-lucide="refresh-cw" class="h-3 w-3 mr-1" :class="{ 'animate-spin': durationPredictionsLoading }"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Auto-load on first view -->
                        <template x-if="!durationPredictions && !durationPredictionsLoading && !durationPredictionsLoaded">
                            <div class="text-center py-8">
                                <button @click="loadAllDurationPredictions()"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                    <i data-lucide="zap" class="h-4 w-4 mr-2"></i>
                                    Analyze All Processes
                                </button>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to predict durations for all process definitions</p>
                            </div>
                        </template>

                        <!-- Loading State -->
                        <template x-if="durationPredictionsLoading">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="loader mb-2"></div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Analyzing process patterns...</p>
                            </div>
                        </template>

                        <!-- Results Table -->
                        <template x-if="durationPredictions && !durationPredictionsLoading">
                            <div class="mt-3">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700/50">
                                            <tr>
                                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Process</th>
                                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Predicted</th>
                                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">P50</th>
                                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">P95</th>
                                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Confidence</th>
                                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Instances</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <template x-for="(pred, index) in durationPredictions.slice(0, 20)" :key="pred.process_key">
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"
                                                        :title="pred.process_key">
                                                        <span class="truncate max-w-xs inline-block" x-text="pred.process_key"></span>
                                                    </td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right">
                                                        <span class="font-bold text-green-600 dark:text-green-400"
                                                              x-text="pred.predicted_duration_ms != null ? formatDuration(pred.predicted_duration_ms) : 'N/A'"></span>
                                                    </td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right"
                                                        x-text="pred.percentiles?.p50_ms != null ? formatDuration(pred.percentiles.p50_ms) : '-'"></td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right"
                                                        x-text="pred.percentiles?.p95_ms != null ? formatDuration(pred.percentiles.p95_ms) : '-'"></td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-center">
                                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                              :class="{
                                                                  'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': pred.confidence_pct >= 80,
                                                                  'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400': pred.confidence_pct >= 60 && pred.confidence_pct < 80,
                                                                  'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': pred.confidence_pct < 60
                                                              }"
                                                              x-text="pred.confidence_pct ? pred.confidence_pct + '%' : 'N/A'"></span>
                                                    </td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-center"
                                                        x-text="pred.instance_count || 0"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                                <template x-if="durationPredictions.length > 20">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
                                        Showing top 20 of <span x-text="durationPredictions.length"></span> processes
                                    </p>
                                </template>
                                <template x-if="durationPredictions.length === 0">
                                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No process predictions available</p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

            </div>
        </template>

    </div>  <!-- End of AI Intelligence Layer -->
    </div>  <!-- End of AI / ML Analysis Tab Content -->

    <!-- Cluster Nodes & Database (on Dashboard Tab) -->
    <div x-show="activeTab === 'dashboard'">
    <!-- Cluster Nodes -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-300 dark:border-gray-600 overflow-hidden mb-6">
    <div class="px-4 py-2 bg-gradient-to-r from-cyan-50 to-white dark:from-cyan-900 dark:to-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
            <i data-lucide="cpu" class="mr-2 h-5 w-5 text-gray-600 dark:text-gray-300"></i>
            Cluster Node Details
        </h3>
        <div class="group relative">
            <i data-lucide="help-circle" class="h-4 w-4 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
            <div class="absolute top-full right-0 mt-2 tooltip-content right-0 mb-2 w-72 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                Real-time metrics for each individual node in the cluster, including JVM health and job execution statistics.
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4">
        <template x-for="node in data.cluster_nodes" :key="node.name">
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 transition-colors"
                 :class="{
                     'bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30': node.status === 'RUNNING',
                     'bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30': node.status === 'ERROR' || node.status === 'DOWN' || node.status === 'NO_ENGINES',
                     'bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/30': node.status !== 'RUNNING' && node.status !== 'ERROR' && node.status !== 'DOWN' && node.status !== 'NO_ENGINES'
                 }">

                <!-- Node Header -->
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <div class="h-3 w-3 rounded-full"
                             :class="{
                                 'bg-green-500 dark:bg-green-400': node.status === 'RUNNING',
                                 'bg-red-500 dark:bg-red-400': node.status === 'ERROR' || node.status === 'DOWN' || node.status === 'NO_ENGINES',
                                 'bg-yellow-500 dark:bg-yellow-400': node.status !== 'RUNNING' && node.status !== 'ERROR' && node.status !== 'DOWN' && node.status !== 'NO_ENGINES'
                             }"></div>
                        <span class="text-sm font-semibold text-gray-800 dark:text-gray-200 truncate"
                              :title="node.url"
                              x-text="node.name.toUpperCase()"></span>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full"
                          :class="{
                              'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': node.status === 'RUNNING',
                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': node.status === 'ERROR' || node.status === 'DOWN' || node.status === 'NO_ENGINES',
                              'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': node.status !== 'RUNNING' && node.status !== 'ERROR' && node.status !== 'DOWN' && node.status !== 'NO_ENGINES'
                          }"
                          x-text="node.status"></span>
                </div>

                <!-- Running Node Content -->
                <template x-if="node.status === 'RUNNING'">
                    <div>
                        <!-- JVM Metrics Section -->
                        <template x-if="node.jvm_metrics && node.jvm_metrics.status === 'HEALTHY'">
                            <div>
                                <!-- JVM Health & Memory in 2 columns -->
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/10 rounded border border-indigo-200 dark:border-indigo-800">
                                        <div class="text-xs font-medium text-indigo-800 dark:text-indigo-200 mb-1 flex items-center">
                                            <i data-lucide="cpu" class="h-3 w-3 mr-1"></i>JVM Health
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-indigo-600 dark:text-indigo-300">Heap:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      :class="{
                                                          'text-red-600 dark:text-red-400': node.jvm_metrics.memory.heap_utilization_pct > 80,
                                                          'text-yellow-600 dark:text-yellow-400': node.jvm_metrics.memory.heap_utilization_pct > 60 && node.jvm_metrics.memory.heap_utilization_pct <= 80
                                                      }"
                                                      x-text="node.jvm_metrics.memory.heap_utilization_pct.toFixed(1) + '%'"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-indigo-600 dark:text-indigo-300">CPU:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      :class="{
                                                          'text-red-600 dark:text-red-400': node.jvm_metrics.system.cpu_load_pct > 80,
                                                          'text-yellow-600 dark:text-yellow-400': node.jvm_metrics.system.cpu_load_pct > 60 && node.jvm_metrics.system.cpu_load_pct <= 80
                                                      }"
                                                      x-text="node.jvm_metrics.system.cpu_load_pct.toFixed(1) + '%'"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-indigo-600 dark:text-indigo-300">Threads:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.threads.current + '/' + node.jvm_metrics.threads.peak"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-2 bg-teal-50 dark:bg-teal-900/10 rounded border border-teal-200 dark:border-teal-800/70">
                                        <div class="text-xs font-medium text-teal-800 dark:text-teal-200 mb-1 flex items-center">
                                            <i data-lucide="hard-drive" class="h-3 w-3 mr-1"></i>Memory Usage
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-teal-600 dark:text-teal-400">Used:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.memory.heap_used_mb.toFixed(1) + 'MB'"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-teal-600 dark:text-teal-400">Max:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.memory.heap_max_mb.toFixed(1) + 'MB'"></span>
                                            </div>
                                            <div class="mt-1">
                                                <div class="h-1 bg-gray-200 dark:bg-gray-600 rounded-full">
                                                    <div class="h-1 rounded-full"
                                                         :class="{
                                                             'bg-red-500 dark:bg-red-400': node.jvm_metrics.memory.heap_utilization_pct > 80,
                                                             'bg-yellow-500 dark:bg-yellow-400': node.jvm_metrics.memory.heap_utilization_pct > 60 && node.jvm_metrics.memory.heap_utilization_pct <= 80,
                                                             'bg-green-500 dark:bg-green-400': node.jvm_metrics.memory.heap_utilization_pct <= 60
                                                         }"
                                                         :style="`width: ${Math.min(node.jvm_metrics.memory.heap_utilization_pct, 100)}%`"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- GC Stats & File Descriptors in 2 columns -->
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="p-2 bg-orange-50 dark:bg-orange-900/10 rounded border border-orange-200 dark:border-orange-800/50">
                                        <div class="text-xs font-medium text-orange-800 dark:text-orange-200 mb-1 flex items-center">
                                            <i data-lucide="trash-2" class="h-3 w-3 mr-1"></i>GC Stats
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-orange-600 dark:text-orange-400">Minor:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.gc.minor_collections.toFixed(0)"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-orange-600 dark:text-orange-400">Major:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.gc.major_collections.toFixed(0)"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-orange-600 dark:text-orange-400">GC Time:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="formatDuration(node.jvm_metrics.gc.total_gc_time_sec * 1000)"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-2 bg-pink-50 dark:bg-pink-900/10 rounded border border-pink-200 dark:border-pink-800/50">
                                        <div class="text-xs font-medium text-pink-800 dark:text-pink-200 mb-1 flex items-center">
                                            <i data-lucide="file-text" class="h-3 w-3 mr-1"></i>File Descriptors
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-pink-600 dark:text-pink-400">Open:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.file_descriptors.open"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-pink-600 dark:text-pink-400">Max:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.file_descriptors.max"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-pink-600 dark:text-pink-400">Usage:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      :class="{
                                                          'text-red-600 dark:text-red-400': node.jvm_metrics.file_descriptors.utilization_pct > 80,
                                                          'text-yellow-600 dark:text-yellow-400': node.jvm_metrics.file_descriptors.utilization_pct > 60 && node.jvm_metrics.file_descriptors.utilization_pct <= 80
                                                      }"
                                                      x-text="node.jvm_metrics.file_descriptors.utilization_pct.toFixed(1) + '%'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- JVM Error State -->
                        <template x-if="node.jvm_metrics && node.jvm_metrics.status !== 'HEALTHY'">
                            <div class="mb-3 p-2 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800">
                                <div class="text-xs font-medium text-red-800 dark:text-red-200 mb-1 flex items-center">
                                    <i data-lucide="alert-triangle" class="h-3 w-3 mr-1"></i>
                                    JVM Status: <span x-text="node.jvm_metrics.status"></span>
                                </div>
                                <template x-if="node.jvm_metrics.error">
                                    <div class="text-xs text-red-600 dark:text-red-400 break-all"
                                         x-text="node.jvm_metrics.error"></div>
                                </template>
                            </div>
                        </template>

                        <!-- Activity Rate & Job Execution in 2 columns -->
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="p-2 bg-sky-50 dark:bg-sky-900/10 rounded border border-sky-200 dark:border-sky-800/80">
                                <div class="text-xs font-medium text-sky-800 dark:text-sky-200 mb-1 flex items-center">
                                    <i data-lucide="zap" class="h-3 w-3 mr-1"></i>Activity Rate
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-sky-600 dark:text-sky-400">Response:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="formatDuration(node.response_time_ms)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sky-600 dark:text-sky-400">Success:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{'text-red-600 dark:text-red-400': node.job_success_rate < 95}"
                                              x-text="node.job_success_rate.toFixed(1) + '%'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sky-600 dark:text-sky-400">Workload:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="formatNumber(node.workload_score)"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-2 bg-purple-50 dark:bg-purple-900/10 rounded border border-purple-200 dark:border-purple-800/70">
                                <div class="text-xs font-medium text-purple-800 dark:text-purple-200 mb-1 flex items-center">
                                    <i data-lucide="cpu" class="h-3 w-3 mr-1"></i>Job Execution
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-purple-600 dark:text-purple-400">Success:</span>
                                        <span class="font-medium text-green-600 dark:text-green-400"
                                              x-text="formatNumber(node.jobs_successful)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-purple-600 dark:text-purple-400">Failed:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{'text-red-600 dark:text-red-400': node.jobs_failed > 0}"
                                              x-text="formatNumber(node.jobs_failed)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-purple-600 dark:text-purple-400">Rejected:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{'text-orange-600 dark:text-orange-400': node.job_execution_rejected > 0}"
                                              x-text="formatNumber(node.job_execution_rejected)"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Job Acquisition & Process Activity in 2 columns -->
                        <div class="grid grid-cols-2 gap-2 mb-1">
                            <div class="p-2 bg-cyan-50 dark:bg-cyan-900/10 rounded border border-cyan-200 dark:border-cyan-800/80">
                                <div class="text-xs font-medium text-cyan-800 dark:text-cyan-200 mb-1 flex items-center">
                                    <i data-lucide="download" class="h-3 w-3 mr-1"></i>Job Acquisition
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-cyan-600 dark:text-cyan-400">Attempts:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.job_acquisition_attempts"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-cyan-600 dark:text-cyan-400">Success:</span>
                                        <span class="font-medium text-green-600 dark:text-green-400"
                                              x-text="node.job_acquired_success"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-cyan-600 dark:text-cyan-400">Rate:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{
                                                  'text-red-600 dark:text-red-400': node.job_acquisition_success_rate < 90,
                                                  'text-yellow-600 dark:text-yellow-400': node.job_acquisition_success_rate >= 90 && node.job_acquisition_success_rate < 95
                                              }"
                                              x-text="node.job_acquisition_success_rate.toFixed(1) + '%'"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-2 bg-emerald-50 dark:bg-emerald-900/10 rounded border border-emerald-200 dark:border-emerald-800/80">
                                <div class="text-xs font-medium text-emerald-800 dark:text-emerald-200 mb-1 flex items-center">
                                    <i data-lucide="play" class="h-3 w-3 mr-1"></i>Process Activity
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-emerald-600 dark:text-emerald-400">Started:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.process_instances_started"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-emerald-600 dark:text-emerald-400">Flow Nodes:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.flow_node_instances"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-emerald-600 dark:text-emerald-400">Decisions:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.decision_instances"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Error State -->
                <template x-if="node.status !== 'RUNNING'">
                    <div class="text-xs text-red-700 dark:text-red-300 italic break-all"
                         x-text="node.error || 'Node not responding'"></div>
                </template>
            </div>
        </template>
    </div>
</div>

    <!-- Database Health & Performance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <!-- Database Storage -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-300 dark:border-gray-600"
             x-intersect.once="loadDatabaseMetrics()">
            <div class="px-4 py-3 bg-gradient-to-r from-gray-100 to-white dark:from-gray-800 dark:to-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
                    <i data-lucide="hard-drive" class="mr-2 h-5 w-5 text-gray-600 dark:text-gray-400"></i>
                    Database Storage
                </h3>
                <div class="flex items-center space-x-2">
                    <div class="group relative">
                        <i data-lucide="help-circle"
                           class="h-4 w-4 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute top-full right-0 mt-2 w-72 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Top 10 largest Camunda tables. Watch for excessive history growth in act_hi_* and act_ru_*
                            tables.
                        </div>
                    </div>
                    <button @click="loadDatabaseMetrics()"
                            class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i data-lucide="refresh-cw" class="h-4 w-4"
                           :class="{ 'animate-spin': databaseMetricsLoading }"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <template x-if="databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1">
                    <div class="space-y-3 max-h-96 pr-2">
                        <template x-for="i in 10" :key="i">
                            <div class="flex items-center justify-between animate-pulse">
                                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-32"></div>
                                <div class="flex items-center space-x-2">
                                    <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-16"></div>
                                    <div class="w-24 h-2 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Loaded Content -->
            <template x-if="databaseMetrics && !databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1">
                    <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2"
                         x-show="databaseMetrics.table_sizes && databaseMetrics.table_sizes.length">
                        <template x-for="(table, index) in databaseMetrics.table_sizes" :key="table.table_name">
                            <div class="flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors py-0">
                                <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300 font-mono"
                                      x-text="table.table_name"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500 dark:text-gray-400 w-20 text-right"
                                      x-text="formatBytes(table.size_bytes)"></span>
                                    <div class="w-24 h-2 bg-gray-200 dark:bg-gray-600 rounded-full">
                                        <div class="h-2 bg-sky-500 dark:bg-sky-400 rounded-full"
                                             :style="`width: ${(table.size_bytes / (databaseMetrics.table_sizes[0]?.size_bytes || 1) * 100)}%`"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="!databaseMetrics.table_sizes || !databaseMetrics.table_sizes.length"
                         class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                        No table data available.
                    </div>
                    <template x-if="databaseMetrics.archivable_instances > 0">
                        <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="archive" class="h-4 w-4 text-yellow-600 dark:text-yellow-400 mr-2"></i>
                                <span class="text-sm text-yellow-800 dark:text-yellow-200">
                                <strong x-text="formatNumber(databaseMetrics.archivable_instances)"></strong>
                                instances ready for archiving (><span x-text="config.archiveDaysThreshold"></span> days old)
                            </span>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="databaseMetricsError && !databaseMetricsLoading">
                <div class="p-4">
                    <div class="text-center py-4 text-red-600 dark:text-red-400">
                        <i data-lucide="alert-circle" class="h-6 w-6 mx-auto mb-2"></i>
                        <p class="text-sm">Failed to load storage data</p>
                        <button @click="loadDatabaseMetrics()" class="mt-1 text-xs underline">Try Again</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Slow Queries -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-300 dark:border-gray-600"
             x-intersect.once="loadDatabaseMetrics()">
            <div class="px-4 py-3 bg-gradient-to-r from-yellow-100 to-white dark:from-yellow-900/20 dark:to-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
                    <i data-lucide="snail" class="mr-2 h-5 w-5 text-gray-600 dark:text-gray-400"></i>
                    Slow DB Queries
                </h3>
                <div class="flex items-center space-x-2">
                    <div class="group relative">
                        <i data-lucide="help-circle"
                           class="h-4 w-4 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute top-full right-0 mt-2 w-72 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Most expensive database queries. Requires the 'pg_stat_statements' PostgreSQL extension to
                            be enabled.
                        </div>
                    </div>
                    <button @click="loadDatabaseMetrics()"
                            class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i data-lucide="refresh-cw" class="h-4 w-4"
                           :class="{ 'animate-spin': databaseMetricsLoading }"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <template x-if="databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1 max-h-96">
                    <div class="space-y-2">
                        <template x-for="i in 5" :key="i">
                            <div class="p-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-700 rounded-lg text-xs font-mono animate-pulse">
                                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded mb-1"></div>
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Loaded Content -->
            <template x-if="databaseMetrics && !databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1 max-h-96 overflow-y-auto custom-scrollbar">
                    <div class="space-y-2" x-show="databaseMetrics.slow_queries && databaseMetrics.slow_queries.length">
                        <template x-for="(query, index) in databaseMetrics.slow_queries" :key="query.full_query + '-' + query.calls + '-' + index">
                            <div class="p-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors rounded-lg text-xs font-mono">
                                <p class="text-gray-800 dark:text-gray-200 truncate"
                                   :title="query.full_query"
                                   x-text="query.query_preview + '...'"></p>
                                <p class="text-gray-600 dark:text-gray-400 mt-1">
                                    <span>Avg: </span><span x-text="formatDuration(query.avg_ms)"></span>
                                    <span>, Max: </span><span x-text="formatDuration(query.max_ms)"></span>
                                    <span>, Calls: </span><span x-text="query.calls"></span>
                                </p>
                            </div>
                        </template>
                    </div>
                    <div x-show="!databaseMetrics.slow_queries || !databaseMetrics.slow_queries.length"
                         class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm">
                        <i data-lucide="database-zap" class="h-8 w-8 mx-auto mb-2 text-gray-400 dark:text-gray-500"></i>
                        <p>No slow query data available.</p>
                        <p class="text-xs mt-1">Requires pg_stat_statements extension</p>
                    </div>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="databaseMetricsError && !databaseMetricsLoading">
                <div class="p-4">
                    <div class="text-center py-4 text-red-600 dark:text-red-400">
                        <i data-lucide="alert-circle" class="h-6 w-6 mx-auto mb-2"></i>
                        <p class="text-sm">Failed to load query data</p>
                        <button @click="loadDatabaseMetrics()" class="mt-1 text-xs underline">Try Again</button>
                    </div>
                </div>
            </template>
        </div>
    </div>
    </div>  <!-- End of Dashboard Tab (Cluster Nodes & Database) -->

</main>

<!-- Footer -->
<footer class="mt-auto bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
            <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
                <i data-lucide="copyright" class="h-4 w-4"></i>
                <span>2025 <a href="https://champa-bpmn.com" target="_blank" rel="noopener noreferrer"
                    class="text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300 font-medium">Champa Intelligence</a></span>
                <span>â€¢</span>
                <span>Open Source</span>
            </div>

            <div class="flex items-center space-x-6 text-sm">
                <a href="https://github.com/bibacrm/camunda-health-monitor"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center space-x-1 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100">
                    <i data-lucide="github" class="h-4 w-4"></i>
                    <span>GitHub</span>
                </a>

                <a href="https://youtu.be/WFQRxpmjRrE"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center space-x-1 text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                    <i data-lucide="video" class="h-4 w-4"></i>
                    <span>Video Demo</span>
                </a>

                <a href="https://champa-bpmn.com"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center space-x-1 text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300">
                    <i data-lucide="globe" class="h-4 w-4"></i>
                    <span>Enterprise</span>
                </a>
            </div>
        </div>

    </div>
</footer>

<script>
    function healthMonitor() {
        return {
            data: {{ data|tojson|safe }},
            darkMode: false,
            autoRefresh: false,
            isLoading: false,
            refreshInterval: null,
            mobileMenuOpen: false,

            // Tab navigation
            activeTab: 'dashboard',  // 'dashboard' or 'ai'

            // Lazy loading states
            metricLoading: {},
            metricData: {},
            metricErrors: {},
            databaseMetricsLoading: false,
            databaseMetrics: null,
            databaseMetricsError: null,

            // AI/ML states
            aiLoading: false,
            aiData: null,
            aiError: null,
            aiExpanded: false,

            // NEW: Advanced ML features states
            stuckActivitiesData: null,
            stuckActivitiesLoading: false,
            capacityForecastData: null,
            capacityForecastLoading: false,
            durationPredictionKey: '',
            durationPredictionData: null,
            durationPredictionLoading: false,
            durationPredictions: null,
            durationPredictionsLoading: false,
            durationPredictionsLoaded: false,

            // UI Configuration - loaded from backend config (single source of truth)
            config: {{ ui_config|tojson|safe }},

            // Legacy property for backward compatibility
            get aiDisplayLimits() {
                return this.config.aiDisplayLimits;
            },

            init() {
                // Set dark mode from localStorage on init
                this.darkMode = localStorage.getItem('darkMode') === 'true';
                this.applyDarkMode();
                this.$nextTick(() => lucide.createIcons());
            },

            toggleDarkMode() {
                this.darkMode = !this.darkMode;
                localStorage.setItem('darkMode', this.darkMode);
                this.applyDarkMode();
            },

            applyDarkMode() {
                if (this.darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            toggleAutoRefresh() {
                this.autoRefresh = !this.autoRefresh;
                if (this.autoRefresh) {
                    this.refreshInterval = setInterval(() => this.refreshData(), this.config.autoRefreshInterval);
                } else {
                    clearInterval(this.refreshInterval);
                }
            },

            async refreshData() {
                if (this.isLoading) return;

                this.isLoading = true;
                try {
                    const response = await fetch('/api/health');
                    if (response.ok) {
                        this.data = await response.json();
                        this.$nextTick(() => lucide.createIcons());
                    }
                } catch (error) {
                    console.error('Refresh failed:', error);
                } finally {
                    this.isLoading = false;
                }
            },

            // Lazy loading for individual metrics
            async loadMetric(metricName) {
                if (this.metricLoading[metricName]) return;

                this.metricLoading[metricName] = true;
                this.metricErrors[metricName] = null;

                try {
                    const response = await fetch(`/api/metrics/${metricName}`);
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.metricData[metricName] = data;
                } catch (error) {
                    console.error(`Error loading metric '${metricName}':`, error);
                    this.metricErrors[metricName] = error.message;
                } finally {
                    this.metricLoading[metricName] = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async refreshMetric(metricName) {
                await this.loadMetric(metricName);
            },

            // Database metrics loading
            async loadDatabaseMetrics() {
                if (this.databaseMetricsLoading) return;

                this.databaseMetricsLoading = true;
                this.databaseMetricsError = null;

                try {
                    const response = await fetch('/api/metrics/database');
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.databaseMetrics = data;
                } catch (error) {
                    console.error('Error loading database metrics:', error);
                    this.databaseMetricsError = error.message;
                } finally {
                    this.databaseMetricsLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            // AI Insights loading
            async loadAIInsights() {
                if (this.aiLoading || this.aiData) return;

                this.aiLoading = true;
                this.aiError = null;

                try {
                    const response = await fetch('/api/ai/insights');
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.aiData = data;
                } catch (error) {
                    console.error('Error loading AI insights:', error);
                    this.aiError = error.message;
                } finally {
                    this.aiLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async refreshAIInsights() {
                this.aiData = null;
                await this.loadAIInsights();
            },

            // NEW: Advanced ML Features
            loadAdvancedMLFeatures() {
                // Lazy load both advanced features when section becomes visible
                if (!this.stuckActivitiesData && !this.stuckActivitiesLoading) {
                    this.loadStuckActivities();
                }
                if (!this.capacityForecastData && !this.capacityForecastLoading) {
                    this.loadCapacityForecast();
                }
            },

            async loadStuckActivities() {
                if (this.stuckActivitiesLoading) return;

                this.stuckActivitiesLoading = true;
                try {
                    const response = await fetch('/api/ai/stuck-activities-smart');
                    if (response.ok) {
                        this.stuckActivitiesData = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading stuck activities:', error);
                } finally {
                    this.stuckActivitiesLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async loadCapacityForecast() {
                if (this.capacityForecastLoading) return;

                this.capacityForecastLoading = true;
                try {
                    const response = await fetch('/api/ai/capacity-forecast');
                    if (response.ok) {
                        this.capacityForecastData = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading capacity forecast:', error);
                } finally {
                    this.capacityForecastLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async loadDurationPrediction() {
                if (!this.durationPredictionKey || this.durationPredictionLoading) return;

                this.durationPredictionLoading = true;
                try {
                    const response = await fetch(`/api/ai/predict-duration/${encodeURIComponent(this.durationPredictionKey)}`);
                    if (response.ok) {
                        this.durationPredictionData = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading duration prediction:', error);
                } finally {
                    this.durationPredictionLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async loadAllDurationPredictions() {
                if (this.durationPredictionsLoading) return;

                this.durationPredictionsLoading = true;
                this.durationPredictionsLoaded = true;
                try {
                    const response = await fetch('/api/ai/predict-all-durations');
                    if (response.ok) {
                        const data = await response.json();
                        // Sort by predicted duration (longest first), treating null as 0
                        this.durationPredictions = (data.predictions || []).sort((a, b) => {
                            const aDuration = a.predicted_duration_ms != null ? a.predicted_duration_ms : 0;
                            const bDuration = b.predicted_duration_ms != null ? b.predicted_duration_ms : 0;
                            return bDuration - aDuration;
                        });
                    }
                } catch (error) {
                    console.error('Error loading all duration predictions:', error);
                } finally {
                    this.durationPredictionsLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            // Helper: sum metric across all nodes
            sumNodeMetric(metricName) {
                return this.data.cluster_nodes.reduce((sum, node) => {
                    return sum + (Number(node[metricName]) || 0);
                }, 0);
            },

            // Formatting functions
            formatNumber(value) {
                if (value === null || value === undefined) return "0";
                value = Number(value);
                if (value < 1000) return Math.round(value).toString();
                if (value < 1e6) return (value / 1e3).toFixed(1) + 'K';
                return (value / 1e6).toFixed(1) + 'M';
            },

            formatDuration(ms) {
                if (ms === null || ms === undefined) return "N/A";
                ms = Number(ms);
                if (ms < 1000) return `${ms.toFixed(0)}ms`;
                if (ms < 60000) return `${(ms / 1000).toFixed(2)}s`;
                if (ms < 3600000) return `${(ms / 60000).toFixed(2)}min`;
                return `${(ms / 3600000).toFixed(2)}h`;
            },

            formatBytes(value) {
                if (!value) return "0 B";
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let i = 0;
                while (value >= 1024 && i < 4) {
                    value /= 1024;
                    i++;
                }
                return `${value.toFixed(1)} ${units[i]}`;
            },

            formatTime(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleTimeString();
            }
        };
    }

    // Apply dark mode immediately
    (function () {
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
            document.documentElement.classList.add('dark');
        }
    })();
</script>
</body>
</html>