<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camunda Health Monitor</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <!-- Alpine.js with Intersect plugin -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 5px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Custom scrollbar for specific sections */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        /* Loading animation */
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #374151;
            border-top-color: #0ea5e9;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Status pulse animation */
        @keyframes statusPulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }

        .bg-green-500, .bg-yellow-500, .bg-red-500 {
            animation: statusPulse 2s ease-in-out infinite alternate;
        }

        /* Dark mode transitions */
        * {
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }

        /* Mobile menu */
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900" x-data="healthMonitor()">
<!-- Header -->
<header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
    <div class="mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center space-x-3">
                <i data-lucide="activity" class="h-8 w-8 text-sky-600 dark:text-sky-400"></i>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">
                        Champa Health Monitor
                    </h1>
                    <p class="hidden md:block text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Real-time Camunda cluster monitoring
                    </p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Desktop Controls -->
                <div class="hidden md:flex items-center space-x-4">
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Dark mode</span>
                        <button @click="toggleDarkMode()"
                                :class="darkMode ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full">
                            <span :class="darkMode ? 'translate-x-6' : 'translate-x-1'"
                                  class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                        </button>
                    </div>

                    <!-- Auto-refresh Toggle -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Auto-refresh</span>
                        <button @click="toggleAutoRefresh()"
                                :class="autoRefresh ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full">
                            <span :class="autoRefresh ? 'translate-x-6' : 'translate-x-1'"
                                  class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                        </button>
                    </div>

                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Last updated: <span class="font-medium text-gray-700 dark:text-gray-300"
                                            x-text="formatTime(data.timestamp)"></span>
                    </div>
                </div>

                <!-- Refresh Button (visible on all sizes) -->
                <button @click="refreshData()"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i data-lucide="refresh-cw" class="h-4 w-4" :class="{ 'animate-spin': isLoading }"></i>
                    <span class="hidden sm:block ml-2">Refresh</span>
                </button>

                <!-- Mobile Menu Button -->
                <button @click="mobileMenuOpen = true"
                        class="md:hidden p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800">
                    <i data-lucide="menu" class="h-6 w-6"></i>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Mobile Off-Canvas Menu -->
<div x-show="mobileMenuOpen" x-cloak class="relative z-50 md:hidden" @keydown.escape.window="mobileMenuOpen = false">
    <!-- Backdrop -->
    <div x-show="mobileMenuOpen"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-75"></div>

    <!-- Panel -->
    <div class="fixed inset-0 flex justify-end">
        <div x-show="mobileMenuOpen"
             @click.away="mobileMenuOpen = false"
             x-transition:enter="transition ease-in-out duration-300 transform"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in-out duration-300 transform"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="relative flex w-full max-w-xs flex-col overflow-y-auto bg-white dark:bg-gray-800 pb-12 shadow-xl">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 pt-5 pb-2 border-b dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Menu</h3>
                <button type="button" class="-m-2 inline-flex items-center justify-center rounded-md p-2 text-gray-400"
                        @click="mobileMenuOpen = false">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <!-- Dashboard Controls -->
            <div class="space-y-6 border-b border-gray-200 dark:border-gray-700 px-4 py-6">
                <h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Dashboard Controls</h4>

                <div class="flex items-center justify-between">
                    <span class="text-base text-gray-900 dark:text-gray-100">Dark Mode</span>
                    <button @click="toggleDarkMode()" :class="darkMode ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                            class="relative inline-flex h-6 w-11 items-center rounded-full">
                        <span :class="darkMode ? 'translate-x-6' : 'translate-x-1'"
                              class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-base text-gray-900 dark:text-gray-100">Auto-refresh</span>
                    <button @click="toggleAutoRefresh()"
                            :class="autoRefresh ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'"
                            class="relative inline-flex h-6 w-11 items-center rounded-full">
                        <span :class="autoRefresh ? 'translate-x-6' : 'translate-x-1'"
                              class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                    </button>
                </div>

                <div class="flex items-center justify-between text-base text-gray-900 dark:text-gray-100">
                    <span>Last updated:</span>
                    <span class="font-medium" x-text="formatTime(data.timestamp)"></span>
                </div>

                <button @click="refreshData(); mobileMenuOpen = false;"
                        class="w-full inline-flex items-center justify-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i data-lucide="refresh-cw" class="h-4 w-4 mr-2" :class="{ 'animate-spin': isLoading }"></i>
                    Refresh Now
                </button>
            </div>
        </div>
    </div>
</div>

<main class="mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Issues Alert -->
    <div x-show="data.cluster_status.issues.length > 0"
         class="mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4">
        <div class="flex items-start">
            <i data-lucide="alert-octagon" class="h-6 w-6 text-red-600 dark:text-red-400 mt-0.5"></i>
            <div class="ml-3">
                <h3 class="text-lg font-semibold text-red-900 dark:text-red-200">System Issues Detected</h3>
                <div class="mt-2 space-y-1">
                    <template x-for="issue in data.cluster_status.issues" :key="issue">
                        <p class="text-sm text-red-700 dark:text-red-300" x-text="'â€¢ ' + issue"></p>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6">
        <!-- Engine Status -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-sky-500 to-sky-600 dark:from-sky-700/70 dark:to-sky-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="server" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">ENGINE STATUS</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        Overall health of the Camunda Engine cluster. Shows how many nodes are currently running out of
                        the total configured.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold"
                      :class="data.cluster_status.running_nodes === data.cluster_status.total_nodes
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-yellow-600 dark:text-yellow-400'"
                      x-text="data.cluster_status.running_nodes + '/' + data.cluster_status.total_nodes"></span>
                    <span class="text-xs px-2 py-1 rounded-full"
                          :class="data.cluster_status.running_nodes === data.cluster_status.total_nodes
                          ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                          : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'"
                          x-text="data.cluster_status.running_nodes === data.cluster_status.total_nodes ? 'ALL UP' : 'PARTIAL'"></span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                    Version: <span class="text-gray-700 dark:text-gray-300"
                                   x-text="data.cluster_status.engine_version"></span>
                </p>
            </div>
        </div>

        <!-- Database -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-green-500 to-green-600 dark:from-green-700/70 dark:to-green-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="database" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">DATABASE</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        Monitors the health of the connection to the backend database. Shows query latency and
                        connection pool utilization.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold"
                      :class="data.db_metrics.connectivity === 'OK'
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-red-600 dark:text-red-400'"
                      x-text="data.db_metrics.connectivity === 'OK' ? formatDuration(data.db_metrics.latency_ms) : 'ERROR'"></span>
                    <span class="text-xs px-2 py-1 rounded-full"
                          :class="data.db_metrics.connectivity === 'OK'
                          ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                          : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'"
                          x-text="data.db_metrics.connectivity"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 dark:text-gray-400">Connections:</span>
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                          x-text="data.db_metrics.active_connections + '/' + data.db_metrics.max_connections"></span>
                </div>
                <div class="mt-1">
                    <div class="h-1 bg-gray-200 dark:bg-gray-600 rounded-full">
                        <div class="h-1 bg-green-500 dark:bg-green-400 rounded-full"
                             :style="`width: ${data.db_metrics.connection_utilization}%`"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Executor -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"
             x-intersect.once="loadMetric('job-throughput')">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-700/70 dark:to-purple-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="cpu" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center space-x-2">
                    <div class="group relative flex items-center">
                        <span class="text-xs text-white font-medium opacity-90 mr-2">JOB EXECUTOR</span>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                        <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                            Health of the asynchronous job executor. Shows total pending jobs and execution throughput.
                        </div>
                    </div>
                    <button @click="refreshMetric('job-throughput')"
                            class="text-white opacity-70 hover:opacity-100 transition-opacity">
                        <i data-lucide="refresh-cw" class="h-4 w-4"
                           :class="{ 'animate-spin': metricLoading['job-throughput'] }"></i>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold text-gray-800 dark:text-gray-200"
                      x-text="formatNumber(data.totals.total_jobs)"></span>

                    <!-- Loading State -->
                    <template x-if="metricLoading['job-throughput']">
                        <div class="h-6 w-16 bg-gray-200 dark:bg-gray-600 rounded-full animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['job-throughput'] && !metricLoading['job-throughput']">
                    <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400"
                          x-text="(metricData['job-throughput']?.jobs_executed_per_min || 0).toFixed(1) + '/min'"></span>
                    </template>

                    <!-- Initial/Fallback Content -->
                    <template x-if="!metricLoading['job-throughput'] && !metricData['job-throughput']">
                    <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400">
                        --/min
                    </span>
                    </template>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">No Retries:</span>
                        <span class="text-xs font-medium"
                              :class="data.totals.failed_jobs > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-300'"
                              x-text="data.totals.failed_jobs"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Executable:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="formatNumber(data.totals.active_jobs)"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- External Tasks -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 dark:from-cyan-700/70 dark:to-cyan-800/70 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="plug-zap" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">EXTERNAL TASKS</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        State of the external task queue waiting for workers to fetch them.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold text-gray-800 dark:text-gray-200"
                      x-text="formatNumber(data.totals.external_tasks)"></span>
                    <span class="text-xs px-2 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400">QUEUED</span>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Processing:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="sumNodeMetric('external_tasks_locked')"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Failed:</span>
                        <span class="text-xs font-medium"
                              :class="sumNodeMetric('external_tasks_no_retries') > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-300'"
                              x-text="sumNodeMetric('external_tasks_no_retries')"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Definitions -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 dark:from-indigo-700/80 dark:to-indigo-800/80 px-4 py-3 flex items-center justify-between rounded-t-lg">
                <i data-lucide="package" class="h-5 w-5 text-white opacity-80"></i>
                <div class="flex items-center group relative">
                    <span class="text-xs text-white font-medium opacity-90 mr-2">DEFINITIONS</span>
                    <i data-lucide="help-circle"
                       class="h-4 w-4 text-white opacity-70 hover:opacity-100 cursor-pointer"></i>
                    <div class="absolute top-full right-0 mt-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
                        Total count of all deployed artifacts including process and decision models.
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                <span class="text-2xl font-bold text-gray-800 dark:text-gray-200"
                      x-text="formatNumber(data.totals.deployment_count)"></span>
                    <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400">DEPLOYMENTS</span>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Process Defs:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="data.totals.process_definitions"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 dark:text-gray-400">DMN Defs:</span>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"
                              x-text="data.totals.dmn_definitions"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Process Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
        <!-- Active Instances -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-sky-500 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center group relative">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Active Instances</p>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Total number of process instances currently running.
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                       x-text="formatNumber(data.totals.active_instances)"></p>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-sky-100 dark:bg-sky-900/30">
                    <i data-lucide="play-circle" class="h-6 w-6 text-sky-600 dark:text-sky-400"></i>
                </div>
            </div>
        </div>

        <!-- User Tasks -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-green-500 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center group relative">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300">User Tasks</p>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Human tasks waiting for user action.
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                       x-text="formatNumber(data.totals.user_tasks)"></p>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-green-100 dark:bg-green-900/30">
                    <i data-lucide="users" class="h-6 w-6 text-green-600 dark:text-green-400"></i>
                </div>
            </div>
        </div>

        <!-- Open Incidents -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 p-4"
             :class="data.totals.incidents > 0 ? 'border-l-red-500' : 'border-l-gray-300 dark:border-l-gray-600'">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center group relative">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Open Incidents</p>
                        <i data-lucide="help-circle"
                           class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Critical errors that have stopped process instances.
                        </div>
                    </div>
                    <p class="text-3xl font-bold mt-2"
                       :class="data.totals.incidents > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-200'"
                       x-text="formatNumber(data.totals.incidents)"></p>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg"
                     :class="data.totals.incidents > 0 ? 'bg-red-100 dark:bg-red-900/30' : 'bg-green-100 dark:bg-green-900/30'">
                    <i data-lucide="alert-triangle" class="h-6 w-6"
                       :class="data.totals.incidents > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"></i>
                </div>
            </div>
        </div>

        <!-- Stuck Instances -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-yellow-500 p-4"
             x-intersect.once="loadMetric('stuck-instances')">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center group relative justify-between">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Stuck Instances</p>
                            <i data-lucide="help-circle"
                               class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                            <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                                Active instances with no activity for over {{ stuck_days }} days.
                            </div>
                            <button @click="refreshMetric('stuck-instances')"
                                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors ml-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4"
                                   :class="{ 'animate-spin': metricLoading['stuck-instances'] }"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <template x-if="metricLoading['stuck-instances']">
                        <div class="mr-4 mt-2 h-10 bg-gray-200 dark:bg-gray-600 rounded animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['stuck-instances'] && !metricLoading['stuck-instances']">
                        <p class="text-3xl font-bold mt-2"
                           :class="(metricData['stuck-instances']?.value || 0) > 0 ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-900 dark:text-gray-200'"
                           x-text="formatNumber(metricData['stuck-instances']?.value || 0)"></p>
                    </template>

                    <!-- Error State -->
                    <template x-if="metricErrors['stuck-instances'] && !metricLoading['stuck-instances']">
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                            <span>Error</span>
                            <button @click="refreshMetric('stuck-instances')" class="ml-1 underline">Retry</button>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-yellow-100 dark:bg-yellow-900/30">
                    <i data-lucide="pause-circle" class="h-6 w-6 text-yellow-600 dark:text-yellow-400"></i>
                </div>
            </div>
        </div>

        <!-- Pending Messages -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-cyan-500 p-4"
             x-intersect.once="loadMetric('pending-messages')">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center group relative justify-between">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Pending Messages</p>
                            <i data-lucide="help-circle"
                               class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                            <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                                Instances waiting for message correlation.
                            </div>
                            <button @click="refreshMetric('pending-messages')"
                                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors ml-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4"
                                   :class="{ 'animate-spin': metricLoading['pending-messages'] }"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <template x-if="metricLoading['pending-messages']">
                        <div class="mr-4 mt-2 h-10 bg-gray-200 dark:bg-gray-600 rounded animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['pending-messages'] && !metricLoading['pending-messages']">
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                           x-text="formatNumber(metricData['pending-messages']?.value || 0)"></p>
                    </template>

                    <!-- Error State -->
                    <template x-if="metricErrors['pending-messages'] && !metricLoading['pending-messages']">
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                            <span>Error</span>
                            <button @click="refreshMetric('pending-messages')" class="ml-1 underline">Retry</button>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-cyan-100 dark:bg-cyan-900/30">
                    <i data-lucide="message-square" class="h-6 w-6 text-cyan-600 dark:text-cyan-400"></i>
                </div>
            </div>
        </div>

        <!-- Pending Signals -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 border-l-teal-500 p-4"
             x-intersect.once="loadMetric('pending-signals')">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center group relative justify-between">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Pending Signals</p>
                            <i data-lucide="help-circle"
                               class="h-4 w-4 ml-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                            <div class="absolute bottom-full mb-2 w-64 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                                Instances waiting for broadcast signal events.
                            </div>
                            <button @click="refreshMetric('pending-signals')"
                                    class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors ml-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4"
                                   :class="{ 'animate-spin': metricLoading['pending-signals'] }"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <template x-if="metricLoading['pending-signals']">
                        <div class="mr-4 mt-2 h-10 bg-gray-200 dark:bg-gray-600 rounded animate-pulse"></div>
                    </template>

                    <!-- Loaded Content -->
                    <template x-if="metricData['pending-signals'] && !metricLoading['pending-signals']">
                        <p class="text-3xl font-bold text-gray-900 dark:text-gray-200 mt-2"
                           x-text="formatNumber(metricData['pending-signals']?.value || 0)"></p>
                    </template>

                    <!-- Error State -->
                    <template x-if="metricErrors['pending-signals'] && !metricLoading['pending-signals']">
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                            <span>Error</span>
                            <button @click="refreshMetric('pending-signals')" class="ml-1 underline">Retry</button>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-lg bg-teal-100 dark:bg-teal-900/30">
                    <i data-lucide="radio-tower" class="h-6 w-6 text-teal-600 dark:text-teal-400"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Cluster Nodes -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-300 dark:border-gray-600 overflow-hidden mb-6">
    <div class="px-4 py-2 bg-gradient-to-r from-cyan-50 to-white dark:from-cyan-900 dark:to-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
            <i data-lucide="cpu" class="mr-2 h-5 w-5 text-gray-600 dark:text-gray-300"></i>
            Cluster Node Details
        </h3>
        <div class="group relative">
            <i data-lucide="help-circle" class="h-4 w-4 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
            <div class="absolute top-full right-0 mt-2 tooltip-content right-0 mb-2 w-72 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                Real-time metrics for each individual node in the cluster, including JVM health and job execution statistics.
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4">
        <template x-for="node in data.cluster_nodes" :key="node.name">
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 transition-colors"
                 :class="{
                     'bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30': node.status === 'RUNNING',
                     'bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30': node.status === 'ERROR' || node.status === 'DOWN' || node.status === 'NO_ENGINES',
                     'bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/30': node.status !== 'RUNNING' && node.status !== 'ERROR' && node.status !== 'DOWN' && node.status !== 'NO_ENGINES'
                 }">

                <!-- Node Header -->
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <div class="h-3 w-3 rounded-full"
                             :class="{
                                 'bg-green-500 dark:bg-green-400': node.status === 'RUNNING',
                                 'bg-red-500 dark:bg-red-400': node.status === 'ERROR' || node.status === 'DOWN' || node.status === 'NO_ENGINES',
                                 'bg-yellow-500 dark:bg-yellow-400': node.status !== 'RUNNING' && node.status !== 'ERROR' && node.status !== 'DOWN' && node.status !== 'NO_ENGINES'
                             }"></div>
                        <span class="text-sm font-semibold text-gray-800 dark:text-gray-200 truncate"
                              :title="node.url"
                              x-text="node.name.toUpperCase()"></span>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full"
                          :class="{
                              'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': node.status === 'RUNNING',
                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': node.status === 'ERROR' || node.status === 'DOWN' || node.status === 'NO_ENGINES',
                              'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': node.status !== 'RUNNING' && node.status !== 'ERROR' && node.status !== 'DOWN' && node.status !== 'NO_ENGINES'
                          }"
                          x-text="node.status"></span>
                </div>

                <!-- Running Node Content -->
                <template x-if="node.status === 'RUNNING'">
                    <div>
                        <!-- JVM Metrics Section -->
                        <template x-if="node.jvm_metrics && node.jvm_metrics.status === 'HEALTHY'">
                            <div>
                                <!-- JVM Health & Memory in 2 columns -->
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/10 rounded border border-indigo-200 dark:border-indigo-800">
                                        <div class="text-xs font-medium text-indigo-800 dark:text-indigo-200 mb-1 flex items-center">
                                            <i data-lucide="cpu" class="h-3 w-3 mr-1"></i>JVM Health
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-indigo-600 dark:text-indigo-300">Heap:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      :class="{
                                                          'text-red-600 dark:text-red-400': node.jvm_metrics.memory.heap_utilization_pct > 80,
                                                          'text-yellow-600 dark:text-yellow-400': node.jvm_metrics.memory.heap_utilization_pct > 60 && node.jvm_metrics.memory.heap_utilization_pct <= 80
                                                      }"
                                                      x-text="node.jvm_metrics.memory.heap_utilization_pct.toFixed(1) + '%'"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-indigo-600 dark:text-indigo-300">CPU:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      :class="{
                                                          'text-red-600 dark:text-red-400': node.jvm_metrics.system.cpu_load_pct > 80,
                                                          'text-yellow-600 dark:text-yellow-400': node.jvm_metrics.system.cpu_load_pct > 60 && node.jvm_metrics.system.cpu_load_pct <= 80
                                                      }"
                                                      x-text="node.jvm_metrics.system.cpu_load_pct.toFixed(1) + '%'"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-indigo-600 dark:text-indigo-300">Threads:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.threads.current + '/' + node.jvm_metrics.threads.peak"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-2 bg-teal-50 dark:bg-teal-900/10 rounded border border-teal-200 dark:border-teal-800/70">
                                        <div class="text-xs font-medium text-teal-800 dark:text-teal-200 mb-1 flex items-center">
                                            <i data-lucide="hard-drive" class="h-3 w-3 mr-1"></i>Memory Usage
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-teal-600 dark:text-teal-400">Used:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.memory.heap_used_mb.toFixed(1) + 'MB'"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-teal-600 dark:text-teal-400">Max:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.memory.heap_max_mb.toFixed(1) + 'MB'"></span>
                                            </div>
                                            <div class="mt-1">
                                                <div class="h-1 bg-gray-200 dark:bg-gray-600 rounded-full">
                                                    <div class="h-1 rounded-full"
                                                         :class="{
                                                             'bg-red-500 dark:bg-red-400': node.jvm_metrics.memory.heap_utilization_pct > 80,
                                                             'bg-yellow-500 dark:bg-yellow-400': node.jvm_metrics.memory.heap_utilization_pct > 60 && node.jvm_metrics.memory.heap_utilization_pct <= 80,
                                                             'bg-green-500 dark:bg-green-400': node.jvm_metrics.memory.heap_utilization_pct <= 60
                                                         }"
                                                         :style="`width: ${Math.min(node.jvm_metrics.memory.heap_utilization_pct, 100)}%`"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- GC Stats & File Descriptors in 2 columns -->
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="p-2 bg-orange-50 dark:bg-orange-900/10 rounded border border-orange-200 dark:border-orange-800/50">
                                        <div class="text-xs font-medium text-orange-800 dark:text-orange-200 mb-1 flex items-center">
                                            <i data-lucide="trash-2" class="h-3 w-3 mr-1"></i>GC Stats
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-orange-600 dark:text-orange-400">Minor:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.gc.minor_collections.toFixed(0)"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-orange-600 dark:text-orange-400">Major:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.gc.major_collections.toFixed(0)"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-orange-600 dark:text-orange-400">GC Time:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="formatDuration(node.jvm_metrics.gc.total_gc_time_sec * 1000)"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-2 bg-pink-50 dark:bg-pink-900/10 rounded border border-pink-200 dark:border-pink-800/50">
                                        <div class="text-xs font-medium text-pink-800 dark:text-pink-200 mb-1 flex items-center">
                                            <i data-lucide="file-text" class="h-3 w-3 mr-1"></i>File Descriptors
                                        </div>
                                        <div class="space-y-1 text-xs">
                                            <div class="flex justify-between">
                                                <span class="text-pink-600 dark:text-pink-400">Open:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.file_descriptors.open"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-pink-600 dark:text-pink-400">Max:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      x-text="node.jvm_metrics.file_descriptors.max"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-pink-600 dark:text-pink-400">Usage:</span>
                                                <span class="font-medium text-gray-700 dark:text-gray-300"
                                                      :class="{
                                                          'text-red-600 dark:text-red-400': node.jvm_metrics.file_descriptors.utilization_pct > 80,
                                                          'text-yellow-600 dark:text-yellow-400': node.jvm_metrics.file_descriptors.utilization_pct > 60 && node.jvm_metrics.file_descriptors.utilization_pct <= 80
                                                      }"
                                                      x-text="node.jvm_metrics.file_descriptors.utilization_pct.toFixed(1) + '%'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- JVM Error State -->
                        <template x-if="node.jvm_metrics && node.jvm_metrics.status !== 'HEALTHY'">
                            <div class="mb-3 p-2 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800">
                                <div class="text-xs font-medium text-red-800 dark:text-red-200 mb-1 flex items-center">
                                    <i data-lucide="alert-triangle" class="h-3 w-3 mr-1"></i>
                                    JVM Status: <span x-text="node.jvm_metrics.status"></span>
                                </div>
                                <template x-if="node.jvm_metrics.error">
                                    <div class="text-xs text-red-600 dark:text-red-400 break-all"
                                         x-text="node.jvm_metrics.error"></div>
                                </template>
                            </div>
                        </template>

                        <!-- Activity Rate & Job Execution in 2 columns -->
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="p-2 bg-sky-50 dark:bg-sky-900/10 rounded border border-sky-200 dark:border-sky-800/80">
                                <div class="text-xs font-medium text-sky-800 dark:text-sky-200 mb-1 flex items-center">
                                    <i data-lucide="zap" class="h-3 w-3 mr-1"></i>Activity Rate
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-sky-600 dark:text-sky-400">Response:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="formatDuration(node.response_time_ms)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sky-600 dark:text-sky-400">Success:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{'text-red-600 dark:text-red-400': node.job_success_rate < 95}"
                                              x-text="node.job_success_rate.toFixed(1) + '%'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sky-600 dark:text-sky-400">Workload:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="formatNumber(node.workload_score)"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-2 bg-purple-50 dark:bg-purple-900/10 rounded border border-purple-200 dark:border-purple-800/70">
                                <div class="text-xs font-medium text-purple-800 dark:text-purple-200 mb-1 flex items-center">
                                    <i data-lucide="cpu" class="h-3 w-3 mr-1"></i>Job Execution
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-purple-600 dark:text-purple-400">Success:</span>
                                        <span class="font-medium text-green-600 dark:text-green-400"
                                              x-text="formatNumber(node.jobs_successful)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-purple-600 dark:text-purple-400">Failed:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{'text-red-600 dark:text-red-400': node.jobs_failed > 0}"
                                              x-text="formatNumber(node.jobs_failed)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-purple-600 dark:text-purple-400">Rejected:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{'text-orange-600 dark:text-orange-400': node.job_execution_rejected > 0}"
                                              x-text="formatNumber(node.job_execution_rejected)"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Job Acquisition & Process Activity in 2 columns -->
                        <div class="grid grid-cols-2 gap-2 mb-1">
                            <div class="p-2 bg-cyan-50 dark:bg-cyan-900/10 rounded border border-cyan-200 dark:border-cyan-800/80">
                                <div class="text-xs font-medium text-cyan-800 dark:text-cyan-200 mb-1 flex items-center">
                                    <i data-lucide="download" class="h-3 w-3 mr-1"></i>Job Acquisition
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-cyan-600 dark:text-cyan-400">Attempts:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.job_acquisition_attempts"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-cyan-600 dark:text-cyan-400">Success:</span>
                                        <span class="font-medium text-green-600 dark:text-green-400"
                                              x-text="node.job_acquired_success"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-cyan-600 dark:text-cyan-400">Rate:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              :class="{
                                                  'text-red-600 dark:text-red-400': node.job_acquisition_success_rate < 90,
                                                  'text-yellow-600 dark:text-yellow-400': node.job_acquisition_success_rate >= 90 && node.job_acquisition_success_rate < 95
                                              }"
                                              x-text="node.job_acquisition_success_rate.toFixed(1) + '%'"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-2 bg-emerald-50 dark:bg-emerald-900/10 rounded border border-emerald-200 dark:border-emerald-800/80">
                                <div class="text-xs font-medium text-emerald-800 dark:text-emerald-200 mb-1 flex items-center">
                                    <i data-lucide="play" class="h-3 w-3 mr-1"></i>Process Activity
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-emerald-600 dark:text-emerald-400">Started:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.process_instances_started"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-emerald-600 dark:text-emerald-400">Flow Nodes:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.flow_node_instances"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-emerald-600 dark:text-emerald-400">Decisions:</span>
                                        <span class="font-medium text-gray-700 dark:text-gray-300"
                                              x-text="node.decision_instances"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Error State -->
                <template x-if="node.status !== 'RUNNING'">
                    <div class="text-xs text-red-700 dark:text-red-300 italic break-all"
                         x-text="node.error || 'Node not responding'"></div>
                </template>
            </div>
        </template>
    </div>
</div>

    <!-- Database Health & Performance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <!-- Database Storage -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-300 dark:border-gray-600"
             x-intersect.once="loadDatabaseMetrics()">
            <div class="px-4 py-3 bg-gradient-to-r from-gray-100 to-white dark:from-gray-800 dark:to-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
                    <i data-lucide="hard-drive" class="mr-2 h-5 w-5 text-gray-600 dark:text-gray-400"></i>
                    Database Storage
                </h3>
                <div class="flex items-center space-x-2">
                    <div class="group relative">
                        <i data-lucide="help-circle"
                           class="h-4 w-4 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute top-full right-0 mt-2 w-72 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Top 10 largest Camunda tables. Watch for excessive history growth in act_hi_* and act_ru_*
                            tables.
                        </div>
                    </div>
                    <button @click="loadDatabaseMetrics()"
                            class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i data-lucide="refresh-cw" class="h-4 w-4"
                           :class="{ 'animate-spin': databaseMetricsLoading }"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <template x-if="databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1">
                    <div class="space-y-3 max-h-96 pr-2">
                        <template x-for="i in 10" :key="i">
                            <div class="flex items-center justify-between animate-pulse">
                                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-32"></div>
                                <div class="flex items-center space-x-2">
                                    <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-16"></div>
                                    <div class="w-24 h-2 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Loaded Content -->
            <template x-if="databaseMetrics && !databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1">
                    <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2"
                         x-show="databaseMetrics.table_sizes && databaseMetrics.table_sizes.length">
                        <template x-for="(table, index) in databaseMetrics.table_sizes" :key="table.table_name">
                            <div class="flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors py-0">
                                <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300 font-mono"
                                      x-text="table.table_name"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500 dark:text-gray-400 w-20 text-right"
                                      x-text="formatBytes(table.size_bytes)"></span>
                                    <div class="w-24 h-2 bg-gray-200 dark:bg-gray-600 rounded-full">
                                        <div class="h-2 bg-sky-500 dark:bg-sky-400 rounded-full"
                                             :style="`width: ${(table.size_bytes / (databaseMetrics.table_sizes[0]?.size_bytes || 1) * 100)}%`"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="!databaseMetrics.table_sizes || !databaseMetrics.table_sizes.length"
                         class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                        No table data available.
                    </div>
                    <template x-if="databaseMetrics.archivable_instances > 0">
                        <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="archive" class="h-4 w-4 text-yellow-600 dark:text-yellow-400 mr-2"></i>
                                <span class="text-sm text-yellow-800 dark:text-yellow-200">
                                <strong x-text="formatNumber(databaseMetrics.archivable_instances)"></strong>
                                instances ready for archiving (>90 days old)
                            </span>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="databaseMetricsError && !databaseMetricsLoading">
                <div class="p-4">
                    <div class="text-center py-4 text-red-600 dark:text-red-400">
                        <i data-lucide="alert-circle" class="h-6 w-6 mx-auto mb-2"></i>
                        <p class="text-sm">Failed to load storage data</p>
                        <button @click="loadDatabaseMetrics()" class="mt-1 text-xs underline">Try Again</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Slow Queries -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-300 dark:border-gray-600"
             x-intersect.once="loadDatabaseMetrics()">
            <div class="px-4 py-3 bg-gradient-to-r from-yellow-100 to-white dark:from-yellow-900/20 dark:to-gray-900 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
                    <i data-lucide="snail" class="mr-2 h-5 w-5 text-gray-600 dark:text-gray-400"></i>
                    Slow DB Queries
                </h3>
                <div class="flex items-center space-x-2">
                    <div class="group relative">
                        <i data-lucide="help-circle"
                           class="h-4 w-4 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer"></i>
                        <div class="absolute top-full right-0 mt-2 w-72 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Most expensive database queries. Requires the 'pg_stat_statements' PostgreSQL extension to
                            be enabled.
                        </div>
                    </div>
                    <button @click="loadDatabaseMetrics()"
                            class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i data-lucide="refresh-cw" class="h-4 w-4"
                           :class="{ 'animate-spin': databaseMetricsLoading }"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <template x-if="databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1 max-h-96">
                    <div class="space-y-2">
                        <template x-for="i in 5" :key="i">
                            <div class="p-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-700 rounded-lg text-xs font-mono animate-pulse">
                                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded mb-1"></div>
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Loaded Content -->
            <template x-if="databaseMetrics && !databaseMetricsLoading">
                <div class="px-4 pb-4 pt-1 max-h-96 overflow-y-auto custom-scrollbar">
                    <div class="space-y-2" x-show="databaseMetrics.slow_queries && databaseMetrics.slow_queries.length">
                        <template x-for="(query, index) in databaseMetrics.slow_queries" :key="query.full_query + '-' + query.calls + '-' + index">
                            <div class="p-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors rounded-lg text-xs font-mono">
                                <p class="text-gray-800 dark:text-gray-200 truncate"
                                   :title="query.full_query"
                                   x-text="query.query_preview + '...'"></p>
                                <p class="text-gray-600 dark:text-gray-400 mt-1">
                                    <span>Avg: </span><span x-text="formatDuration(query.avg_ms)"></span>
                                    <span>, Max: </span><span x-text="formatDuration(query.max_ms)"></span>
                                    <span>, Calls: </span><span x-text="query.calls"></span>
                                </p>
                            </div>
                        </template>
                    </div>
                    <div x-show="!databaseMetrics.slow_queries || !databaseMetrics.slow_queries.length"
                         class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm">
                        <i data-lucide="database-zap" class="h-8 w-8 mx-auto mb-2 text-gray-400 dark:text-gray-500"></i>
                        <p>No slow query data available.</p>
                        <p class="text-xs mt-1">Requires pg_stat_statements extension</p>
                    </div>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="databaseMetricsError && !databaseMetricsLoading">
                <div class="p-4">
                    <div class="text-center py-4 text-red-600 dark:text-red-400">
                        <i data-lucide="alert-circle" class="h-6 w-6 mx-auto mb-2"></i>
                        <p class="text-sm">Failed to load query data</p>
                        <button @click="loadDatabaseMetrics()" class="mt-1 text-xs underline">Try Again</button>
                    </div>
                </div>
            </template>
        </div>
    </div>

</main>

<!-- Footer -->
<footer class="mt-auto bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
            <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
                <i data-lucide="copyright" class="h-4 w-4"></i>
                <span>2025 <a href="https://champa-bpmn.com" target="_blank" rel="noopener noreferrer"
                    class="text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300 font-medium">Champa Intelligence</a></span>
                <span>â€¢</span>
                <span>Open Source</span>
            </div>

            <div class="flex items-center space-x-6 text-sm">
                <a href="https://github.com/bibacrm/camunda-health-monitor"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center space-x-1 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100">
                    <i data-lucide="github" class="h-4 w-4"></i>
                    <span>GitHub</span>
                </a>

                <a href="https://youtu.be/WFQRxpmjRrE"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center space-x-1 text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                    <i data-lucide="video" class="h-4 w-4"></i>
                    <span>Video Demo</span>
                </a>

                <a href="https://champa-bpmn.com"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center space-x-1 text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300">
                    <i data-lucide="globe" class="h-4 w-4"></i>
                    <span>Enterprise</span>
                </a>
            </div>
        </div>

    </div>
</footer>

<script>
    function healthMonitor() {
        return {
            data: {{ data|tojson|safe }},
            darkMode: false,
            autoRefresh: false,
            isLoading: false,
            refreshInterval: null,
            mobileMenuOpen: false,

            // Lazy loading states
            metricLoading: {},
            metricData: {},
            metricErrors: {},
            databaseMetricsLoading: false,
            databaseMetrics: null,
            databaseMetricsError: null,

            init() {
                // Set dark mode from localStorage on init
                this.darkMode = localStorage.getItem('darkMode') === 'true';
                this.applyDarkMode();
                this.$nextTick(() => lucide.createIcons());
            },

            toggleDarkMode() {
                this.darkMode = !this.darkMode;
                localStorage.setItem('darkMode', this.darkMode);
                this.applyDarkMode();
            },

            applyDarkMode() {
                if (this.darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            toggleAutoRefresh() {
                this.autoRefresh = !this.autoRefresh;
                if (this.autoRefresh) {
                    this.refreshInterval = setInterval(() => this.refreshData(), 30000);
                } else {
                    clearInterval(this.refreshInterval);
                }
            },

            async refreshData() {
                if (this.isLoading) return;

                this.isLoading = true;
                try {
                    const response = await fetch('/api/health');
                    if (response.ok) {
                        this.data = await response.json();
                        this.$nextTick(() => lucide.createIcons());
                    }
                } catch (error) {
                    console.error('Refresh failed:', error);
                } finally {
                    this.isLoading = false;
                }
            },

            // Lazy loading for individual metrics
            async loadMetric(metricName) {
                if (this.metricLoading[metricName]) return;

                this.metricLoading[metricName] = true;
                this.metricErrors[metricName] = null;

                try {
                    const response = await fetch(`/api/metrics/${metricName}`);
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.metricData[metricName] = data;
                } catch (error) {
                    console.error(`Error loading metric '${metricName}':`, error);
                    this.metricErrors[metricName] = error.message;
                } finally {
                    this.metricLoading[metricName] = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async refreshMetric(metricName) {
                await this.loadMetric(metricName);
            },

            // Database metrics loading
            async loadDatabaseMetrics() {
                if (this.databaseMetricsLoading) return;

                this.databaseMetricsLoading = true;
                this.databaseMetricsError = null;

                try {
                    const response = await fetch('/api/metrics/database');
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.databaseMetrics = data;
                } catch (error) {
                    console.error('Error loading database metrics:', error);
                    this.databaseMetricsError = error.message;
                } finally {
                    this.databaseMetricsLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            // Helper: sum metric across all nodes
            sumNodeMetric(metricName) {
                return this.data.cluster_nodes.reduce((sum, node) => {
                    return sum + (Number(node[metricName]) || 0);
                }, 0);
            },

            // Formatting functions
            formatNumber(value) {
                if (value === null || value === undefined) return "0";
                value = Number(value);
                if (value < 1000) return Math.round(value).toString();
                if (value < 1e6) return (value / 1e3).toFixed(1) + 'K';
                return (value / 1e6).toFixed(1) + 'M';
            },

            formatDuration(ms) {
                if (ms === null || ms === undefined) return "N/A";
                ms = Number(ms);
                if (ms < 1000) return `${ms.toFixed(0)}ms`;
                if (ms < 60000) return `${(ms / 1000).toFixed(2)}s`;
                if (ms < 3600000) return `${(ms / 60000).toFixed(2)}min`;
                return `${(ms / 3600000).toFixed(2)}h`;
            },

            formatBytes(value) {
                if (!value) return "0 B";
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let i = 0;
                while (value >= 1024 && i < 4) {
                    value /= 1024;
                    i++;
                }
                return `${value.toFixed(1)} ${units[i]}`;
            },

            formatTime(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleTimeString();
            }
        };
    }

    // Apply dark mode immediately
    (function () {
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
            document.documentElement.classList.add('dark');
        }
    })();
</script>
</body>
</html>