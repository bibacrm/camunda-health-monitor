{% extends "base.html" %}

{% block title %}AI Analysis - Camunda Health Monitor{% endblock %}

{% block alpine_data %}aiAnalyticsMonitor(){% endblock %}

{% block header_info %}
<div class="text-sm text-gray-500 dark:text-gray-400">
    Last updated: <span class="font-medium text-gray-700 dark:text-gray-300"
                        x-text="formatTime(lastUpdate)"></span>
</div>
{% endblock %}

{% block mobile_menu_extra %}
<div class="flex items-center justify-between text-base text-gray-900 dark:text-gray-100">
    <span>Last updated:</span>
    <span class="font-medium" x-text="formatTime(lastUpdate)"></span>
</div>
{% endblock %}

{% block content %}
<!-- AI Intelligence Layer -->
<div class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50 dark:from-sky-900/20 dark:via-cyan-900/20 dark:to-blue-900/20 rounded-xl p-6 mb-6 border-2 border-sky-200 dark:border-sky-800 shadow-lg">

    <!-- Header - Always Visible -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
            <i data-lucide="brain" class="h-7 w-7 text-sky-600 dark:text-sky-400"></i>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                AI Intelligence Layer
            </h2>
            <span class="ml-2 text-xs px-3 py-1 bg-sky-600 text-white rounded-full">POWERED BY ML</span>
        </div>
        <button @click="refreshAIInsights()"
                :disabled="aiLoading"
                class="inline-flex items-center px-4 py-2 border border-sky-300 dark:border-sky-600 shadow-sm text-sm font-medium rounded-md text-sky-700 dark:text-sky-300 bg-white dark:bg-gray-800 hover:bg-sky-50 dark:hover:bg-sky-900/30 disabled:opacity-50">
            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2" :class="{ 'animate-spin': aiLoading }"></i>
            Refresh AI
        </button>
    </div>

    <!-- AI Content -->

        <!-- Loading State -->
        <template x-if="aiLoading && !aiData">
            <div class="flex flex-col items-center justify-center py-12">
                <div class="loader mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400">AI analyzing the Camunda cluster...</p>
            </div>
        </template>

        <!-- Error State -->
        <template x-if="aiError && !aiData">
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                <p class="text-red-700 dark:text-red-300 mb-2">Failed to load AI insights</p>
                <button @click="refreshAIInsights()" class="text-sm text-red-600 dark:text-red-400 underline">Try Again</button>
            </div>
        </template>

        <!-- AI Content -->
        <template x-if="aiData">
            <div>
            <!-- Health Scores Row -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- Cluster Health Score -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg border-l-4"
                     :class="aiData.health_score.overall_score >= 80 ? 'border-l-green-500' : aiData.health_score.overall_score >= 60 ? 'border-l-yellow-500' : 'border-l-red-500'">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Cluster Health</span>
                        <i data-lucide="activity" class="h-5 w-5 text-sky-600 dark:text-sky-400"></i>
                    </div>
                    <div class="flex items-baseline space-x-2 mb-2">
                        <span class="text-5xl font-bold"
                              :class="aiData.health_score.overall_score >= 80 ? 'text-green-600 dark:text-green-400' : aiData.health_score.overall_score >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'"
                              x-text="aiData.health_score.overall_score"></span>
                        <span class="text-2xl text-gray-500">/100</span>
                    </div>
                    <p class="text-xs font-semibold mb-1"
                       :class="aiData.health_score.overall_score >= 80 ? 'text-green-600' : aiData.health_score.overall_score >= 60 ? 'text-yellow-600' : 'text-red-600'"
                       x-text="aiData.health_score.grade"></p>
                    <p class="text-xs text-gray-500 dark:text-gray-400" x-text="aiData.health_score.factors"></p>
                </div>

                <!-- Anomalies Detected -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg cursor-pointer hover:shadow-xl transition-shadow"
                     @click="$refs.anomalyModal.classList.toggle('hidden'); $nextTick(() => lucide.createIcons())"
                     :class="(aiData.anomalies.anomalies?.length || 0) > 0 ? 'border-l-4 border-l-yellow-500' : ''">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Anomalies</span>
                        <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <div class="text-4xl font-bold text-yellow-600 dark:text-yellow-400 mb-2"
                         x-text="aiData.anomalies.anomalies?.length || 0"></div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <template x-if="(aiData.anomalies.anomalies?.length || 0) > 0">
                            <span>Statistical outliers detected</span>
                        </template>
                        <template x-if="(aiData.anomalies.anomalies?.length || 0) === 0">
                            <span>All processes normal</span>
                        </template>
                    </p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1"
                       x-text="`Analyzed ${aiData.anomalies.total_analyzed || 0} processes`"></p>
                    <template x-if="(aiData.anomalies.anomalies?.length || 0) > 0">
                        <div class="mt-3 text-xs text-yellow-600 dark:text-yellow-400 font-medium flex items-center">
                            <span>Click to view details</span>
                            <i data-lucide="chevron-right" class="h-3 w-3 ml-1"></i>
                        </div>
                    </template>
                </div>

                <!-- SLA Risks -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">SLA Risks</span>
                        <i data-lucide="clock" class="h-5 w-5 text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="text-4xl font-bold text-red-600 dark:text-red-400 mb-2"
                         x-text="aiData.sla_predictions.at_risk_tasks?.length || 0"></div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        Tasks likely to breach SLA
                    </p>
                    <template x-if="aiData.sla_predictions.at_risk_tasks?.length > 0">
                        <p class="text-xs font-semibold text-red-600 dark:text-red-400 mt-1">
                            Action required!
                        </p>
                    </template>
                </div>

                <!-- Top Bottleneck Impact -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Top Bottleneck</span>
                        <i data-lucide="trending-down" class="h-5 w-5 text-orange-600 dark:text-orange-400"></i>
                    </div>
                    <template x-if="aiData.bottlenecks.bottlenecks?.length > 0">
                        <div>
                            <div class="text-4xl font-bold text-orange-600 dark:text-orange-400 mb-2"
                                 x-text="aiData.bottlenecks.bottlenecks[0].impact_hours_per_week + 'h'"></div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                Wasted per week
                            </p>
                            <p class="text-xs text-gray-700 dark:text-gray-300 mt-1 truncate"
                               :title="aiData.bottlenecks.bottlenecks[0].activity_name"
                               x-text="aiData.bottlenecks.bottlenecks[0].activity_name"></p>
                        </div>
                    </template>
                    <template x-if="!aiData.bottlenecks.bottlenecks?.length">
                        <div>
                            <div class="text-4xl font-bold text-green-600 dark:text-green-400 mb-2">‚úì</div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">No bottlenecks detected</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- AI Recommendations -->
            <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                    <i data-lucide="lightbulb" class="mr-2 h-5 w-5 text-blue-600 dark:text-blue-400"></i>
                    AI Recommendations
                </h4>
                <div class="space-y-2">
                    <template x-for="(rec, index) in aiData.recommendations" :key="index">
                        <div class="flex items-start p-3 bg-white dark:bg-gray-800 rounded-lg border-l-4"
                             :class="{
                                 'border-l-red-500': rec.priority === 'critical',
                                 'border-l-orange-500': rec.priority === 'high',
                                 'border-l-yellow-500': rec.priority === 'medium',
                                 'border-l-blue-500': rec.priority === 'low'
                             }">
                            <div class="flex-shrink-0 mr-3">
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold"
                                      :class="{
                                          'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': rec.priority === 'critical',
                                          'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': rec.priority === 'high',
                                          'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': rec.priority === 'medium',
                                          'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': rec.priority === 'low'
                                      }"
                                      x-text="rec.priority.toUpperCase()"></span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 dark:text-gray-300 font-medium mb-1" x-text="rec.message"></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    <span class="font-semibold">Action:</span> <span x-text="rec.action"></span>
                                </p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Detailed Insights Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Process Anomalies -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="alert-triangle" class="mr-2 h-4 w-4 text-yellow-600"></i>
                            <span>Process Execution Anomalies</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    ML-powered detection of processes running significantly slower than baseline. Uses statistical analysis (Z-score) and compares recent performance to historical averages.
                                </span>
                            </span>
                        </div>
                        <span class="text-xs text-gray-500" x-text="`Last ${aiData.anomalies.detection_window_days || 7} days`"></span>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-if="aiData.anomalies.anomalies?.length > 0">
                            <template x-for="anomaly in aiData.anomalies.anomalies.slice(0, config.aiDisplayLimits.rows_limit)" :key="anomaly.process_key">
                                <div class="flex items-center justify-between py-2 px-3 rounded border-l-4"
                                     :class="{
                                         'bg-red-50 dark:bg-red-900/20 border-l-red-600': anomaly.severity === 'critical',
                                         'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': anomaly.severity === 'high',
                                         'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': anomaly.severity === 'medium',
                                         'bg-blue-50 dark:bg-blue-900/20 border-l-blue-500': anomaly.severity === 'low'
                                     }">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                               :title="anomaly.process_key"
                                               x-text="anomaly.process_key"></p>
                                            <span class="text-xs px-2 py-0.5 rounded-full font-semibold uppercase"
                                                  :class="{
                                                      'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400': anomaly.severity === 'critical',
                                                      'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400': anomaly.severity === 'high',
                                                      'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400': anomaly.severity === 'medium',
                                                      'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400': anomaly.severity === 'low'
                                                  }"
                                                  x-text="anomaly.severity"></span>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">
                                            Expected: <span x-text="formatDuration(anomaly.expected_avg_ms)"></span> ‚Üí
                                            Current: <span x-text="formatDuration(anomaly.current_avg_ms)"></span>
                                        </p>
                                        <template x-if="anomaly.max_duration_ms && anomaly.max_duration_ms > 3600000">
                                            <p class="text-xs text-red-600 dark:text-red-400 mt-1">
                                                ‚ö†Ô∏è Max: <span x-text="formatDuration(anomaly.max_duration_ms)"></span>
                                            </p>
                                        </template>
                                        <template x-if="anomaly.anomaly_types?.includes('extreme_duration')">
                                            <p class="text-xs text-red-600 dark:text-red-400 mt-1">
                                                üî¥ Potential stuck/hanging process detected
                                            </p>
                                        </template>
                                    </div>
                                    <div class="ml-2 text-right">
                                        <span class="text-sm font-bold"
                                              :class="anomaly.deviation_pct > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"
                                              x-text="(anomaly.deviation_pct > 0 ? '+' : '') + anomaly.deviation_pct + '%'"></span>
                                        <template x-if="anomaly.z_score > 0">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                Z: <span x-text="anomaly.z_score"></span>
                                            </p>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </template>
                        <template x-if="!aiData.anomalies.anomalies?.length">
                            <div class="text-center py-8">
                                <template x-if="aiData.anomalies.health_status === 'excellent'">
                                    <div>
                                        <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                        <p class="text-sm font-semibold text-green-600 dark:text-green-400">Stable Performance!</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 px-4" x-text="aiData.anomalies.message || 'All processes executing consistently'"></p>
                                    </div>
                                </template>
                                <template x-if="aiData.anomalies.health_status !== 'excellent'">
                                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="aiData.anomalies.message || 'No anomalies detected'"></p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Incident Patterns -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="alert-circle" class="mr-2 h-4 w-4 text-orange-600"></i>
                            <span>Top Incident Patterns</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Analyzes historical incident data or runtime job failures to identify recurring error patterns. Groups by error type and frequency to help prioritize fixes.
                                </span>
                            </span>
                        </div>
                        <span class="text-xs text-gray-500" x-text="`${aiData.incidents.unique_patterns || 0} unique patterns`"></span>
                    </div>

                    <!-- Data source warning if from runtime jobs -->
                    <template x-if="aiData.incidents.data_source === 'runtime_jobs'">
                        <div class="mb-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-xs">
                            <i data-lucide="info" class="h-3 w-3 inline mr-1"></i>
                            <span class="text-yellow-700 dark:text-yellow-300">Analyzing active job exceptions (incident history not logged)</span>
                        </div>
                    </template>

                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-if="aiData.incidents.patterns?.length > 0">
                            <div>
                                <!-- Root Cause Categories Summary (compact) -->
                                <template x-if="aiData.incidents.root_cause_categories && Object.keys(aiData.incidents.root_cause_categories).length > 0">
                                    <div class="mb-3 p-3 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Root Cause Breakdown</p>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="[category, count] in Object.entries(aiData.incidents.root_cause_categories).sort((a,b) => b[1] - a[1]).slice(0, 5)" :key="category">
                                                <span class="inline-flex items-center text-xs px-2 py-1 bg-white dark:bg-gray-800 rounded-full border border-orange-300 dark:border-orange-700">
                                                    <span class="font-medium text-gray-900 dark:text-gray-100" x-text="category"></span>
                                                    <span class="ml-1 text-orange-600 dark:text-orange-400 font-bold" x-text="count"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <template x-for="(pattern,index) in aiData.incidents.patterns.slice(0, config.aiDisplayLimits.rows_limit)" :key="pattern.incident_type + index">
                                <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded border-l-2 border-l-orange-500 cursor-pointer hover:shadow-md transition-shadow"
                                     @click="selectedIncident = pattern; $refs.incidentModal.classList.remove('hidden'); $nextTick(() => lucide.createIcons())">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="pattern.incident_type"></p>
                                                <template x-if="pattern.root_cause">
                                                    <span class="text-xs px-2 py-0.5 bg-orange-200 dark:bg-orange-800 text-orange-900 dark:text-orange-200 rounded"
                                                          x-text="pattern.root_cause"></span>
                                                </template>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1 line-clamp-2"
                                               :title="pattern.error_message"
                                               x-text="pattern.error_message"></p>
                                        </div>
                                        <span class="text-xs px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-full font-semibold ml-2"
                                              x-text="pattern.occurrence_count + 'x'"></span>
                                    </div>

                                    <!-- Status and Metrics Row -->
                                    <div class="grid grid-cols-3 gap-2 mb-2 text-xs">
                                        <div class="text-center p-1 bg-white dark:bg-gray-700/50 rounded">
                                            <div class="text-gray-500 dark:text-gray-400">Open</div>
                                            <div class="font-semibold text-red-600 dark:text-red-400" x-text="pattern.open_count || 0"></div>
                                        </div>
                                        <div class="text-center p-1 bg-white dark:bg-gray-700/50 rounded">
                                            <div class="text-gray-500 dark:text-gray-400">Resolved</div>
                                            <div class="font-semibold text-green-600 dark:text-green-400" x-text="pattern.resolved_count || 0"></div>
                                        </div>
                                        <div class="text-center p-1 bg-white dark:bg-gray-700/50 rounded">
                                            <div class="text-gray-500 dark:text-gray-400">Avg Time</div>
                                            <div class="font-semibold text-gray-900 dark:text-gray-100" x-text="(pattern.avg_duration_hours || 0).toFixed(1) + 'h'"></div>
                                        </div>
                                    </div>

                                    <!-- Affected Details -->
                                    <div class="text-xs text-gray-500 dark:text-gray-500">
                                        <template x-if="pattern.source === 'runtime_jobs'">
                                            <span>
                                                <span x-text="pattern.retries_exhausted || 0"></span> with no retries ¬∑
                                                <span x-text="pattern.affected_processes?.length || 0"></span> instance(s)
                                            </span>
                                        </template>
                                        <template x-if="pattern.source !== 'runtime_jobs'">
                                            <span>
                                                <span x-text="(pattern.frequency_per_day || 0).toFixed(1)"></span>/day ¬∑
                                                <span x-text="pattern.affected_processes?.length || 0"></span> process(es)
                                                <template x-if="pattern.affected_activities?.length > 0">
                                                    ¬∑ <span x-text="pattern.affected_activities.length"></span> activity/activities
                                                </template>
                                                <template x-if="pattern.sample_instances && pattern.sample_instances.length > 0">
                                                    <span class="ml-2 text-blue-600 dark:text-blue-400 font-medium">¬∑ Click for details ‚Üí</span>
                                                </template>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            </div>
                        </template>
                        <template x-if="!aiData.incidents.patterns?.length">
                            <div class="text-center py-8">
                                <template x-if="aiData.incidents.health_status === 'excellent'">
                                    <div>
                                        <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                        <p class="text-sm font-semibold text-green-600 dark:text-green-400">System Healthy!</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="aiData.incidents.message || 'No incidents detected'"></p>
                                    </div>
                                </template>
                                <template x-if="aiData.incidents.health_status !== 'excellent'">
                                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="aiData.incidents.message || 'No incident patterns found'"></p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Process Bottlenecks -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="trending-down" class="mr-2 h-4 w-4 text-red-600"></i>
                            <span>Top Process Bottlenecks</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Identifies activities with longest execution times using P95 percentile analysis. Shows potential optimization targets and estimated time savings per week.
                                </span>
                            </span>
                        </div>
                        <span class="text-xs text-gray-500" x-text="`${aiData.bottlenecks.total_activities_analyzed || 0} activities`"></span>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-if="aiData.bottlenecks.bottlenecks?.length > 0">
                            <template x-for="(bottleneck, index) in aiData.bottlenecks.bottlenecks.slice(0, config.aiDisplayLimits.rows_limit)" :key="bottleneck.activity_id + index">
                                <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded border-l-2 border-l-red-500">
                                    <div class="flex items-start justify-between mb-1">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                           :title="bottleneck.activity_name"
                                           x-text="bottleneck.activity_name"></p>
                                        <span class="text-sm font-bold text-red-600 dark:text-red-400 ml-2"
                                              x-text="bottleneck.impact_hours_per_week + 'h/wk'"></span>
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                        Avg: <span x-text="formatDuration(bottleneck.avg_duration_ms)"></span> ¬∑
                                        P95: <span x-text="formatDuration(bottleneck.p95_duration_ms)"></span>
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500" x-text="`${bottleneck.executions} executions in ${bottleneck.process_key}`"></p>
                                </div>
                            </template>
                        </template>
                        <template x-if="!aiData.bottlenecks.bottlenecks?.length">
                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No significant bottlenecks detected</p>
                        </template>
                    </div>
                </div>

                <!-- Job Failure Predictions -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="zap" class="mr-2 h-4 w-4 text-purple-600"></i>
                            <span>Job Failure Predictions</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Predicts which job types are at risk of failure based on historical failure rates. Helps prioritize preventive maintenance and error handling improvements.
                                </span>
                            </span>
                        </div>
                        <span class="text-xs text-gray-500" x-text="`${aiData.job_failures.total_jobs_analyzed || 0} job types`"></span>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-if="aiData.job_failures.predictions?.length > 0">
                            <div>
                                <!-- All Healthy Banner (when total_failures is 0) -->
                                <template x-if="aiData.job_failures.all_healthy || aiData.job_failures.total_failures === 0">
                                <div class="mb-3 p-2 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded border border-green-200 dark:border-green-800">
                                    <div class="flex items-center text-xs">
                                        <i data-lucide="check-circle" class="inline h-4 w-4 mr-2 text-green-600 dark:text-green-400"></i>
                                        <span class="font-semibold text-green-700 dark:text-green-300">
                                            All job types executing successfully!
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                        Showing top <span x-text="aiData.job_failures.predictions.length"></span> job types by volume
                                    </div>
                                </div>
                            </template>

                            <!-- Failure Summary Bar (compact) - Only show if failures exist -->
                            <template x-if="aiData.job_failures.total_failures > 0">
                                <div class="mb-3 p-2 bg-gradient-to-r from-purple-50 to-red-50 dark:from-purple-900/20 dark:to-red-900/20 rounded border border-purple-200 dark:border-purple-800">
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">
                                            <i data-lucide="alert-circle" class="inline h-3 w-3 mr-1"></i>
                                            <span x-text="aiData.job_failures.total_failures"></span> total failures
                                        </span>
                                        <span class="text-gray-500 dark:text-gray-400"
                                              x-text="`${((aiData.job_failures.total_failures / aiData.job_failures.total_executions * 100) || 0).toFixed(1)}% failure rate`"></span>
                                    </div>
                                </div>
                            </template>

                            <template x-for="pred in aiData.job_failures.predictions.slice(0, config.aiDisplayLimits.rows_limit)" :key="pred.job_type">
                                <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded border-l-2"
                                     :class="{
                                         'border-l-red-500': pred.risk_level === 'high' && pred.failed_count > 0,
                                         'border-l-yellow-500': pred.risk_level === 'medium' && pred.failed_count > 0,
                                         'border-l-green-500': pred.risk_level === 'low' || pred.failed_count === 0
                                     }">
                                    <div class="flex items-start justify-between mb-1">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                           :title="pred.job_type"
                                           x-text="pred.job_type"></p>
                                        <span class="text-sm font-bold ml-2"
                                              :class="{
                                                  'text-red-600 dark:text-red-400': pred.risk_level === 'high' && pred.failed_count > 0,
                                                  'text-yellow-600 dark:text-yellow-400': pred.risk_level === 'medium' && pred.failed_count > 0,
                                                  'text-green-600 dark:text-green-400': pred.risk_level === 'low' || pred.failed_count === 0
                                              }"
                                              x-text="pred.failure_rate_pct + '%'"></span>
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                        <template x-if="pred.failed_count > 0">
                                            <span>
                                                <span x-text="pred.failed_count"></span> failed /
                                                <span x-text="pred.total_executions"></span> total executions
                                            </span>
                                        </template>
                                        <template x-if="pred.failed_count === 0">
                                            <span>
                                                <span x-text="pred.total_executions"></span> executions - all successful ‚úì
                                            </span>
                                        </template>
                                    </p>
                                    <template x-if="pred.failed_count > 0">
                                        <p class="text-xs text-gray-500 dark:text-gray-500" x-text="pred.recommendation"></p>
                                    </template>
                                </div>
                            </template>
                            </div>
                        </template>
                        <template x-if="!aiData.job_failures.predictions?.length">
                            <div class="text-center py-8">
                                <template x-if="aiData.job_failures.data_source === 'none'">
                                    <div>
                                        <i data-lucide="info" class="h-12 w-12 text-blue-500 dark:text-blue-400 mx-auto mb-2"></i>
                                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Job History Not Available</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 px-4" x-text="aiData.job_failures.message || 'Job logging may be disabled or processes use sync execution'"></p>
                                    </div>
                                </template>
                                <template x-if="aiData.job_failures.data_source !== 'none'">
                                    <div>
                                        <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                        <p class="text-sm font-semibold text-green-600 dark:text-green-400">All Jobs Healthy!</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="aiData.job_failures.message || 'All jobs executing successfully'"></p>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Node Performance Rankings & Process Leaderboard -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Node Performance Rankings -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                        <i data-lucide="award" class="mr-2 h-4 w-4 text-indigo-600"></i>
                        <span>Node Performance Rankings</span>
                        <span class="group relative ml-2">
                            <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                            <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                Ranks cluster nodes based on JVM health metrics (CPU, memory, GC efficiency). Helps identify underperforming nodes that may need attention.
                            </span>
                        </span>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-if="aiData.node_performance.rankings?.length > 0">
                            <template x-for="node in aiData.node_performance.rankings" :key="node.node_name">
                                <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm mr-3"
                                         :class="{
                                             'bg-yellow-400 text-yellow-900': node.rank === 1,
                                             'bg-gray-300 text-gray-700': node.rank === 2,
                                             'bg-orange-300 text-orange-900': node.rank === 3,
                                             'bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-200': node.rank > 3
                                         }"
                                         x-text="node.rank"></div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="node.node_name"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="node.recommendation"></p>
                                    </div>
                                    <div class="ml-2 text-right">
                                        <span class="text-lg font-bold"
                                              :class="{
                                                  'text-green-600 dark:text-green-400': node.performance_score >= 80,
                                                  'text-yellow-600 dark:text-yellow-400': node.performance_score >= 60 && node.performance_score < 80,
                                                  'text-red-600 dark:text-red-400': node.performance_score < 60
                                              }"
                                              x-text="node.performance_score"></span>
                                    </div>
                                </div>
                            </template>
                        </template>
                        <template x-if="!aiData.node_performance.rankings?.length">
                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Need at least 2 nodes for comparison</p>
                        </template>
                    </div>
                </div>

                <!-- Process Performance Leaderboard -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="trophy" class="mr-2 h-4 w-4 text-yellow-600"></i>
                            <span>Process Performance Leaderboard</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Ranks processes by performance grade (A-F) based on completion rate, average duration, and consistency. Shows best and worst performing processes.
                                </span>
                            </span>
                        </div>
                        <span class="text-xs text-gray-500" x-text="`${aiData.process_leaderboard.total_processes || 0} processes`"></span>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-if="aiData.process_leaderboard.leaderboard?.length > 0">
                            <template x-for="proc in aiData.process_leaderboard.leaderboard.slice(0, config.aiDisplayLimits.rows_limit)" :key="proc.process_key">
                                <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                    <div class="flex-shrink-0 w-10 h-10 rounded flex items-center justify-center font-bold text-lg mr-3"
                                         :class="{
                                             'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': proc.grade === 'A',
                                             'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': proc.grade === 'B',
                                             'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': proc.grade === 'C',
                                             'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': proc.grade === 'D',
                                             'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': proc.grade === 'F'
                                         }"
                                         x-text="proc.grade"></div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                           :title="proc.process_key"
                                           x-text="proc.process_key"></p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">
                                            <span x-text="proc.instance_count"></span> instances ¬∑
                                            Avg: <span x-text="formatDuration(proc.avg_duration_ms)"></span>
                                        </p>
                                    </div>
                                    <div class="ml-2 text-right text-xs">
                                        <p class="text-green-600 dark:text-green-400" x-text="proc.completion_rate_pct + '%'"></p>
                                        <p class="text-gray-500 dark:text-gray-400">complete</p>
                                    </div>
                                </div>
                            </template>
                        </template>
                        <template x-if="!aiData.process_leaderboard.leaderboard?.length">
                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No process data available</p>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Advanced ML Features Row -->
            <div class="bg-gradient-to-r from-cyan-100/70 to-sky-50 dark:from-cyan-900/20 dark:to-sky-900/20 rounded-lg p-4 mt-6 mb-6 border border-cyan-200 dark:border-cyan-700"
                 x-intersect.once="loadAdvancedMLFeatures()">
                <div class="flex items-center mb-4">
                    <i data-lucide="sparkles" class="h-5 w-5 text-cyan-600 dark:text-cyan-400 mr-2"></i>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Advanced ML Features</h3>
                </div>

                <!-- Smart Stuck Activities & Capacity Forecast -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Smart Stuck Activity Detection -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                <i data-lucide="hourglass" class="mr-2 h-4 w-4 text-red-600"></i>
                                Smart Stuck Activities
                            </div>
                            <div class="group relative">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <div class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Statistical P95-based detection. Identifies activities taking abnormally long compared to historical patterns (not hardcoded timeouts).
                                </div>
                            </div>
                        </div>

                        <!-- Loading/fetch button -->
                        <template x-if="!stuckActivitiesData && !stuckActivitiesLoading">
                            <div class="text-center py-8">
                                <button @click="loadStuckActivities()"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">
                                    <i data-lucide="play-circle" class="h-4 w-4 mr-2"></i>
                                    Analyze Activities
                                </button>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to detect stuck activities</p>
                            </div>
                        </template>

                        <!-- Loading state -->
                        <template x-if="stuckActivitiesLoading">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="loader mb-2"></div>
                                <p class="text-xs text-gray-500">Analyzing activity patterns...</p>
                            </div>
                        </template>

                        <!-- Results -->
                        <template x-if="stuckActivitiesData && !stuckActivitiesLoading">
                            <div>
                                <div class="flex items-center justify-between mb-3 p-2 bg-gray-50 dark:bg-gray-700/30 rounded">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">
                                        Found: <span class="font-bold" x-text="stuckActivitiesData.total_found"></span> stuck
                                    </span>
                                    <span class="text-xs text-gray-500">
                                        P<span x-text="stuckActivitiesData.threshold_percentile"></span> √ó <span x-text="stuckActivitiesData.threshold_multiplier"></span>
                                    </span>
                                </div>

                                <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                                    <template x-if="stuckActivitiesData.stuck_activities?.length > 0">
                                        <template x-for="activity in stuckActivitiesData.stuck_activities.slice(0, 10)" :key="activity.activity_instance_id">
                                            <div class="p-3 rounded border-l-4"
                                                 :class="{
                                                     'bg-red-50 dark:bg-red-900/20 border-l-red-600': activity.severity === 'critical',
                                                     'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': activity.severity === 'high',
                                                     'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': activity.severity === 'medium'
                                                 }">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                                           :title="activity.activity_name"
                                                           x-text="activity.activity_name"></p>
                                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                            Process: <span x-text="activity.process_key"></span>
                                                        </p>
                                                    </div>
                                                    <div class="ml-2 text-right">
                                                        <span class="text-lg font-bold"
                                                              :class="{
                                                                  'text-red-600 dark:text-red-400': activity.severity === 'critical',
                                                                  'text-orange-600 dark:text-orange-400': activity.severity === 'high',
                                                                  'text-yellow-600 dark:text-yellow-400': activity.severity === 'medium'
                                                              }"
                                                              x-text="activity.duration_ratio + 'x'"></span>
                                                    </div>
                                                </div>
                                                <div class="mt-2 flex items-center justify-between text-xs">
                                                    <span class="text-gray-500 dark:text-gray-400">
                                                        Stuck for: <span class="font-semibold" x-text="activity.stuck_for_hours + 'h'"></span>
                                                    </span>
                                                    <template x-if="activity.z_score">
                                                        <span class="text-gray-500 dark:text-gray-400">
                                                            Z-score: <span class="font-semibold" x-text="activity.z_score"></span>
                                                        </span>
                                                    </template>
                                                </div>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="activity.message"></p>
                                            </div>
                                        </template>
                                    </template>

                                    <template x-if="!stuckActivitiesData.stuck_activities?.length">
                                        <div class="text-center py-6">
                                            <i data-lucide="check-circle" class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">All Clear!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="stuckActivitiesData.message"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Capacity Forecast -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                <i data-lucide="trending-up" class="mr-2 h-4 w-4 text-blue-600"></i>
                                Capacity Forecast
                            </div>
                            <div class="group relative">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <div class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    30-day load prediction using time series analysis. Helps with infrastructure and budget planning.
                                </div>
                            </div>
                        </div>

                        <!-- Loading/fetch button -->
                        <template x-if="!capacityForecastData && !capacityForecastLoading">
                            <div class="text-center py-8">
                                <button @click="loadCapacityForecast()"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                                    Generate Forecast
                                </button>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to forecast capacity needs</p>
                            </div>
                        </template>

                        <!-- Loading state -->
                        <template x-if="capacityForecastLoading">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="loader mb-2"></div>
                                <p class="text-xs text-gray-500">Forecasting capacity...</p>
                            </div>
                        </template>

                        <!-- Results -->
                        <template x-if="capacityForecastData && !capacityForecastLoading">
                            <div>
                                <!-- Summary stats -->
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <div class="p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Growth Rate</p>
                                        <p class="text-lg font-bold"
                                           :class="{
                                               'text-green-600 dark:text-green-400': capacityForecastData.growth_rate_per_day < 5,
                                               'text-yellow-600 dark:text-yellow-400': capacityForecastData.growth_rate_per_day >= 5 && capacityForecastData.growth_rate_per_day < 15,
                                               'text-red-600 dark:text-red-400': capacityForecastData.growth_rate_per_day >= 15
                                           }"
                                           x-text="capacityForecastData.growth_rate_per_day + '/day'"></p>
                                    </div>
                                    <div class="p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Confidence</p>
                                        <p class="text-lg font-bold text-blue-600 dark:text-blue-400"
                                           x-text="Math.round(capacityForecastData.trend_confidence * 100) + '%'"></p>
                                    </div>
                                </div>

                                <!-- Peak patterns -->
                                <template x-if="capacityForecastData.patterns">
                                    <div class="mb-3">
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Peak Hours:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="hour in capacityForecastData.patterns.peak_hours?.slice(0, 3)" :key="hour.hour">
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400">
                                                    <span x-text="hour.hour + ':00'"></span>
                                                    <span class="ml-1 text-blue-500" x-text="'(' + Math.round(hour.avg_instances) + ')'"></span>
                                                </span>
                                            </template>
                                        </div>

                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3">Busiest Days:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="day in capacityForecastData.patterns.busiest_days?.slice(0, 3)" :key="day.day">
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-400">
                                                    <span x-text="day.day"></span>
                                                    <span class="ml-1 text-purple-500" x-text="'(' + Math.round(day.avg_instances) + ')'"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <!-- 7-day forecast preview -->
                                <div class="mt-3">
                                    <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Next 7 Days:</p>
                                    <div class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar">
                                        <template x-for="day in capacityForecastData.forecast?.slice(0, 7)" :key="day.day">
                                            <div class="flex items-center justify-between text-xs py-1">
                                                <span class="text-gray-600 dark:text-gray-400" x-text="day.date"></span>
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-semibold text-gray-900 dark:text-gray-100"
                                                          x-text="day.predicted_instances + ' instances'"></span>
                                                    <span class="px-1 rounded text-xs"
                                                          :class="{
                                                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': day.trend === 'increasing',
                                                              'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': day.trend === 'decreasing',
                                                              'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-400': day.trend === 'stable'
                                                          }"
                                                          x-text="day.trend"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Duration Prediction Tool -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                            <i data-lucide="timer" class="mr-2 h-4 w-4 text-green-600"></i>
                            Process Duration Analysis
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="group relative">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    ML-powered prediction using Random Forest. Trained on historical patterns including time-of-day and day-of-week factors. Shows all processes sorted by longest predicted duration.
                                </span>
                            </span>
                            <button @click="loadAllDurationPredictions()"
                                    :disabled="durationPredictionsLoading"
                                    class="inline-flex items-center px-3 py-1.5 border border-green-300 dark:border-green-600 text-xs font-medium rounded-md text-green-700 dark:text-green-300 bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-900/30 disabled:opacity-50">
                                <i data-lucide="refresh-cw" class="h-3 w-3 mr-1" :class="{ 'animate-spin': durationPredictionsLoading }"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Auto-load on first view -->
                    <template x-if="!durationPredictions && !durationPredictionsLoading && !durationPredictionsLoaded">
                        <div class="text-center py-8">
                            <button @click="loadAllDurationPredictions()"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                <i data-lucide="zap" class="h-4 w-4 mr-2"></i>
                                Analyze All Processes
                            </button>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Click to predict durations for all process definitions</p>
                        </div>
                    </template>

                    <!-- Loading State -->
                    <template x-if="durationPredictionsLoading">
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="loader mb-2"></div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Analyzing process patterns...</p>
                        </div>
                    </template>

                    <!-- Results Table -->
                    <template x-if="durationPredictions && !durationPredictionsLoading">
                        <div class="mt-3">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700/50">
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Process</th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Predicted</th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">P50</th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">P95</th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Confidence</th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Instances</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <template x-for="(pred, index) in durationPredictions.slice(0, 20)" :key="pred.process_key">
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"
                                                    :title="pred.process_key">
                                                    <span class="truncate max-w-xs inline-block" x-text="pred.process_key"></span>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-right">
                                                    <span class="font-bold text-green-600 dark:text-green-400"
                                                          x-text="pred.predicted_duration_ms != null ? formatDuration(pred.predicted_duration_ms) : 'N/A'"></span>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right"
                                                    x-text="pred.percentiles?.p50_ms != null ? formatDuration(pred.percentiles.p50_ms) : '-'"></td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right"
                                                    x-text="pred.percentiles?.p95_ms != null ? formatDuration(pred.percentiles.p95_ms) : '-'"></td>
                                                <td class="px-3 py-2 whitespace-nowrap text-center">
                                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                          :class="{
                                                              'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': pred.confidence_pct >= 80,
                                                              'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400': pred.confidence_pct >= 60 && pred.confidence_pct < 80,
                                                              'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': pred.confidence_pct < 60
                                                          }"
                                                          x-text="pred.confidence_pct ? pred.confidence_pct + '%' : 'N/A'"></span>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-center"
                                                    x-text="pred.instance_count || 0"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <template x-if="durationPredictions.length > 20">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
                                    Showing top 20 of <span x-text="durationPredictions.length"></span> processes
                                </p>
                            </template>
                            <template x-if="durationPredictions.length === 0">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No process predictions available</p>
                            </template>
                        </div>
                    </template>
                </div>
            </div>


            <!-- Anomaly Details Modal -->
            <div x-ref="anomalyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
                 @click.self="$refs.anomalyModal.classList.add('hidden')">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[85vh] overflow-hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
                        <div class="flex items-center">
                            <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-600 dark:text-yellow-400 mr-2"></i>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Performance Anomalies Detected</h3>
                        </div>
                        <button @click="$refs.anomalyModal.classList.add('hidden')"
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[calc(85vh-80px)]">
                        <template x-if="aiData.anomalies.anomalies?.length > 0">
                            <div class="space-y-6">
                                <template x-for="(anomaly, idx) in aiData.anomalies.anomalies" :key="idx">
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                        <!-- Header -->
                                        <div class="p-4 border-l-4"
                                             :class="{
                                                 'bg-red-50 dark:bg-red-900/20 border-l-red-500': anomaly.severity === 'critical',
                                                 'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': anomaly.severity === 'high',
                                                 'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': anomaly.severity === 'medium',
                                                 'bg-blue-50 dark:bg-blue-900/20 border-l-blue-500': anomaly.severity === 'low'
                                             }">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-2">
                                                        <h4 class="text-base font-semibold text-gray-900 dark:text-gray-100"
                                                            x-text="anomaly.process_key"></h4>
                                                        <span class="text-xs px-2 py-1 rounded-full font-semibold uppercase"
                                                              :class="{
                                                                  'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400': anomaly.severity === 'critical',
                                                                  'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400': anomaly.severity === 'high',
                                                                  'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400': anomaly.severity === 'medium',
                                                                  'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400': anomaly.severity === 'low'
                                                              }"
                                                              x-text="anomaly.severity"></span>
                                                    </div>
                                                    <p class="text-sm text-gray-600 dark:text-gray-400" x-text="anomaly.reason"></p>
                                                </div>
                                                <div class="ml-4 text-right">
                                                    <span class="text-2xl font-bold"
                                                          :class="{
                                                              'text-red-600 dark:text-red-400': anomaly.severity === 'critical',
                                                              'text-orange-600 dark:text-orange-400': anomaly.severity === 'high',
                                                              'text-yellow-600 dark:text-yellow-400': anomaly.severity === 'medium',
                                                              'text-blue-600 dark:text-blue-400': anomaly.severity === 'low'
                                                          }"
                                                          x-text="`Z: ${anomaly.z_score?.toFixed(1)}`"></span>
                                                    <p class="text-xs text-gray-500">Z-score</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Metrics Grid -->
                                        <div class="p-4 bg-white dark:bg-gray-800">
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                                <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Current Avg</p>
                                                    <p class="text-lg font-bold text-gray-900 dark:text-gray-100"
                                                       x-text="formatDuration(anomaly.current_avg_ms)"></p>
                                                </div>
                                                <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Expected Avg</p>
                                                    <p class="text-lg font-bold text-gray-900 dark:text-gray-100"
                                                       x-text="formatDuration(anomaly.expected_avg_ms)"></p>
                                                </div>
                                                <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Deviation</p>
                                                    <p class="text-lg font-bold"
                                                       :class="Math.abs(anomaly.deviation_pct) > 50 ? 'text-red-600 dark:text-red-400' : 'text-yellow-600 dark:text-yellow-400'"
                                                       x-text="(anomaly.deviation_pct > 0 ? '+' : '') + anomaly.deviation_pct?.toFixed(0) + '%'"></p>
                                                </div>
                                                <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Max Duration</p>
                                                    <p class="text-lg font-bold text-gray-900 dark:text-gray-100"
                                                       x-text="formatDuration(anomaly.max_duration_ms)"></p>
                                                </div>
                                            </div>

                                            <!-- Additional Stats -->
                                            <div class="grid grid-cols-3 gap-4 mb-4">
                                                <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400">Instances</p>
                                                    <p class="text-sm font-semibold text-gray-900 dark:text-gray-100" x-text="anomaly.instances_analyzed"></p>
                                                </div>
                                                <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400">P95</p>
                                                    <p class="text-sm font-semibold text-gray-900 dark:text-gray-100" x-text="formatDuration(anomaly.p95_ms)"></p>
                                                </div>
                                                <div class="text-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                                    <p class="text-xs text-gray-600 dark:text-gray-400">Stability</p>
                                                    <p class="text-sm font-semibold text-gray-900 dark:text-gray-100" x-text="anomaly.stability || 'N/A'"></p>
                                                </div>
                                            </div>

                                            <!-- Recommendation -->
                                            <template x-if="anomaly.recommendation">
                                                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                                    <p class="text-sm text-blue-700 dark:text-blue-300">
                                                        <i data-lucide="lightbulb" class="inline h-4 w-4 mr-1"></i>
                                                        <strong>Recommendation:</strong> <span x-text="anomaly.recommendation"></span>
                                                    </p>
                                                </div>
                                            </template>

                                            <!-- Sample Instances -->
                                            <template x-if="anomaly.sample_instances && anomaly.sample_instances.length > 0">
                                                <div>
                                                    <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                                        Slowest Instances (<span x-text="anomaly.sample_instances.length"></span>)
                                                    </h5>
                                                    <div class="space-y-3">
                                                        <template x-for="(sample, sIdx) in anomaly.sample_instances" :key="sample.instance_id">
                                                            <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                                                <div class="flex items-center justify-between mb-2">
                                                                    <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">
                                                                        Instance #<span x-text="sIdx + 1"></span>
                                                                    </span>
                                                                    <div class="flex items-center gap-2">
                                                                        <span class="text-sm font-bold"
                                                                              :class="sample.is_slow ? 'text-red-600 dark:text-red-400' : 'text-yellow-600 dark:text-yellow-400'"
                                                                              x-text="formatDuration(sample.duration_ms)"></span>
                                                                        <template x-if="sample.is_slow">
                                                                            <span class="text-xs px-2 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-full">
                                                                                >P95
                                                                            </span>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                                <div class="space-y-2">
                                                                    <div>
                                                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Instance ID</p>
                                                                        <div class="flex items-center gap-2">
                                                                            <code class="text-xs font-mono text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-800 px-2 py-1 rounded border border-gray-300 dark:border-gray-600 flex-1 break-all select-all"
                                                                                  x-text="sample.instance_id"></code>
                                                                            <button @click="navigator.clipboard.writeText(sample.instance_id)"
                                                                                    class="p-1.5 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors flex-shrink-0"
                                                                                    title="Copy to clipboard">
                                                                                <i data-lucide="copy" class="h-4 w-4"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <template x-if="sample.business_key && sample.business_key !== 'N/A'">
                                                                        <div>
                                                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Business Key</p>
                                                                            <div class="flex items-center gap-2">
                                                                                <code class="text-xs font-mono text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-800 px-2 py-1 rounded border border-gray-300 dark:border-gray-600 flex-1 break-all select-all"
                                                                                      x-text="sample.business_key"></code>
                                                                                <button @click="navigator.clipboard.writeText(sample.business_key)"
                                                                                        class="p-1.5 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors flex-shrink-0"
                                                                                        title="Copy to clipboard">
                                                                                    <i data-lucide="copy" class="h-4 w-4"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </template>
                                                                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 pt-1">
                                                                        <template x-if="sample.start_time">
                                                                            <span>Started: <span x-text="new Date(sample.start_time).toLocaleString()"></span></span>
                                                                        </template>
                                                                        <template x-if="sample.end_time">
                                                                            <span>Ended: <span x-text="new Date(sample.end_time).toLocaleString()"></span></span>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!aiData.anomalies.anomalies?.length">
                            <div class="text-center py-8">
                                <i data-lucide="check-circle" class="h-12 w-12 text-green-500 mx-auto mb-2"></i>
                                <p class="text-gray-600 dark:text-gray-400">All processes are operating within normal parameters</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Incident Details Modal -->
            <div x-ref="incidentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
                 @click.self="$refs.incidentModal.classList.add('hidden')">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[85vh] overflow-hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
                        <div class="flex items-center flex-1">
                            <i data-lucide="alert-circle" class="h-5 w-5 text-orange-600 dark:text-orange-400 mr-2"></i>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100" x-text="selectedIncident?.incident_type || 'Incident Details'"></h3>
                            <template x-if="selectedIncident?.root_cause">
                                <span class="ml-3 text-xs px-2 py-1 bg-orange-200 dark:bg-orange-800 text-orange-900 dark:text-orange-200 rounded"
                                      x-text="selectedIncident.root_cause"></span>
                            </template>
                        </div>
                        <button @click="$refs.incidentModal.classList.add('hidden')"
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[calc(85vh-80px)]">
                        <template x-if="selectedIncident">
                            <div class="space-y-6">
                                <!-- Error Message -->
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Error Message</h4>
                                    <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                        <p class="text-sm text-gray-900 dark:text-gray-100 font-mono break-words" x-text="selectedIncident.error_message"></p>
                                    </div>
                                </div>

                                <!-- Statistics Grid -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg border border-orange-200 dark:border-orange-700">
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Total Occurrences</p>
                                        <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" x-text="selectedIncident.occurrence_count"></p>
                                    </div>
                                    <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-700">
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Open</p>
                                        <p class="text-2xl font-bold text-red-600 dark:text-red-400" x-text="selectedIncident.open_count || 0"></p>
                                    </div>
                                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-700">
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Resolved</p>
                                        <p class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="selectedIncident.resolved_count || 0"></p>
                                    </div>
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Avg Resolution</p>
                                        <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" x-text="(selectedIncident.avg_duration_hours || 0).toFixed(1) + 'h'"></p>
                                    </div>
                                </div>

                                <!-- Timeline Info -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">First Seen</h4>
                                        <p class="text-sm text-gray-900 dark:text-gray-100">
                                            <template x-if="selectedIncident.first_seen">
                                                <span x-text="new Date(selectedIncident.first_seen).toLocaleString()"></span>
                                            </template>
                                            <template x-if="!selectedIncident.first_seen">
                                                <span class="text-gray-400">Not available</span>
                                            </template>
                                        </p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Last Seen</h4>
                                        <p class="text-sm text-gray-900 dark:text-gray-100">
                                            <template x-if="selectedIncident.last_seen">
                                                <span x-text="new Date(selectedIncident.last_seen).toLocaleString()"></span>
                                            </template>
                                            <template x-if="!selectedIncident.last_seen">
                                                <span class="text-gray-400">Not available</span>
                                            </template>
                                        </p>
                                    </div>
                                </div>

                                <!-- Affected Processes & Activities -->
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Affected Scope</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Processes (<span x-text="selectedIncident.affected_processes?.length || 0"></span>)</p>
                                            <div class="flex flex-wrap gap-1">
                                                <template x-for="proc in selectedIncident.affected_processes" :key="proc">
                                                    <span class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded" x-text="proc"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <template x-if="selectedIncident.affected_activities?.length > 0">
                                            <div>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Activities (<span x-text="selectedIncident.affected_activities.length"></span>)</p>
                                                <div class="flex flex-wrap gap-1">
                                                    <template x-for="act in selectedIncident.affected_activities" :key="act">
                                                        <span class="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded" x-text="act"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Sample Instances -->
                                <template x-if="selectedIncident.sample_instances && selectedIncident.sample_instances.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                            Sample Instances (<span x-text="selectedIncident.sample_instances.length"></span>)
                                        </h4>
                                        <div class="space-y-3">
                                            <template x-for="(sample, idx) in selectedIncident.sample_instances" :key="sample.instance_id">
                                                <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                                    <div class="flex items-start justify-between mb-3">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">Instance #<span x-text="idx + 1"></span></span>
                                                            <span class="px-2 py-0.5 rounded text-xs font-medium"
                                                                  :class="sample.status === 'open' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'"
                                                                  x-text="sample.status"></span>
                                                        </div>
                                                        <template x-if="sample.create_time">
                                                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                                                <span x-text="new Date(sample.create_time).toLocaleString()"></span>
                                                            </p>
                                                        </template>
                                                    </div>
                                                    <div class="space-y-3">
                                                        <div>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1.5">Instance ID</p>
                                                            <div class="flex items-center gap-2">
                                                                <code class="text-sm font-mono text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-800 px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 flex-1 break-all select-all"
                                                                      x-text="sample.instance_id"></code>
                                                                <button @click="navigator.clipboard.writeText(sample.instance_id)"
                                                                        class="p-1.5 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors flex-shrink-0"
                                                                        title="Copy to clipboard">
                                                                    <i data-lucide="copy" class="h-4 w-4"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <template x-if="sample.business_key && sample.business_key !== 'N/A'">
                                                            <div>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-1.5">Business Key</p>
                                                                <div class="flex items-center gap-2">
                                                                    <code class="text-sm font-mono text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-800 px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 flex-1 break-all select-all"
                                                                          x-text="sample.business_key"></code>
                                                                    <button @click="navigator.clipboard.writeText(sample.business_key)"
                                                                            class="p-1.5 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors flex-shrink-0"
                                                                            title="Copy to clipboard">
                                                                        <i data-lucide="copy" class="h-4 w-4"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

        </div>
    </template>

</div>  <!-- End of AI Intelligence Layer -->
{% endblock %}

{% block extra_scripts %}
<script>
    function aiAnalyticsMonitor() {
        return {
            ...baseMonitor(),

            // AI/ML states
            aiLoading: false,
            aiData: null,
            aiError: null,
            lastUpdate: new Date().toISOString(),
            selectedIncident: null,

            // Advanced ML features states
            stuckActivitiesData: null,
            stuckActivitiesLoading: false,
            capacityForecastData: null,
            capacityForecastLoading: false,
            durationPredictions: null,
            durationPredictionsLoading: false,
            durationPredictionsLoaded: false,

            init() {
                // Initialize base monitor
                this.darkMode = localStorage.getItem('darkMode') === 'true';
                this.applyDarkMode();

                // Auto-load AI insights on page load
                this.loadAIInsights();

                this.$nextTick(() => lucide.createIcons());
            },

            async refreshData() {
                // Refresh AI insights
                await this.refreshAIInsights();
            },

            // AI Insights loading
            async loadAIInsights() {
                if (this.aiLoading || this.aiData) return;

                this.aiLoading = true;
                this.aiError = null;

                try {
                    const response = await fetch('/api/ai/insights');
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    this.aiData = data;
                    this.lastUpdate = data.timestamp || new Date().toISOString();
                } catch (error) {
                    console.error('Error loading AI insights:', error);
                    this.aiError = error.message;
                } finally {
                    this.aiLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async refreshAIInsights() {
                this.aiData = null;
                this.aiLoading = false;
                await this.loadAIInsights();
            },

            // Advanced ML Features
            loadAdvancedMLFeatures() {
                // This method is called when the advanced features section becomes visible
                // Features are loaded on-demand when user clicks their respective buttons
                console.log('Advanced ML features section visible - ready for on-demand loading');
            },

            async loadStuckActivities() {
                if (this.stuckActivitiesLoading) return;

                this.stuckActivitiesLoading = true;
                try {
                    const response = await fetch('/api/ai/stuck-activities-smart');
                    if (response.ok) {
                        this.stuckActivitiesData = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading stuck activities:', error);
                } finally {
                    this.stuckActivitiesLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async loadCapacityForecast() {
                if (this.capacityForecastLoading) return;

                this.capacityForecastLoading = true;
                try {
                    const response = await fetch('/api/ai/capacity-forecast');
                    if (response.ok) {
                        this.capacityForecastData = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading capacity forecast:', error);
                } finally {
                    this.capacityForecastLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async loadAllDurationPredictions() {
                if (this.durationPredictionsLoading) return;

                this.durationPredictionsLoading = true;
                this.durationPredictionsLoaded = true;
                try {
                    const response = await fetch('/api/ai/predict-all-durations');
                    if (response.ok) {
                        const data = await response.json();
                        // Sort by predicted duration (longest first), treating null as 0
                        this.durationPredictions = (data.predictions || []).sort((a, b) => {
                            const aDuration = a.predicted_duration_ms != null ? a.predicted_duration_ms : 0;
                            const bDuration = b.predicted_duration_ms != null ? b.predicted_duration_ms : 0;
                            return bDuration - aDuration;
                        });
                    }
                } catch (error) {
                    console.error('Error loading all duration predictions:', error);
                } finally {
                    this.durationPredictionsLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            }
        };
    }
</script>
{% endblock %}



