{% extends "base.html" %}

{% block title %}AI Analysis - Camunda Health Monitor{% endblock %}

{% block alpine_data %}aiAnalyticsMonitor(){% endblock %}

{% block header_info %}
    <div class="text-sm text-gray-500 dark:text-gray-400">
        Last updated: <span class="font-medium text-gray-700 dark:text-gray-300"
                            x-text="formatTime(lastUpdate)"></span>
    </div>
{% endblock %}

{% block mobile_menu_extra %}
    <div class="flex items-center justify-between text-base text-gray-900 dark:text-gray-100">
        <span>Last updated:</span>
        <span class="font-medium" x-text="formatTime(lastUpdate)"></span>
    </div>
{% endblock %}

{% block content %}
    <!-- AI Intelligence Layer -->
    <div class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50 dark:from-sky-900/20 dark:via-cyan-900/20 dark:to-blue-900/20 rounded-xl p-6 mb-6 border-2 border-sky-200 dark:border-sky-800 shadow-lg">

        <!-- Header - Always Visible -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <i data-lucide="brain" class="h-7 w-7 text-sky-600 dark:text-sky-400"></i>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                    AI Intelligence Layer
                </h2>
                <span class="ml-2 text-xs px-3 py-1 bg-sky-600 text-white rounded-full">POWERED BY ML</span>
            </div>
            <button @click="refreshAIInsights()"
                    :disabled="aiLoading"
                    class="inline-flex items-center px-4 py-2 border border-sky-300 dark:border-sky-600 shadow-sm text-sm font-medium rounded-md text-sky-700 dark:text-sky-300 bg-white dark:bg-gray-800 hover:bg-sky-50 dark:hover:bg-sky-900/30 disabled:opacity-50">
                <i data-lucide="refresh-cw" class="h-4 w-4 mr-2" :class="{ 'animate-spin': aiLoading }"></i>
                Refresh AI
            </button>
        </div>

        <!-- AI Content - Lazy load when scrolled into view -->
        <div x-intersect.once="!aiData && !aiLoading && loadAIInsights()">

            <!-- Loading State for AI Insights -->
            <template x-if="aiLoading && !aiData">
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">AI analyzing the Camunda cluster...</p>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="aiError && !aiData">
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                    <p class="text-red-700 dark:text-red-300 mb-2">Failed to load AI insights</p>
                    <button @click="refreshAIInsights()" class="text-sm text-red-600 dark:text-red-400 underline">Try Again
                    </button>
                </div>
            </template>

            <!-- AI Content - Core metrics using aiData -->
            <template x-if="aiData">
            <div>
                <!-- Health Scores Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <!-- Cluster Health Score -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg border-l-4"
                         :class="aiData.health_score.overall_score >= 80 ? 'border-l-green-500' : aiData.health_score.overall_score >= 60 ? 'border-l-yellow-500' : 'border-l-red-500'">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Cluster Health</span>
                            <i data-lucide="activity" class="h-5 w-5 text-sky-600 dark:text-sky-400"></i>
                        </div>
                        <div class="flex items-baseline space-x-2 mb-2">
                        <span class="text-5xl font-bold"
                              :class="aiData.health_score.overall_score >= 80 ? 'text-green-600 dark:text-green-400' : aiData.health_score.overall_score >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'"
                              x-text="aiData.health_score.overall_score"></span>
                            <span class="text-2xl text-gray-500">/100</span>
                        </div>
                        <p class="text-xs font-semibold mb-1"
                           :class="aiData.health_score.overall_score >= 80 ? 'text-green-600' : aiData.health_score.overall_score >= 60 ? 'text-yellow-600' : 'text-red-600'"
                           x-text="aiData.health_score.grade"></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="aiData.health_score.factors"></p>
                    </div>

                    <!-- Anomalies Detected -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg cursor-pointer hover:shadow-xl transition-shadow"
                         @click="$refs.anomalyModal.classList.toggle('hidden'); $nextTick(() => lucide.createIcons())"
                         :class="(aiData.anomalies.anomalies?.length || 0) > 0 ? 'border-l-4 border-l-yellow-500' : ''">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Anomalies</span>
                            <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <div class="text-4xl font-bold text-yellow-600 dark:text-yellow-400 mb-2"
                             x-text="aiData.anomalies.anomalies?.length || 0"></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            <template x-if="(aiData.anomalies.anomalies?.length || 0) > 0">
                                <span>Statistical outliers detected</span>
                            </template>
                            <template x-if="(aiData.anomalies.anomalies?.length || 0) === 0">
                                <span>All processes normal</span>
                            </template>
                        </p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1"
                           x-text="`Analyzed ${aiData.anomalies.total_analyzed || 0} processes`"></p>
                        <template x-if="(aiData.anomalies.anomalies?.length || 0) > 0">
                            <div class="mt-3 text-xs text-yellow-600 dark:text-yellow-400 font-medium flex items-center">
                                <span>Click to view details</span>
                                <i data-lucide="chevron-right" class="h-3 w-3 ml-1"></i>
                            </div>
                        </template>
                    </div>

                    <!-- SLA Risks -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">SLA Risks</span>
                            <i data-lucide="clock" class="h-5 w-5 text-red-600 dark:text-red-400"></i>
                        </div>
                        <div class="text-4xl font-bold text-red-600 dark:text-red-400 mb-2"
                             x-text="aiData.sla_predictions.at_risk_tasks?.length || 0"></div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            Tasks likely to breach SLA
                        </p>
                        <template x-if="aiData.sla_predictions.at_risk_tasks?.length > 0">
                            <p class="text-xs font-semibold text-red-600 dark:text-red-400 mt-1">
                                Action required!
                            </p>
                        </template>
                    </div>

                    <!-- Top Bottleneck Impact -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Top Bottleneck</span>
                            <i data-lucide="trending-down" class="h-5 w-5 text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <template x-if="aiData.bottlenecks.bottlenecks?.length > 0">
                            <div>
                                <div class="text-4xl font-bold text-orange-600 dark:text-orange-400 mb-2"
                                     x-text="aiData.bottlenecks.bottlenecks[0].impact_hours_per_week + 'h'"></div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    Wasted per week
                                </p>
                                <p class="text-xs text-gray-700 dark:text-gray-300 mt-1 truncate"
                                   :title="aiData.bottlenecks.bottlenecks[0].activity_name"
                                   x-text="aiData.bottlenecks.bottlenecks[0].activity_name"></p>
                            </div>
                        </template>
                        <template x-if="!aiData.bottlenecks.bottlenecks?.length">
                            <div>
                                <div class="text-4xl font-bold text-green-600 dark:text-green-400 mb-2">‚úì</div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">No bottlenecks detected</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- AI Recommendations -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                        <i data-lucide="lightbulb" class="mr-2 h-5 w-5 text-blue-600 dark:text-blue-400"></i>
                        AI Recommendations
                    </h4>
                    <div class="space-y-2">
                        <template x-for="(rec, index) in aiData.recommendations" :key="index">
                            <div class="flex items-start p-3 bg-white dark:bg-gray-800 rounded-lg border-l-4"
                                 :class="{
                                 'border-l-red-500': rec.priority === 'critical',
                                 'border-l-orange-500': rec.priority === 'high',
                                 'border-l-yellow-500': rec.priority === 'medium',
                                 'border-l-blue-500': rec.priority === 'low'
                             }">
                                <div class="flex-shrink-0 mr-3">
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold"
                                      :class="{
                                          'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': rec.priority === 'critical',
                                          'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': rec.priority === 'high',
                                          'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': rec.priority === 'medium',
                                          'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': rec.priority === 'low'
                                      }"
                                      x-text="rec.priority.toUpperCase()"></span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-700 dark:text-gray-300 font-medium mb-1"
                                       x-text="rec.message"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        <span class="font-semibold">Action:</span> <span x-text="rec.action"></span>
                                    </p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Detailed Insights Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Process Anomalies -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="alert-triangle" class="mr-2 h-4 w-4 text-yellow-600"></i>
                                <span>Process Execution Anomalies</span>
                                <span class="group relative ml-2">
                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                    ML-powered detection of processes running significantly slower than baseline. Uses statistical analysis (Z-score) and compares recent performance to historical averages. Shows sample slow instances with business keys.
                </span>
            </span>
                            </div>
                            <span class="text-xs text-gray-500"
                                  x-text="`Last ${aiData.anomalies.detection_window_days || 7} days`"></span>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.anomalies.anomalies?.length > 0">
                                <template
                                        x-for="anomaly in aiData.anomalies.anomalies.slice(0, config.aiDisplayLimits.rows_limit)"
                                        :key="anomaly.process_key">
                                    <div class="flex items-center justify-between py-2 px-3 rounded border-l-4 cursor-pointer hover:shadow-md transition-shadow"
                                         @click="selectedAnomaly = anomaly; $refs.anomalyModal.classList.remove('hidden'); $nextTick(() => lucide.createIcons())"
                                         :class="{
                         'bg-red-50 dark:bg-red-900/20 border-l-red-600': anomaly.severity === 'critical',
                         'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': anomaly.severity === 'high',
                         'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': anomaly.severity === 'medium',
                         'bg-blue-50 dark:bg-blue-900/20 border-l-blue-500': anomaly.severity === 'low'
                     }">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                                   :title="anomaly.process_key"
                                                   x-text="anomaly.process_key"></p>
                                                <span class="text-xs px-2 py-0.5 rounded-full font-semibold uppercase"
                                                      :class="{
                                      'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400': anomaly.severity === 'critical',
                                      'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400': anomaly.severity === 'high',
                                      'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400': anomaly.severity === 'medium',
                                      'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400': anomaly.severity === 'low'
                                  }"
                                                      x-text="anomaly.severity"></span>
                                                <!-- NEW: Show if has sample instances -->
                                                <template
                                                        x-if="anomaly.sample_instances && anomaly.sample_instances.length > 0">
                                <span class="text-xs px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded">
                                    <span x-text="anomaly.sample_instances.length"></span> samples
                                </span>
                                                </template>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">
                                                Expected: <span x-text="formatDuration(anomaly.expected_avg_ms)"></span>
                                                ‚Üí
                                                Current: <span x-text="formatDuration(anomaly.current_avg_ms)"></span>

                                                <template
                                                        x-if="anomaly.max_duration_ms && anomaly.max_duration_ms > 3600000">
                                                <span class="text-xs text-red-600 dark:text-red-400 mt-1">
                                                    ‚ö†Ô∏è Max: <span
                                                        x-text="formatDuration(anomaly.max_duration_ms)"></span>
                                                </span>
                                                </template>
                                            </p>
                                            <template x-if="anomaly.anomaly_types?.includes('extreme_duration')">
                                                <p class="text-xs text-red-600 dark:text-red-400 mt-1">
                                                    üî¥ Potential stuck/hanging process detected
                                                </p>
                                            </template>
                                            <!-- NEW: Click hint -->
                                            <p class="text-xs text-blue-600 dark:text-blue-400 font-medium mt-1">
                                                Click for sample instances ‚Üí
                                            </p>
                                        </div>
                                        <div class="ml-2 text-right">
                        <span class="text-sm font-bold"
                              :class="anomaly.deviation_pct > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"
                              x-text="(anomaly.deviation_pct > 0 ? '+' : '') + anomaly.deviation_pct + '%'"></span>
                                            <template x-if="anomaly.z_score > 0">
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    Z: <span x-text="anomaly.z_score"></span>
                                                </p>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.anomalies.anomalies?.length">
                                <div class="text-center py-8">
                                    <template x-if="aiData.anomalies.health_status === 'excellent'">
                                        <div>
                                            <i data-lucide="check-circle"
                                               class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">Stable
                                                Performance!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 px-4"
                                               x-text="aiData.anomalies.message || 'All processes executing consistently'"></p>
                                        </div>
                                    </template>
                                    <template x-if="aiData.anomalies.health_status !== 'excellent'">
                                        <p class="text-sm text-gray-500 dark:text-gray-400"
                                           x-text="aiData.anomalies.message || 'No anomalies detected'"></p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Incident Patterns -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="alert-circle" class="mr-2 h-4 w-4 text-orange-600"></i>
                                <span>Top Incident Patterns</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Analyzes historical incident data or runtime job failures to identify recurring error patterns. Groups by error type and frequency to help prioritize fixes.
                                </span>
                            </span>
                            </div>
                            <span class="text-xs text-gray-500"
                                  x-text="`${aiData.incidents.unique_patterns || 0} unique patterns`"></span>
                        </div>

                        <!-- Data source warning if from runtime jobs -->
                        <template x-if="aiData.incidents.data_source === 'runtime_jobs'">
                            <div class="mb-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-xs">
                                <i data-lucide="info" class="h-3 w-3 inline mr-1"></i>
                                <span class="text-yellow-700 dark:text-yellow-300">Analyzing active job exceptions (incident history not logged)</span>
                            </div>
                        </template>

                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.incidents.patterns?.length > 0">
                                <div>
                                    <!-- Root Cause Categories Summary (compact) -->
                                    <template
                                            x-if="aiData.incidents.root_cause_categories && Object.keys(aiData.incidents.root_cause_categories).length > 0">
                                        <div class="mb-3 p-3 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                                            <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Root
                                                Cause
                                                Breakdown</p>
                                            <div class="flex flex-wrap gap-2">
                                                <template
                                                        x-for="[category, count] in Object.entries(aiData.incidents.root_cause_categories).sort((a,b) => b[1] - a[1]).slice(0, 5)"
                                                        :key="category">
                                                <span class="inline-flex items-center text-xs px-2 py-1 bg-white dark:bg-gray-800 rounded-full border border-orange-300 dark:border-orange-700">
                                                    <span class="font-medium text-gray-900 dark:text-gray-100"
                                                          x-text="category"></span>
                                                    <span class="ml-1 text-orange-600 dark:text-orange-400 font-bold"
                                                          x-text="count"></span>
                                                </span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>

                                    <template
                                            x-for="(pattern,index) in aiData.incidents.patterns.slice(0, config.aiDisplayLimits.rows_limit)"
                                            :key="pattern.incident_type + index">
                                        <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded border-l-2 border-l-orange-500 cursor-pointer hover:shadow-md transition-shadow mt-2"
                                             @click="selectedIncident = pattern; $refs.incidentModal.classList.remove('hidden'); $nextTick(() => lucide.createIcons())">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100"
                                                           x-text="pattern.incident_type"></p>
                                                        <template x-if="pattern.root_cause">
                                                    <span class="text-xs px-2 py-0.5 bg-orange-200 dark:bg-orange-800 text-orange-900 dark:text-orange-200 rounded"
                                                          x-text="pattern.root_cause"></span>
                                                        </template>
                                                    </div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1 line-clamp-2"
                                                       :title="pattern.error_message"
                                                       x-text="pattern.error_message"></p>
                                                </div>
                                                <span class="text-xs px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-full font-semibold ml-2"
                                                      x-text="pattern.occurrence_count + 'x'"></span>
                                            </div>

                                            <!-- Status and Metrics Row -->
                                            <div class="grid grid-cols-3 gap-2 mb-2 text-xs">
                                                <div class="text-center p-1 bg-white dark:bg-gray-700/50 rounded">
                                                    <div class="text-gray-500 dark:text-gray-400">Open
                                                    <span class="font-semibold text-red-600 dark:text-red-400"
                                                         x-text="pattern.open_count || 0"></span>
                                                        </div>
                                                </div>
                                                <div class="text-center p-1 bg-white dark:bg-gray-700/50 rounded">
                                                    <div class="text-gray-500 dark:text-gray-400">Resolved
                                                    <span class="font-semibold text-green-600 dark:text-green-400"
                                                         x-text="pattern.resolved_count || 0"></span>
                                                        </div>
                                                </div>
                                                <div class="text-center p-1 bg-white dark:bg-gray-700/50 rounded">
                                                    <div class="text-gray-500 dark:text-gray-400">Avg Time
                                                    <span class="font-semibold text-gray-900 dark:text-gray-100"
                                                         x-text="(pattern.avg_duration_hours || 0).toFixed(1) + 'h'"></span>
                                                        </div>
                                                </div>
                                            </div>

                                            <!-- Affected Details -->
                                            <div class="text-xs text-gray-500 dark:text-gray-500">
                                                <template x-if="pattern.source === 'runtime_jobs'">
                                            <span>
                                                <span x-text="pattern.retries_exhausted || 0"></span> with no retries ¬∑
                                                <span x-text="pattern.affected_processes?.length || 0"></span> instance(s)
                                            </span>
                                                </template>
                                                <template x-if="pattern.source !== 'runtime_jobs'">
                                            <span>
                                                <span x-text="(pattern.frequency_per_day || 0).toFixed(1)"></span>/day ¬∑
                                                <span x-text="pattern.affected_processes?.length || 0"></span> process(es)
                                                <template x-if="pattern.affected_activities?.length > 0">
                                                    ¬∑ <span x-text="pattern.affected_activities.length"></span> activity/activities
                                                </template>
                                                <template
                                                        x-if="pattern.sample_instances && pattern.sample_instances.length > 0">
                                                    <span class="ml-2 text-blue-600 dark:text-blue-400 font-medium">¬∑ Click for details ‚Üí</span>
                                                </template>
                                            </span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!aiData.incidents.patterns?.length">
                                <div class="text-center py-8">
                                    <template x-if="aiData.incidents.health_status === 'excellent'">
                                        <div>
                                            <i data-lucide="check-circle"
                                               class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">System
                                                Healthy!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                                               x-text="aiData.incidents.message || 'No incidents detected'"></p>
                                        </div>
                                    </template>
                                    <template x-if="aiData.incidents.health_status !== 'excellent'">
                                        <p class="text-sm text-gray-500 dark:text-gray-400"
                                           x-text="aiData.incidents.message || 'No incident patterns found'"></p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Process Bottlenecks -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="trending-down" class="mr-2 h-4 w-4 text-red-600"></i>
                                <span>Top Process Bottlenecks</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Identifies activities with longest execution times using P95 percentile analysis. Shows potential optimization targets and estimated time savings per week.
                                </span>
                            </span>
                            </div>
                            <span class="text-xs text-gray-500"
                                  x-text="`${aiData.bottlenecks.total_activities_analyzed || 0} activities`"></span>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.bottlenecks.bottlenecks?.length > 0">
                                <template
                                        x-for="(bottleneck, index) in aiData.bottlenecks.bottlenecks.slice(0, config.aiDisplayLimits.rows_limit)"
                                        :key="bottleneck.activity_id + index">
                                    <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded border-l-2 border-l-red-500">
                                        <div class="flex items-start justify-between mb-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                               :title="bottleneck.activity_name"
                                               x-text="bottleneck.activity_name"></p>
                                            <span class="text-sm font-bold text-red-600 dark:text-red-400 ml-2"
                                                  x-text="bottleneck.impact_hours_per_week + 'h/wk'"></span>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                            Avg: <span x-text="formatDuration(bottleneck.avg_duration_ms)"></span> ¬∑
                                            P95: <span x-text="formatDuration(bottleneck.p95_duration_ms)"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500"
                                           x-text="`${bottleneck.executions} executions in ${bottleneck.process_key}`"></p>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.bottlenecks.bottlenecks?.length">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No significant
                                    bottlenecks
                                    detected</p>
                            </template>
                        </div>
                    </div>

                    <!-- Job Failure Predictions -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="zap" class="mr-2 h-4 w-4 text-purple-600"></i>
                                <span>Job Failure Predictions</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Predicts which job types are at risk of failure based on historical failure rates. Helps prioritize preventive maintenance and error handling improvements.
                                </span>
                            </span>
                            </div>
                            <span class="text-xs text-gray-500"
                                  x-text="`${aiData.job_failures.total_jobs_analyzed || 0} job types`"></span>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.job_failures.predictions?.length > 0">
                                <div>
                                    <!-- All Healthy Banner (when total_failures is 0) -->
                                    <template
                                            x-if="aiData.job_failures.all_healthy || aiData.job_failures.total_failures === 0">
                                        <div class="mb-3 p-2 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded border border-green-200 dark:border-green-800">
                                            <div class="flex items-center text-xs">
                                                <i data-lucide="check-circle"
                                                   class="inline h-4 w-4 mr-2 text-green-600 dark:text-green-400"></i>
                                                <span class="font-semibold text-green-700 dark:text-green-300">
                                            All job types executing successfully!
                                        </span>
                                            </div>
                                            <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                Showing top <span
                                                    x-text="aiData.job_failures.predictions.length"></span> job
                                                types by volume
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Failure Summary Bar (compact) - Only show if failures exist -->
                                    <template x-if="aiData.job_failures.total_failures > 0">
                                        <div class="mb-3 p-2 bg-gradient-to-r from-purple-50 to-red-50 dark:from-purple-900/20 dark:to-red-900/20 rounded border border-purple-200 dark:border-purple-800">
                                            <div class="flex items-center justify-between text-xs">
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">
                                            <i data-lucide="alert-circle" class="inline h-3 w-3 mr-1"></i>
                                            <span x-text="aiData.job_failures.total_failures"></span> total failures
                                        </span>
                                                <span class="text-gray-500 dark:text-gray-400"
                                                      x-text="`${((aiData.job_failures.total_failures / aiData.job_failures.total_executions * 100) || 0).toFixed(1)}% failure rate`"></span>
                                            </div>
                                        </div>
                                    </template>

                                    <template
                                            x-for="(pred, index) in aiData.job_failures.predictions.slice(0, config.aiDisplayLimits.rows_limit)"
                                            :key="pred.job_type + index">
                                        <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded border-l-2 mt-2"
                                             :class="{
                                         'border-l-red-500': pred.risk_level === 'high' && pred.failed_count > 0,
                                         'border-l-yellow-500': pred.risk_level === 'medium' && pred.failed_count > 0,
                                         'border-l-green-500': pred.risk_level === 'low' || pred.failed_count === 0
                                     }">
                                            <div class="flex items-start justify-between mb-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                                   :title="pred.job_type"
                                                   x-text="pred.job_type"></p>
                                                <span class="text-sm font-bold ml-2"
                                                      :class="{
                                                  'text-red-600 dark:text-red-400': pred.risk_level === 'high' && pred.failed_count > 0,
                                                  'text-yellow-600 dark:text-yellow-400': pred.risk_level === 'medium' && pred.failed_count > 0,
                                                  'text-green-600 dark:text-green-400': pred.risk_level === 'low' || pred.failed_count === 0
                                              }"
                                                      x-text="pred.failure_rate_pct + '%'"></span>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                                <template x-if="pred.failed_count > 0">
                                            <span>
                                                <span x-text="pred.failed_count"></span> failed /
                                                <span x-text="pred.total_executions"></span> total executions
                                            </span>
                                                </template>
                                                <template x-if="pred.failed_count === 0">
                                            <span>
                                                <span x-text="pred.total_executions"></span> executions - all successful ‚úì
                                            </span>
                                                </template>
                                            </p>
                                            <template x-if="pred.failed_count > 0">
                                                <p class="text-xs text-gray-500 dark:text-gray-500"
                                                   x-text="pred.recommendation"></p>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!aiData.job_failures.predictions?.length">
                                <div class="text-center py-8">
                                    <template x-if="aiData.job_failures.data_source === 'none'">
                                        <div>
                                            <i data-lucide="info"
                                               class="h-12 w-12 text-blue-500 dark:text-blue-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Job
                                                History Not
                                                Available</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 px-4"
                                               x-text="aiData.job_failures.message || 'Job logging may be disabled or processes use sync execution'"></p>
                                        </div>
                                    </template>
                                    <template x-if="aiData.job_failures.data_source !== 'none'">
                                        <div>
                                            <i data-lucide="check-circle"
                                               class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">All Jobs
                                                Healthy!</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                                               x-text="aiData.job_failures.message || 'All jobs executing successfully'"></p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Node Performance Rankings & Process Leaderboard -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Node Performance Rankings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                            <i data-lucide="award" class="mr-2 h-4 w-4 text-indigo-600"></i>
                            <span>Node Performance Rankings</span>
                            <span class="group relative ml-2">
                            <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                            <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                Ranks cluster nodes based on JVM health metrics (CPU, memory, GC efficiency). Helps identify underperforming nodes that may need attention.
                            </span>
                        </span>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.node_performance.rankings?.length > 0">
                                <template x-for="node in aiData.node_performance.rankings" :key="node.node_name">
                                    <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm mr-3"
                                             :class="{
                                             'bg-yellow-400 text-yellow-900': node.rank === 1,
                                             'bg-gray-300 text-gray-700': node.rank === 2,
                                             'bg-orange-300 text-orange-900': node.rank === 3,
                                             'bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-200': node.rank > 3
                                         }"
                                             x-text="node.rank"></div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100"
                                               x-text="node.node_name"></p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400"
                                               x-text="node.recommendation"></p>
                                        </div>
                                        <div class="ml-2 text-right">
                                        <span class="text-lg font-bold"
                                              :class="{
                                                  'text-green-600 dark:text-green-400': node.performance_score >= 80,
                                                  'text-yellow-600 dark:text-yellow-400': node.performance_score >= 60 && node.performance_score < 80,
                                                  'text-red-600 dark:text-red-400': node.performance_score < 60
                                              }"
                                              x-text="node.performance_score"></span>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.node_performance.rankings?.length">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Need at least 2
                                    nodes for
                                    comparison</p>
                            </template>
                        </div>
                    </div>

                    <!-- Process Performance Leaderboard -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="trophy" class="mr-2 h-4 w-4 text-yellow-600"></i>
                                <span>Process Performance Leaderboard</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Ranks processes by performance grade (A-F) based on completion rate, average duration, and consistency. Shows best and worst performing processes.
                                </span>
                            </span>
                            </div>
                            <span class="text-xs text-gray-500"
                                  x-text="`${aiData.process_leaderboard.total_processes || 0} processes`"></span>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="aiData.process_leaderboard.leaderboard?.length > 0">
                                <template
                                        x-for="proc in aiData.process_leaderboard.leaderboard.slice(0, config.aiDisplayLimits.rows_limit)"
                                        :key="proc.process_key">
                                    <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                        <div class="flex-shrink-0 w-10 h-10 rounded flex items-center justify-center font-bold text-lg mr-3"
                                             :class="{
                                             'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': proc.grade === 'A',
                                             'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': proc.grade === 'B',
                                             'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': proc.grade === 'C',
                                             'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': proc.grade === 'D',
                                             'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': proc.grade === 'F'
                                         }"
                                             x-text="proc.grade"></div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                               :title="proc.process_key"
                                               x-text="proc.process_key"></p>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">
                                                <span x-text="proc.instance_count"></span> instances ¬∑
                                                Avg: <span x-text="formatDuration(proc.avg_duration_ms)"></span>
                                            </p>
                                        </div>
                                        <div class="ml-2 text-right text-xs">
                                            <p class="text-green-600 dark:text-green-400"
                                               x-text="proc.completion_rate_pct + '%'"></p>
                                            <p class="text-gray-500 dark:text-gray-400">complete</p>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!aiData.process_leaderboard.leaderboard?.length">
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No process data
                                    available</p>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Modals for AI insights -->
        {% include 'partials/anomaly_modal.html' %}
        {% include 'partials/incident_modal.html' %}
        {% include 'partials/variability_modal.html' %}
        {% include 'partials/outlier_modal.html' %}
        {% include 'partials/category_modal.html' %}
        {% include 'partials/stuck_modal.html' %}

    </div>  <!-- End of AI Intelligence Layer -->

    <!-- Independent sections below load on-demand with lazy loading -->

    <!-- NEW SECTIONS: Missing HIGH/MEDIUM Priority Data Blocks -->

                <!-- Process Categories Distribution -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"
                         x-intersect.once="!processCategories && !processCategoriesLoading && loadProcessCategories()">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="layers" class="mr-2 h-4 w-4 text-indigo-600"></i>
                                <span>Process Speed Categories</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Processes classified by speed: Ultra Fast (<5s), Very Fast (5-30s), Fast Background (<6m), Standard (6-30m), Extended (30m-4h), Long Running (4-24h), Batch/Manual (24h+)
                                </span>
                            </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <template x-if="processCategories">
                                    <span class="text-xs text-gray-500"
                                          x-text="`${Object.keys(processCategories.categories || {}).length} processes`"></span>
                                </template>
                                <button @click="loadProcessCategories()"
                                        :disabled="processCategoriesLoading"
                                        class="inline-flex items-center px-3 py-1.5 border border-indigo-300 dark:border-indigo-600 text-xs font-medium rounded-md text-indigo-700 dark:text-indigo-300 bg-white dark:bg-gray-800 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 disabled:opacity-50">
                                    <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                       :class="{ 'animate-spin': processCategoriesLoading }"></i>
                                    <span x-text="processCategoriesLoading ? 'Loading...' : 'Refresh'"></span>
                                </button>
                            </div>
                        </div>
                        <template x-if="processCategoriesLoading">
                            <div class="text-center py-8">
                                <div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                                <p class="text-sm text-gray-500 mt-2">Loading categories...</p>
                            </div>
                        </template>
                        <template x-if="processCategories && !processCategoriesLoading">
                            <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                <template
                                        x-if="processCategories.category_distribution && Object.keys(processCategories.category_distribution).length > 0">
                                    <template
                                            x-for="[cat, data] in Object.entries(processCategories.category_distribution)"
                                            :key="cat">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-200 dark:border-gray-700 last:border-0 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded px-2 -mx-2 transition-colors"
                                             @click="selectedCategory = cat; selectedCategoryData = data; $refs.categoryModal.classList.remove('hidden'); $nextTick(() => lucide.createIcons())">
                                            <div class="flex items-center flex-1">
                                                <div class="w-3 h-3 rounded-full mr-2"
                                                     :class="{
                                                     'bg-green-500': cat === 'ultra_fast' || cat === 'very_fast',
                                                     'bg-blue-500': cat === 'fast_background' || cat === 'standard',
                                                     'bg-yellow-500': cat === 'extended',
                                                     'bg-orange-500': cat === 'long_running',
                                                     'bg-red-500': cat === 'batch_manual'
                                                 }"></div>
                                                <span class="text-sm text-gray-900 dark:text-gray-100"
                                                      x-text="data.label"></span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300"
                                              x-text="data.count"></span>
                                                <span class="text-xs text-gray-500"
                                                      x-text="`~${formatDuration(data.median_seconds * 1000)}`"></span>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                <template
                                        x-if="!processCategories.category_distribution || Object.keys(processCategories.category_distribution).length === 0">
                                    <div class="text-center py-8">
                                        <i data-lucide="inbox" class="h-12 w-12 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">No categories found</p>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                    <!-- Stuck Processes -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"
                         x-intersect.once="!stuckProcesses && !stuckProcessesLoading && loadStuckProcesses()">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="pause-circle" class="mr-2 h-4 w-4 text-yellow-600"></i>
                                <span>Stuck Process Instances</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Running instances that exceed P95 threshold by 1.5x-3x. Critical = 3x P95, Warning = 2x P95. Shows business keys for investigation.
                                </span>
                            </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <template x-if="stuckProcesses">
                                    <span class="text-xs"
                                          :class="{
                                              'text-red-600': stuckProcesses.status_counts?.critical > 0,
                                              'text-yellow-600': stuckProcesses.status_counts?.warning > 0,
                                              'text-gray-500': !stuckProcesses.status_counts?.critical && !stuckProcesses.status_counts?.warning
                                          }"
                                          x-text="`${stuckProcesses.total_stuck || 0} stuck`"></span>
                                </template>
                                <button @click="loadStuckProcesses()"
                                        :disabled="stuckProcessesLoading"
                                        class="inline-flex items-center px-3 py-1.5 border border-yellow-300 dark:border-yellow-600 text-xs font-medium rounded-md text-yellow-700 dark:text-yellow-300 bg-white dark:bg-gray-800 hover:bg-yellow-50 dark:hover:bg-yellow-900/30 disabled:opacity-50">
                                    <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                       :class="{ 'animate-spin': stuckProcessesLoading }"></i>
                                    <span x-text="stuckProcessesLoading ? 'Loading...' : 'Refresh'"></span>
                                </button>
                            </div>
                        </div>
                        <template x-if="stuckProcessesLoading">
                            <div class="text-center py-8">
                                <div class="animate-spin h-8 w-8 border-4 border-yellow-500 border-t-transparent rounded-full mx-auto"></div>
                                <p class="text-sm text-gray-500 mt-2">Analyzing running instances...</p>
                            </div>
                        </template>
                        <template x-if="stuckProcesses && !stuckProcessesLoading">
                            <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                <template x-if="stuckProcesses.stuck_processes?.length > 0">
                                    <template x-for="proc in stuckProcesses.stuck_processes.slice(0, 10)"
                                              :key="proc.instance_id">
                                        <div class="p-3 rounded border-l-4"
                                             :class="{
                                             'bg-red-50 dark:bg-red-900/20 border-l-red-500': proc.status === 'critical',
                                             'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': proc.status === 'warning',
                                             'bg-blue-50 dark:bg-blue-900/20 border-l-blue-500': proc.status === 'attention'
                                         }">
                                            <div class="flex items-start justify-between mb-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                                   :title="proc.process_key"
                                                   x-text="proc.process_key"></p>
                                                <span class="text-xs px-2 py-0.5 rounded-full font-semibold ml-2"
                                                      :class="{
                                                      'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': proc.status === 'critical',
                                                      'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': proc.status === 'warning',
                                                      'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400': proc.status === 'attention'
                                                  }"
                                                      x-text="proc.status.toUpperCase()"></span>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                                Running: <span class="font-semibold"
                                                               x-text="formatDuration(proc.stuck_for_seconds * 1000)"></span>
                                                <template x-if="proc.expected_p95_hours">
                                                    ¬∑ P95: <span
                                                        x-text="proc.expected_p95_hours.toFixed(1) + 'h'"></span>
                                                </template>
                                            </p>
                                            <div class="flex items-center justify-between text-xs">
                                                <code class="text-xs bg-gray-100 dark:bg-gray-700 px-1 rounded truncate max-w-[180px]"
                                                      :title="proc.business_key"
                                                      x-text="proc.business_key || 'N/A'"></code>
                                                <button @click="navigator.clipboard.writeText(proc.instance_id)"
                                                        class="text-blue-600 dark:text-blue-400 hover:underline"
                                                        :title="proc.instance_id">
                                                    Copy ID
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                <template x-if="!stuckProcesses.stuck_processes?.length">
                                    <div class="text-center py-8">
                                        <i data-lucide="check-circle"
                                           class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                        <p class="text-sm font-semibold text-green-600 dark:text-green-400">All
                                            Clear!</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">No stuck processes
                                            detected</p>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Outlier Patterns & Extreme Variability -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <!-- High Outlier Processes (NEW) -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"
                         x-intersect.once="!outlierPatterns && !outlierPatternsLoading && loadOutlierPatterns()">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="alert-octagon" class="mr-2 h-4 w-4 text-red-600"></i>
                                <span>High Outlier Processes</span>
                                <span class="group relative ml-2">
                                    <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                    <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                        Processes with >15% outliers using IQR-based detection (3√óIQR for extreme). Shows sample outlier instances for investigation.
                                    </span>
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <template x-if="outlierPatterns">
                                    <span class="text-xs text-gray-500"
                                          x-text="`${outlierPatterns.high_outlier_count || 0} processes`"></span>
                                </template>
                                <button @click="loadOutlierPatterns()"
                                        :disabled="outlierPatternsLoading"
                                        class="inline-flex items-center px-3 py-1.5 border border-red-300 dark:border-red-600 text-xs font-medium rounded-md text-red-700 dark:text-red-300 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/30 disabled:opacity-50">
                                    <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                       :class="{ 'animate-spin': outlierPatternsLoading }"></i>
                                    <span x-text="outlierPatternsLoading ? 'Loading...' : 'Refresh'"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Loading state -->
                        <template x-if="outlierPatternsLoading">
                            <div class="text-center py-8">
                                <div class="animate-spin h-8 w-8 border-4 border-red-500 border-t-transparent rounded-full mx-auto"></div>
                                <p class="text-sm text-gray-500 mt-2">Loading outlier patterns...</p>
                            </div>
                        </template>

                        <!-- Results -->
                        <template x-if="outlierPatterns && !outlierPatternsLoading">
                        <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            <template x-if="outlierPatterns.high_outlier_processes?.length > 0">
                                <template x-for="proc in outlierPatterns.high_outlier_processes.slice(0, 10)"
                                          :key="proc.process_key">
                                    <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded border-l-2 border-l-red-500 cursor-pointer hover:shadow-md transition-shadow"
                                         @click="selectedOutlierProcess = proc; $refs.outlierModal.classList.remove('hidden'); $nextTick(() => lucide.createIcons())">
                                        <div class="flex items-start justify-between mb-1">
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                                   :title="proc.process_key"
                                                   x-text="proc.process_key"></p>
                                                <div class="flex items-center gap-2 mt-1">
                                                    <span class="text-xs px-2 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded"
                                                          x-text="proc.outlier_percentage.toFixed(1) + '% outliers'"></span>
                                                    <template x-if="proc.has_extreme_outliers">
                                                        <span class="text-xs px-2 py-0.5 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded">
                                                            <span x-text="proc.extreme_outlier_count"></span> extreme
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>
                                            <span class="text-sm font-bold text-red-600 dark:text-red-400 ml-2"
                                                  x-text="proc.outlier_count"></span>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                            Normal range: <span x-text="formatDuration(proc.q1_seconds * 1000)"></span>
                                            -
                                            <span x-text="formatDuration(proc.upper_bound_seconds * 1000)"></span>
                                        </p>
                                        <template
                                                x-if="proc.sample_outlier_instances && proc.sample_outlier_instances.length > 0">
                                            <p class="text-xs text-blue-600 dark:text-blue-400 font-medium mt-1">
                                                <span x-text="proc.sample_outlier_instances.length"></span> sample(s) ‚Ä¢
                                                Click for details ‚Üí
                                            </p>
                                        </template>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!outlierPatterns?.high_outlier_processes?.length">
                                <div class="text-center py-8">
                                    <i data-lucide="check-circle"
                                       class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                    <p class="text-sm font-semibold text-green-600 dark:text-green-400">Consistent
                                        Performance!</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">No processes with excessive
                                        outliers detected</p>
                                </div>
                            </template>
                        </div>
                        </template>
                    </div>

                    <!-- Extreme Variability -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"
                         x-intersect.once="!extremeVariability && !extremeVariabilityLoading && loadExtremeVariability()">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="activity" class="mr-2 h-4 w-4 text-red-600"></i>
                                <span>Extreme Variability</span>
                                <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    P95/Median ratio analysis. Extreme = >100x, High = >50x, Medium = >20x. Do NOT use extreme processes for SLA-critical workflows.
                                </span>
                            </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <template x-if="extremeVariability">
                                    <span class="text-xs text-red-600 dark:text-red-400"
                                          x-text="`${extremeVariability.extreme_count || 0} unpredictable`"></span>
                                </template>
                                <button @click="loadExtremeVariability()"
                                        :disabled="extremeVariabilityLoading"
                                        class="inline-flex items-center px-3 py-1.5 border border-red-300 dark:border-red-600 text-xs font-medium rounded-md text-red-700 dark:text-red-300 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/30 disabled:opacity-50">
                                    <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                       :class="{ 'animate-spin': extremeVariabilityLoading }"></i>
                                    <span x-text="extremeVariabilityLoading ? 'Loading...' : 'Refresh'"></span>
                                </button>
                            </div>
                        </div>
                        <template x-if="extremeVariabilityLoading">
                            <div class="text-center py-8">
                                <div class="animate-spin h-8 w-8 border-4 border-red-500 border-t-transparent rounded-full mx-auto"></div>
                                <p class="text-sm text-gray-500 mt-2">Analyzing variability...</p>
                            </div>
                        </template>
                        <template x-if="extremeVariability && !extremeVariabilityLoading">
                            <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                <template x-if="extremeVariability.extreme_processes?.length > 0">
                                    <template x-for="proc in extremeVariability.extreme_processes.slice(0, 10)"
                                              :key="proc.process_key">
                                        <div class="p-3 rounded border-l-4 cursor-pointer hover:shadow-md transition-shadow"
                                             :class="{
                                             'bg-red-50 dark:bg-red-900/20 border-l-red-500': proc.severity === 'extreme',
                                             'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': proc.severity === 'high',
                                             'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': proc.severity === 'medium'
                                         }"
                                             @click="selectedVariabilityAlert = proc; $refs.variabilityModal.classList.remove('hidden'); $nextTick(() => lucide.createIcons())">
                                            <div class="flex items-start justify-between mb-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate flex-1"
                                                   :title="proc.process_key"
                                                   x-text="proc.process_key"></p>
                                                <span class="text-lg font-bold ml-2"
                                                      :class="{
                                                      'text-red-600 dark:text-red-400': proc.severity === 'extreme',
                                                      'text-orange-600 dark:text-orange-400': proc.severity === 'high',
                                                      'text-yellow-600 dark:text-yellow-400': proc.severity === 'medium'
                                                  }"
                                                      x-text="proc.p95_median_ratio.toFixed(0) + 'x'"></span>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                                Median: <span
                                                    x-text="formatDuration(proc.median_seconds * 1000)"></span>
                                                ¬∑ P95: <span class="font-semibold text-red-600 dark:text-red-400"
                                                             x-text="formatDuration(proc.p95_seconds * 1000)"></span>
                                            </p>
                                            <div class="flex items-center justify-between">
                                            <span class="text-xs px-2 py-0.5 rounded-full"
                                                  :class="{
                                                      'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': proc.severity === 'extreme',
                                                      'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': proc.severity === 'high',
                                                      'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': proc.severity === 'medium'
                                                  }"
                                                  x-text="proc.severity.toUpperCase()"></span>
                                                <span class="text-xs text-blue-600 dark:text-blue-400 font-medium">Click for details ‚Üí</span>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                <template x-if="!extremeVariability.extreme_processes?.length">
                                    <div class="text-center py-8">
                                        <i data-lucide="check-circle"
                                           class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                        <p class="text-sm font-semibold text-green-600 dark:text-green-400">Stable!</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">All processes have
                                            predictable
                                            execution times</p>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Advanced ML Features Row -->
                <div class="bg-gradient-to-r from-cyan-100/70 to-sky-50 dark:from-cyan-900/20 dark:to-sky-900/20 rounded-lg p-4 mt-6 mb-6 border border-cyan-200 dark:border-cyan-700"
                     x-intersect.once="loadAdvancedMLFeatures()">
                    <div class="flex items-center mb-4">
                        <i data-lucide="sparkles" class="h-5 w-5 text-cyan-600 dark:text-cyan-400 mr-2"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Advanced ML Features</h3>
                    </div>

                    <!-- Smart Stuck Activities & Capacity Forecast -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Smart Stuck Activity Detection -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"
                             x-intersect.once="!stuckActivitiesData && !stuckActivitiesLoading && loadStuckActivities()">
                            <div class="flex items-center justify-between mb-3">
                                <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                    <i data-lucide="hourglass" class="mr-2 h-4 w-4 text-red-600"></i>
                                    Smart Stuck Activities
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="group relative">
                                        <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                        <div class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                            Statistical P95-based detection. Identifies activities taking abnormally long
                                            compared
                                            to historical patterns (not hardcoded timeouts).
                                        </div>
                                    </div>
                                    <button @click="loadStuckActivities()"
                                            :disabled="stuckActivitiesLoading"
                                            class="inline-flex items-center px-3 py-1.5 border border-cyan-300 dark:border-cyan-600 text-xs font-medium rounded-md text-cyan-700 dark:text-cyan-300 bg-white dark:bg-gray-800 hover:bg-cyan-50 dark:hover:bg-cyan-900/30 disabled:opacity-50">
                                        <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                           :class="{ 'animate-spin': stuckActivitiesLoading }"></i>
                                        <span x-text="stuckActivitiesLoading ? 'Loading...' : 'Refresh'"></span>
                                    </button>
                                </div>
                            </div>


                            <!-- Loading state -->
                            <template x-if="stuckActivitiesLoading">
                                <div class="flex flex-col items-center justify-center py-8">
                                    <div class="loader mb-2"></div>
                                    <p class="text-xs text-gray-500">Analyzing activity patterns...</p>
                                </div>
                            </template>

                            <!-- Results -->
                            <template x-if="stuckActivitiesData && !stuckActivitiesLoading">
                                <div>
                                    <div class="flex items-center justify-between mb-3 p-2 bg-gray-50 dark:bg-gray-700/30 rounded">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">
                                        Found: <span class="font-bold" x-text="stuckActivitiesData.total_found"></span> stuck
                                    </span>
                                        <span class="text-xs text-gray-500">
                                        P<span x-text="stuckActivitiesData.threshold_percentile"></span> √ó <span
                                                x-text="stuckActivitiesData.threshold_multiplier"></span>
                                    </span>
                                    </div>

                                    <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                                        <template x-if="stuckActivitiesData.stuck_activities?.length > 0">
                                            <template
                                                    x-for="activity in stuckActivitiesData.stuck_activities.slice(0, 10)"
                                                    :key="activity.activity_instance_id">
                                                <div class="p-3 rounded border-l-4"
                                                     :class="{
                                                     'bg-red-50 dark:bg-red-900/20 border-l-red-600': activity.severity === 'critical',
                                                     'bg-orange-50 dark:bg-orange-900/20 border-l-orange-500': activity.severity === 'high',
                                                     'bg-yellow-50 dark:bg-yellow-900/20 border-l-yellow-500': activity.severity === 'medium'
                                                 }">
                                                    <div class="flex items-start justify-between">
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate"
                                                               :title="activity.activity_name"
                                                               x-text="activity.activity_name"></p>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                                Process: <span x-text="activity.process_key"></span>
                                                            </p>
                                                        </div>
                                                        <div class="ml-2 text-right">
                                                        <span class="text-lg font-bold"
                                                              :class="{
                                                                  'text-red-600 dark:text-red-400': activity.severity === 'critical',
                                                                  'text-orange-600 dark:text-orange-400': activity.severity === 'high',
                                                                  'text-yellow-600 dark:text-yellow-400': activity.severity === 'medium'
                                                              }"
                                                              x-text="activity.duration_ratio + 'x'"></span>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 flex items-center justify-between text-xs">
                                                    <span class="text-gray-500 dark:text-gray-400">
                                                        Stuck for: <span class="font-semibold"
                                                                         x-text="activity.stuck_for_hours + 'h'"></span>
                                                    </span>
                                                        <template x-if="activity.z_score">
                                                        <span class="text-gray-500 dark:text-gray-400">
                                                            Z-score: <span class="font-semibold"
                                                                           x-text="activity.z_score"></span>
                                                        </span>
                                                        </template>
                                                    </div>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                                                       x-text="activity.message"></p>
                                                </div>
                                            </template>
                                        </template>

                                        <template x-if="!stuckActivitiesData.stuck_activities?.length">
                                            <div class="text-center py-6">
                                                <i data-lucide="check-circle"
                                                   class="h-12 w-12 text-green-500 dark:text-green-400 mx-auto mb-2"></i>
                                                <p class="text-sm font-semibold text-green-600 dark:text-green-400">All
                                                    Clear!</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                                                   x-text="stuckActivitiesData.message"></p>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Capacity Forecast -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"
                             x-intersect.once="!capacityForecastData && !capacityForecastLoading && loadCapacityForecast()">
                            <div class="flex items-center justify-between mb-3">
                                <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                    <i data-lucide="trending-up" class="mr-2 h-4 w-4 text-blue-600"></i>
                                    Capacity Forecast
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="group relative">
                                        <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                        <div class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                            30-day load prediction using time series analysis. Helps with infrastructure and
                                            budget
                                            planning.
                                        </div>
                                    </div>
                                    <button @click="loadCapacityForecast()"
                                            :disabled="capacityForecastLoading"
                                            class="inline-flex items-center px-3 py-1.5 border border-blue-300 dark:border-blue-600 text-xs font-medium rounded-md text-blue-700 dark:text-blue-300 bg-white dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/30 disabled:opacity-50">
                                        <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                           :class="{ 'animate-spin': capacityForecastLoading }"></i>
                                        <span x-text="capacityForecastLoading ? 'Loading...' : 'Refresh'"></span>
                                    </button>
                                </div>
                            </div>

                            <!-- Loading state -->
                            <template x-if="capacityForecastLoading">
                                <div class="flex flex-col items-center justify-center py-8">
                                    <div class="loader mb-2"></div>
                                    <p class="text-xs text-gray-500">Forecasting capacity...</p>
                                </div>
                            </template>

                            <!-- Results -->
                            <template x-if="capacityForecastData && !capacityForecastLoading">
                                <div>
                                    <!-- Summary stats -->
                                    <div class="grid grid-cols-2 gap-3 mb-4">
                                        <div class="p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Growth Rate</p>
                                            <p class="text-lg font-bold"
                                               :class="{
                                               'text-green-600 dark:text-green-400': capacityForecastData.growth_rate_per_day < 5,
                                               'text-yellow-600 dark:text-yellow-400': capacityForecastData.growth_rate_per_day >= 5 && capacityForecastData.growth_rate_per_day < 15,
                                               'text-red-600 dark:text-red-400': capacityForecastData.growth_rate_per_day >= 15
                                           }"
                                               x-text="capacityForecastData.growth_rate_per_day + '/day'"></p>
                                        </div>
                                        <div class="p-3 bg-gray-50 dark:bg-gray-700/30 rounded">
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Confidence</p>
                                            <p class="text-lg font-bold text-blue-600 dark:text-blue-400"
                                               x-text="Math.round(capacityForecastData.trend_confidence * 100) + '%'"></p>
                                        </div>
                                    </div>

                                    <!-- Peak patterns -->
                                    <template x-if="capacityForecastData.patterns">
                                        <div class="mb-3">
                                            <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Peak
                                                Hours:</p>
                                            <div class="flex flex-wrap gap-2">
                                                <template
                                                        x-for="hour in capacityForecastData.patterns.peak_hours?.slice(0, 3)"
                                                        :key="hour.hour">
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400">
                                                    <span x-text="hour.hour + ':00'"></span>
                                                    <span class="ml-1 text-blue-500"
                                                          x-text="'(' + Math.round(hour.avg_instances) + ')'"></span>
                                                </span>
                                                </template>
                                            </div>

                                        </div>
                                    </template>

                                    <!-- 7-day forecast preview -->
                                    <div class="mt-3">
                                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Next 7
                                            Days:</p>
                                        <div class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar">
                                            <template x-for="day in capacityForecastData.forecast?.slice(0, 7)"
                                                      :key="day.day">
                                                <div class="flex items-center justify-between text-xs py-1">
                                                    <span class="text-gray-600 dark:text-gray-400"
                                                          x-text="day.date"></span>
                                                    <div class="flex items-center space-x-2">
                                                    <span class="font-semibold text-gray-900 dark:text-gray-100"
                                                          x-text="day.predicted_instances + ' instances'"></span>
                                                        <span class="px-1 rounded text-xs"
                                                              :class="{
                                                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': day.trend === 'increasing',
                                                              'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': day.trend === 'decreasing',
                                                              'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-400': day.trend === 'stable'
                                                          }"
                                                              x-text="day.trend"></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Duration Prediction Tool -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-4"
                         x-intersect.once="!durationPredictions && !durationPredictionsLoading && !durationPredictionsLoaded && loadAllDurationPredictions()">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                <i data-lucide="timer" class="mr-2 h-4 w-4 text-green-600"></i>
                                Process Duration Analysis
                            </div>
                            <div class="flex items-center space-x-2">
                            <span class="group relative">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute right-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    ML-powered prediction using Random Forest. Trained on historical patterns including time-of-day and day-of-week factors. Shows all processes sorted by longest predicted duration.
                                </span>
                            </span>
                                <button @click="loadAllDurationPredictions()"
                                        :disabled="durationPredictionsLoading"
                                        class="inline-flex items-center px-3 py-1.5 border border-green-300 dark:border-green-600 text-xs font-medium rounded-md text-green-700 dark:text-green-300 bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-900/30 disabled:opacity-50">
                                    <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"
                                       :class="{ 'animate-spin': durationPredictionsLoading }"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>


                        <!-- Loading State -->
                        <template x-if="durationPredictionsLoading">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="loader mb-2"></div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Analyzing process patterns...</p>
                            </div>
                        </template>

                        <!-- Results Table -->
                        <template x-if="durationPredictions && !durationPredictionsLoading">
                            <div class="mt-3">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700/50">
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                Process
                                            </th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                Predicted
                                            </th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                P50
                                            </th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                P95
                                            </th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                Confidence
                                            </th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                Instances
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <template x-for="(pred, index) in durationPredictions.slice(0, 20)"
                                                  :key="pred.process_key">
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"
                                                    :title="pred.process_key">
                                            <span class="truncate max-w-xs inline-block"
                                                  x-text="pred.process_key"></span>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-right">
                                                    <span class="font-bold text-green-600 dark:text-green-400"
                                                          x-text="pred.predicted_duration_ms != null ? formatDuration(pred.predicted_duration_ms) : 'N/A'"></span>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right"
                                                    x-text="pred.percentiles?.p50_ms != null ? formatDuration(pred.percentiles.p50_ms) : '-'"></td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right"
                                                    x-text="pred.percentiles?.p95_ms != null ? formatDuration(pred.percentiles.p95_ms) : '-'"></td>
                                                <td class="px-3 py-2 whitespace-nowrap text-center">
                                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                          :class="{
                                                              'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': pred.confidence_pct >= 80,
                                                              'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400': pred.confidence_pct >= 60 && pred.confidence_pct < 80,
                                                              'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': pred.confidence_pct < 60
                                                          }"
                                                          x-text="pred.confidence_pct ? pred.confidence_pct + '%' : 'N/A'"></span>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-center"
                                                    x-text="pred.instance_count || 0"></td>
                                            </tr>
                                        </template>
                                        </tbody>
                                    </table>
                                </div>
                                <template x-if="durationPredictions.length > 20">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
                                        Showing top 20 of <span x-text="durationPredictions.length"></span> processes
                                    </p>
                                </template>
                                <template x-if="durationPredictions.length === 0">
                                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No process
                                        predictions
                                        available</p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>


                <!-- NEW: Activity Bottleneck Analysis Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-6"
                     x-intersect.once="!activityBottlenecks && !activityBottlenecksLoading && loadActivityBottlenecks()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                            <i data-lucide="zap" class="mr-2 h-5 w-5 text-orange-600 dark:text-orange-400"></i>
                            <span>Activity Bottleneck Analysis</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-80 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Identifies the slowest activities across business-critical processes with concrete ROI calculations. Shows which activities consume the most time and estimates potential savings from optimization.
                                </span>
                            </span>
                            <span class="ml-2 text-xs px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-full font-semibold">
                                TOP OPTIMIZATION TARGETS
                            </span>
                        </div>
                        <button @click="loadActivityBottlenecks()"
                                :disabled="activityBottlenecksLoading"
                                class="inline-flex items-center px-4 py-2 border border-orange-300 dark:border-orange-600 shadow-sm text-sm font-medium rounded-md text-orange-700 dark:text-orange-300 bg-white dark:bg-gray-800 hover:bg-orange-50 dark:hover:bg-orange-900/30 disabled:opacity-50">
                            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"
                               :class="{ 'animate-spin': activityBottlenecksLoading }"></i>
                            <span x-text="activityBottlenecksLoading ? 'Loading...' : 'Refresh'"></span>
                        </button>
                    </div>

                    <template x-if="activityBottlenecksLoading">
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="loader mb-2"></div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Analyzing activity bottlenecks...</p>
                        </div>
                    </template>

                    <template x-if="activityBottlenecks && !activityBottlenecksLoading">
                        <div>
                            <div class="mb-4 p-3 bg-gradient-to-r from-orange-50 to-yellow-50 dark:from-orange-900/20 dark:to-yellow-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                                            <span x-text="activityBottlenecks.count || 0"></span> Activities Analyzed
                                        </p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                            Total potential savings:
                                            <strong class="text-green-600 dark:text-green-400"
                                                    x-text="(activityBottlenecks.activities?.reduce((sum, a) => sum + (a.potential_savings_hours || 0), 0) || 0).toFixed(0) + ' hours'"></strong>
                                            (10% improvement across all)
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-900/50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            #
                                        </th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Activity
                                        </th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Type
                                        </th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Executions
                                        </th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Avg Duration
                                        </th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            P95
                                        </th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Stability
                                        </th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-yellow-50 dark:bg-yellow-900/20">
                                            üí° Savings (10%)
                                        </th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Sample
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <template
                                            x-for="(activity, idx) in (activityBottlenecks.activities || []).slice(0, 15)"
                                            :key="idx">
                                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                            <td class="px-3 py-3 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-gray-100"
                                                x-text="idx + 1"></td>
                                            <td class="px-3 py-3">
                                                <div class="text-sm">
                                                    <div class="font-medium text-gray-900 dark:text-gray-100"
                                                         x-text="activity.process_key"></div>
                                                    <div class="text-xs text-gray-600 dark:text-gray-400"
                                                         x-text="activity.activity_name"></div>
                                                </div>
                                            </td>
                                            <td class="px-3 py-3 whitespace-nowrap">
                                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400"
                                                          x-text="activity.activity_type"></span>
                                            </td>
                                            <td class="px-3 py-3 whitespace-nowrap text-sm text-right text-gray-900 dark:text-gray-100"
                                                x-text="activity.execution_count?.toLocaleString()"></td>
                                            <td class="px-3 py-3 whitespace-nowrap text-sm text-right text-gray-900 dark:text-gray-100"
                                                x-text="formatDuration(activity.avg_duration_s * 1000)"></td>
                                            <td class="px-3 py-3 whitespace-nowrap text-sm text-right text-gray-900 dark:text-gray-100"
                                                x-text="formatDuration(activity.p95_duration_s * 1000)"></td>
                                            <td class="px-3 py-3 whitespace-nowrap text-center">
                                                    <span class="px-2 py-1 text-xs rounded-full font-semibold text-gray-700 dark:text-gray-300"
                                                          :class="{
                                                              'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': activity.stability === 'Stable',
                                                              'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': activity.stability === 'Moderate',
                                                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': activity.stability === 'Variable'
                                                          }"
                                                          x-text="activity.stability"></span>
                                            </td>
                                            <td class="px-3 py-3 whitespace-nowrap text-right bg-yellow-50 dark:bg-yellow-900/20">
                                                <div class="text-sm font-bold text-green-600 dark:text-green-400"
                                                     x-text="(activity.potential_savings_hours || 0).toFixed(0) + 'h'"></div>
                                                <div class="text-xs text-gray-600 dark:text-gray-400"
                                                     x-text="'of ' + (activity.total_time_hours || 0).toFixed(0) + 'h total'"></div>
                                            </td>
                                            <td class="px-3 py-3">
                                                <div class="text-xs">
                                                    <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded text-xs text-gray-900 dark:text-gray-100"
                                                          x-text="(activity.sample_instance_id || 'N/A').substring(0, 50)"></code>
                                                    <div class="text-gray-600 dark:text-gray-400 mt-1"
                                                         x-text="activity.sample_business_key ? 'BKey: ' + activity.sample_business_key : ''"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- NEW: Complete Version History Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-6"
                     x-intersect.once="!versionHistory && !versionHistoryLoading && loadVersionHistory()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                            <i data-lucide="git-branch" class="mr-2 h-5 w-5 text-purple-600 dark:text-purple-400"></i>
                            <span>Complete Version Performance History</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-80 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Tracks performance across ALL deployed versions (not just latest 2). Identifies regression patterns and helps make informed rollback decisions.
                                </span>
                            </span>
                            <span class="ml-2 text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-full font-semibold">
                                ALL VERSIONS
                            </span>
                        </div>
                        <button @click="loadVersionHistory()"
                                :disabled="versionHistoryLoading"
                                class="inline-flex items-center px-4 py-2 border border-purple-300 dark:border-purple-600 shadow-sm text-sm font-medium rounded-md text-purple-700 dark:text-purple-300 bg-white dark:bg-gray-800 hover:bg-purple-50 dark:hover:bg-purple-900/30 disabled:opacity-50">
                            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"
                               :class="{ 'animate-spin': versionHistoryLoading }"></i>
                            <span x-text="versionHistoryLoading ? 'Loading...' : 'Refresh'"></span>
                        </button>
                    </div>

                    <template x-if="versionHistoryLoading">
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="loader mb-2"></div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Loading version history...</p>
                        </div>
                    </template>

                    <template x-if="versionHistory && !versionHistoryLoading">
                        <div>
                            <div class="mb-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Processes Tracked</p>
                                        <p class="text-lg font-bold text-gray-900 dark:text-gray-100"
                                           x-text="versionHistory.total_processes || 0"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Regressions Found</p>
                                        <p class="text-lg font-bold text-red-600 dark:text-red-400"
                                           x-text="versionHistory.regression_count || 0"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Improvements</p>
                                        <p class="text-lg font-bold text-green-600 dark:text-green-400"
                                           x-text="versionHistory.improvement_count || 0"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Regressions (if any) -->
                            <template x-if="versionHistory.regressions && versionHistory.regressions.length > 0">
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-red-600 dark:text-red-400 mb-2">
                                        üö® Critical Regressions
                                    </h4>
                                    <div class="space-y-2">
                                        <template x-for="reg in versionHistory.regressions.slice(0, 5)"
                                                  :key="reg.process_key">
                                            <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                                                <div class="flex items-start justify-between mb-2">
                                                    <div class="flex-1">
                                                        <p class="font-medium text-gray-900 dark:text-gray-100"
                                                           x-text="reg.process_key"></p>
                                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                            v<span x-text="reg.previous_version"></span> ‚Üí v<span
                                                                x-text="reg.latest_version"></span>
                                                            <span class="ml-2 font-bold text-red-600 dark:text-red-400"
                                                                  x-text="'(' + reg.change_pct.toFixed(1) + '% slower)'"></span>
                                                        </p>
                                                    </div>
                                                    <span class="text-xs px-2 py-1 rounded-full font-semibold uppercase"
                                                          :class="{
                                                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': reg.severity === 'critical',
                                                              'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': reg.severity === 'high'
                                                          }"
                                                          x-text="reg.severity"></span>
                                                </div>
                                                <p class="text-xs text-red-700 dark:text-red-300 mb-2"
                                                   x-text="reg.recommendation"></p>
                                                <template x-if="reg.sample_instance_id">
                                                    <div class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-red-200 dark:border-red-800">
                                                        <div class="mb-1">
                                                            <span class="text-gray-500 dark:text-gray-400">Sample: </span>
                                                            <code class="text-gray-900 dark:text-gray-100"
                                                                  x-text="reg.sample_instance_id"></code>
                                                        </div>
                                                        <div x-show="reg.sample_business_key">
                                                            <span class="text-gray-500 dark:text-gray-400">BKey: </span>
                                                            <span class="text-gray-900 dark:text-gray-100"
                                                                  x-text="reg.sample_business_key"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Version Comparisons -->
                            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                <template x-for="comp in (versionHistory.version_comparisons || []).slice(0, 10)"
                                          :key="comp.process_key">
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                        <div class="p-3 bg-gray-50 dark:bg-gray-900/50 flex items-center justify-between cursor-pointer"
                                             @click="comp.expanded = !comp.expanded; $nextTick(() => lucide.createIcons())">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <p class="font-medium text-gray-900 dark:text-gray-100"
                                                       x-text="comp.process_key"></p>
                                                    <span class="text-xs px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded"
                                                          x-text="comp.all_versions_count + ' versions'"></span>
                                                </div>
                                                <div class="flex items-center gap-3 text-xs text-gray-600 dark:text-gray-400">
                                                    <span>Latest: v<span x-text="comp.latest_version"></span></span>
                                                    <span>‚Üí</span>
                                                    <span :class="{
                                                        'text-red-600 dark:text-red-400 font-semibold': comp.direction === 'regression',
                                                        'text-green-600 dark:text-green-400 font-semibold': comp.direction === 'improvement'
                                                    }"
                                                          x-text="comp.change_pct > 0 ? '+' + comp.change_pct.toFixed(1) + '%' : comp.change_pct.toFixed(1) + '%'"></span>
                                                </div>
                                            </div>
                                            <i data-lucide="chevron-down"
                                               class="h-4 w-4 text-gray-400 transition-transform"
                                               :class="{ 'rotate-180': comp.expanded }"></i>
                                        </div>
                                        <div x-show="comp.expanded" x-collapse>
                                            <div class="p-3 bg-white dark:bg-gray-800">
                                                <template x-if="comp.all_versions && comp.all_versions.length > 0">
                                                    <table class="min-w-full text-xs">
                                                        <thead>
                                                        <tr class="border-b border-gray-200 dark:border-gray-700">
                                                            <th class="text-left py-2 text-gray-500 dark:text-gray-400">
                                                                Version
                                                            </th>
                                                            <th class="text-right py-2 text-gray-500 dark:text-gray-400">
                                                                Instances
                                                            </th>
                                                            <th class="text-right py-2 text-gray-500 dark:text-gray-400">
                                                                Avg
                                                            </th>
                                                            <th class="text-right py-2 text-gray-500 dark:text-gray-400">
                                                                P95
                                                            </th>
                                                            <th class="text-left py-2 text-gray-500 dark:text-gray-400">
                                                                Sample
                                                            </th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <template x-for="(v, vidx) in comp.all_versions" :key="vidx">
                                                            <tr class="border-b border-gray-100 dark:border-gray-700/50">
                                                                <td class="py-2">
                                                                    <span class="font-medium text-gray-900 dark:text-gray-100"
                                                                          x-text="'v' + v.version"></span>
                                                                    <span x-show="vidx === 0"
                                                                          class="ml-1 text-xs px-1 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded">Current</span>
                                                                </td>
                                                                <td class="py-2 text-right text-gray-900 dark:text-gray-100"
                                                                    x-text="v.count?.toLocaleString()"></td>
                                                                <td class="py-2 text-right text-gray-900 dark:text-gray-100"
                                                                    x-text="formatDuration(v.avg_s * 1000)"></td>
                                                                <td class="py-2 text-right text-gray-900 dark:text-gray-100"
                                                                    x-text="formatDuration(v.p95_s * 1000)"></td>
                                                                <td class="py-2">
                                                                    <code x-show="v.sample_instance_id"
                                                                          class="text-xs bg-gray-100 dark:bg-gray-700 px-1 rounded text-gray-900 dark:text-gray-100"
                                                                          x-text="(v.sample_instance_id || '').substring(0, 50)"></code>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                        </tbody>
                                                    </table>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- NEW: Weekly Load Patterns Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-6"
                     x-intersect.once="!weeklyLoadPatterns && !weeklyLoadPatternsLoading && loadWeeklyLoadPatterns()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                            <i data-lucide="calendar" class="mr-2 h-5 w-5 text-indigo-600 dark:text-indigo-400"></i>
                            <span>Weekly Load Patterns</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-80 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Shows process instance distribution across weekdays. Helps identify peak days for capacity planning and optimal scheduling of batch jobs and maintenance windows.
                                </span>
                            </span>
                            <span class="ml-2 text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-full font-semibold">
                                CAPACITY PLANNING
                            </span>
                        </div>
                        <button @click="loadWeeklyLoadPatterns()"
                                :disabled="weeklyLoadPatternsLoading"
                                class="inline-flex items-center px-4 py-2 border border-indigo-300 dark:border-indigo-600 shadow-sm text-sm font-medium rounded-md text-indigo-700 dark:text-indigo-300 bg-white dark:bg-gray-800 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 disabled:opacity-50">
                            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"
                               :class="{ 'animate-spin': weeklyLoadPatternsLoading }"></i>
                            <span x-text="weeklyLoadPatternsLoading ? 'Loading...' : 'Refresh'"></span>
                        </button>
                    </div>

                    <template x-if="weeklyLoadPatternsLoading">
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="loader mb-2"></div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Loading weekly patterns...</p>
                        </div>
                    </template>

                    <template x-if="weeklyLoadPatterns && !weeklyLoadPatternsLoading">
                        <div>
                            <!-- Summary Stats -->
                            <div class="mb-4 p-3 bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Analysis Period</p>
                                        <p class="text-lg font-bold text-gray-900 dark:text-gray-100"
                                           x-text="weeklyLoadPatterns.analysis_window_days + ' days'"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Business Days Load</p>
                                        <p class="text-lg font-bold text-blue-600 dark:text-blue-400"
                                           x-text="weeklyLoadPatterns.business_summary?.business_days?.total_instances?.toLocaleString()"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Weekend Load</p>
                                        <p class="text-lg font-bold text-purple-600 dark:text-purple-400"
                                           x-text="weeklyLoadPatterns.business_summary?.weekends?.total_instances?.toLocaleString()"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">Weekend vs Business</p>
                                        <p class="text-lg font-bold"
                                           :class="{
                                               'text-green-600 dark:text-green-400': weeklyLoadPatterns.business_summary?.weekend_vs_business?.direction === 'faster',
                                               'text-yellow-600 dark:text-yellow-400': weeklyLoadPatterns.business_summary?.weekend_vs_business?.direction === 'similar',
                                               'text-red-600 dark:text-red-400': weeklyLoadPatterns.business_summary?.weekend_vs_business?.direction === 'slower'
                                           }"
                                           x-text="weeklyLoadPatterns.business_summary?.weekend_vs_business?.change_pct?.toFixed(1) + '%'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Weekday Bar Chart -->
                            <div class="mb-4">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Load
                                    Distribution by Day</h4>
                                <div class="space-y-2">
                                    <template x-for="day in weeklyLoadPatterns.daily_patterns" :key="day.day_of_week">
                                        <div class="flex items-center gap-3">
                                            <!-- Day Name -->
                                            <div class="w-24 text-right">
                                                <span class="text-sm font-medium text-gray-900 dark:text-gray-100"
                                                      x-text="day.day_name"></span>
                                                <span x-show="day.is_weekend"
                                                      class="ml-1 text-xs px-1 py-0.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded">Weekend</span>
                                            </div>

                                            <!-- Bar Chart -->
                                            <div class="flex-1 relative">
                                                <!-- Background bar -->
                                                <div class="w-full h-8 bg-gray-100 dark:bg-gray-700 rounded overflow-hidden">
                                                    <!-- Filled bar -->
                                                    <div class="h-full rounded transition-all duration-500"
                                                         :class="day.is_weekend ? 'bg-gradient-to-r from-purple-500 to-purple-600' : 'bg-gradient-to-r from-blue-500 to-blue-600'"
                                                         :style="`width: ${(day.total_instances / Math.max(...weeklyLoadPatterns.daily_patterns.map(d => d.total_instances))) * 100}%`">
                                                    </div>
                                                </div>
                                                <!-- Value label -->
                                                <div class="absolute inset-0 flex items-center px-3">
                                                    <span class="text-sm font-bold text-white drop-shadow-md"
                                                          x-text="day.total_instances.toLocaleString() + ' instances'"></span>
                                                </div>
                                            </div>

                                            <!-- Percentage -->
                                            <div class="w-16 text-right">
                                                <span class="text-xs font-semibold text-gray-600 dark:text-gray-400"
                                                      x-text="((day.total_instances / weeklyLoadPatterns.daily_patterns.reduce((sum, d) => sum + d.total_instances, 0)) * 100).toFixed(1) + '%'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Peak Hours -->
                            <template
                                    x-if="weeklyLoadPatterns.business_summary?.peak_hours && weeklyLoadPatterns.business_summary.peak_hours.length > 0">
                                <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                                    <h4 class="text-sm font-semibold text-yellow-700 dark:text-yellow-300 mb-2 flex items-center">
                                        <i data-lucide="clock" class="h-4 w-4 mr-1"></i>
                                        Top Peak Hours
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        <template
                                                x-for="(peak, idx) in weeklyLoadPatterns.business_summary.peak_hours.slice(0, 5)"
                                                :key="idx">
                                            <div class="px-3 py-1 rounded-full text-xs font-medium"
                                                 :class="peak.is_business_hours ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'">
                                                <span x-text="peak.hour + ':00'"></span>
                                                <span class="ml-1 font-bold"
                                                      x-text="'(' + peak.instances.toLocaleString() + ')'"></span>
                                                <span x-show="peak.is_business_hours" class="ml-1">üíº</span>
                                                <span x-show="!peak.is_business_hours" class="ml-1">üåô</span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Recommendations -->
                            <template
                                    x-if="weeklyLoadPatterns.business_summary?.recommendations && weeklyLoadPatterns.business_summary.recommendations.length > 0">
                                <div class="mt-4">
                                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                        <i data-lucide="lightbulb" class="h-4 w-4 mr-1 text-green-600"></i>
                                        Scheduling Recommendations
                                    </h4>
                                    <div class="space-y-2">
                                        <template
                                                x-for="(rec, recIdx) in weeklyLoadPatterns.business_summary.recommendations.slice(0, 3)"
                                                :key="recIdx">
                                            <div class="p-2 bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 rounded text-sm text-gray-700 dark:text-gray-300">
                                                <span x-text="rec.message || rec"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- NEW: Critical Insights Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-6"
                     x-intersect.once="!criticalInsights && !criticalInsightsLoading && loadCriticalInsights()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                            <i data-lucide="alert-octagon" class="mr-2 h-5 w-5 text-red-600 dark:text-red-400"></i>
                            <span>Critical Insights & Recommendations</span>
                            <span class="group relative ml-2">
                                <i data-lucide="info" class="h-4 w-4 text-gray-400 cursor-help"></i>
                                <span class="hidden group-hover:block absolute left-0 top-6 w-80 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    Automated detection of critical issues with actionable recommendations. Includes specific instance IDs, business keys, and ROI estimates for immediate action.
                                </span>
                            </span>
                            <span class="ml-2 text-xs px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-full font-semibold">
                                ACTIONABLE ALERTS
                            </span>
                        </div>
                        <button @click="loadCriticalInsights()"
                                :disabled="criticalInsightsLoading"
                                class="inline-flex items-center px-4 py-2 border border-red-300 dark:border-red-600 shadow-sm text-sm font-medium rounded-md text-red-700 dark:text-red-300 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/30 disabled:opacity-50">
                            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"
                               :class="{ 'animate-spin': criticalInsightsLoading }"></i>
                            <span x-text="criticalInsightsLoading ? 'Loading...' : 'Refresh'"></span>
                        </button>
                    </div>

                    <template x-if="criticalInsightsLoading">
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="loader mb-2"></div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Generating insights...</p>
                        </div>
                    </template>

                    <template x-if="criticalInsights && !criticalInsightsLoading">
                        <div>
                            <!-- Summary Dashboard -->
                            <div class="mb-4 grid grid-cols-4 gap-3">
                                <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-center">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Critical Issues</p>
                                    <p class="text-2xl font-bold text-red-600 dark:text-red-400"
                                       x-text="criticalInsights.summary?.critical_issues || 0"></p>
                                </div>
                                <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg text-center">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Warnings</p>
                                    <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400"
                                       x-text="criticalInsights.summary?.warnings || 0"></p>
                                </div>
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg text-center">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Optimizations</p>
                                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400"
                                       x-text="criticalInsights.summary?.optimization_opportunities || 0"></p>
                                </div>
                                <div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-center">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Potential Savings</p>
                                    <p class="text-2xl font-bold text-green-600 dark:text-green-400"
                                       x-text="(criticalInsights.summary?.total_potential_savings_hours || 0).toFixed(0) + 'h'"></p>
                                </div>
                            </div>

                            <!-- Critical Alerts -->
                            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                <!-- Version Regressions -->
                                <template
                                        x-if="criticalInsights.version_regressions && criticalInsights.version_regressions.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                            <i data-lucide="git-branch" class="h-4 w-4 mr-1 text-red-600"></i>
                                            Version Regressions
                                        </h4>
                                        <template x-for="reg in criticalInsights.version_regressions"
                                                  :key="reg.process_key">
                                            <div class="p-3 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-600 rounded mb-2">
                                                <p class="font-medium text-gray-900 dark:text-gray-100 mb-1"
                                                   x-text="reg.process_key"></p>
                                                <p class="text-sm text-red-700 dark:text-red-300 mb-2"
                                                   x-text="reg.recommendation"></p>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    <template x-for="action in reg.actions" :key="action">
                                                        <span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded"
                                                              x-text="'‚Ä¢ ' + action"></span>
                                                    </template>
                                                </div>
                                                <div x-show="reg.sample_instance_id"
                                                     class="mt-2 text-xs bg-white dark:bg-gray-800 p-2 rounded">
                                                    <code x-text="reg.sample_instance_id + ' | ' + (reg.sample_business_key || 'N/A')"></code>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Stuck Instances -->
                                <template
                                        x-if="criticalInsights.stuck_instances && criticalInsights.stuck_instances.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                            <i data-lucide="clock" class="h-4 w-4 mr-1 text-yellow-600"></i>
                                            Stuck Process Alerts
                                        </h4>
                                        <template x-for="stuck in criticalInsights.stuck_instances"
                                                  :key="stuck.process_key">
                                            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-600 rounded mb-2">
                                                <p class="font-medium text-gray-900 dark:text-gray-100 mb-1"
                                                   x-text="stuck.process_key"></p>
                                                <p class="text-sm text-yellow-700 dark:text-yellow-300 mb-2"
                                                   x-text="stuck.recommendation"></p>
                                                <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                                                    Oldest: <strong
                                                        x-text="stuck.oldest_days.toFixed(0) + ' days'"></strong> |
                                                    Total stuck: <strong x-text="stuck.stuck_count"></strong>
                                                </div>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    <template x-for="action in stuck.actions" :key="action">
                                                        <span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 rounded"
                                                              x-text="'‚Ä¢ ' + action"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Activity Targets -->
                                <template
                                        x-if="criticalInsights.activity_targets && criticalInsights.activity_targets.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                            <i data-lucide="target" class="h-4 w-4 mr-1 text-green-600"></i>
                                            Top Optimization Targets
                                        </h4>
                                        <template x-for="target in criticalInsights.activity_targets"
                                                  :key="target.rank">
                                            <div class="p-3 bg-green-50 dark:bg-green-900/20 border-l-4 border-green-600 rounded mb-2">
                                                <div class="flex items-start justify-between mb-2">
                                                    <div class="flex-1">
                                                        <p class="font-medium text-gray-900 dark:text-gray-100"
                                                           x-text="'#' + target.rank + ' - ' + target.process_key"></p>
                                                        <p class="text-xs text-gray-600 dark:text-gray-400"
                                                           x-text="target.activity_name + ' (' + target.activity_type + ')'"></p>
                                                    </div>
                                                    <span class="text-sm font-bold text-green-600 dark:text-green-400"
                                                          x-text="target.potential_savings_hours.toFixed(0) + 'h savings'"></span>
                                                </div>
                                                <p class="text-sm text-green-700 dark:text-green-300 mb-2"
                                                   x-text="target.recommendation"></p>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    <template x-for="action in target.actions" :key="action">
                                                        <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded"
                                                              x-text="'‚Ä¢ ' + action"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Load Optimizations -->
                                <template
                                        x-if="criticalInsights.load_optimizations && criticalInsights.load_optimizations.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                            <i data-lucide="trending-up" class="h-4 w-4 mr-1 text-blue-600"></i>
                                            Load Pattern Optimizations
                                        </h4>
                                        <template x-for="opt in criticalInsights.load_optimizations" :key="opt.type">
                                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-600 rounded mb-2">
                                                <p class="text-sm text-blue-700 dark:text-blue-300 mb-2"
                                                   x-text="opt.recommendation"></p>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    <template x-for="action in opt.actions" :key="action">
                                                        <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded"
                                                              x-text="'‚Ä¢ ' + action"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Extreme Variability Warnings -->
                                <template
                                        x-if="criticalInsights.extreme_variability && criticalInsights.extreme_variability.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                            <i data-lucide="alert-triangle" class="h-4 w-4 mr-1 text-orange-600"></i>
                                            Extreme Variability Warnings
                                        </h4>
                                        <template x-for="varItem in criticalInsights.extreme_variability"
                                                  :key="varItem.process_key">
                                            <div class="p-3 bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-600 rounded mb-2">
                                                <p class="font-medium text-gray-900 dark:text-gray-100 mb-1"
                                                   x-text="varItem.process_key"></p>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                                                    P95 is <strong x-text="varItem.ratio.toFixed(0) + 'x'"></strong> the
                                                    median
                                                    (<span x-text="formatDuration(varItem.median_s * 1000)"></span> ‚Üí
                                                    <span x-text="formatDuration(varItem.p95_s * 1000)"></span>)
                                                </p>
                                                <p class="text-sm text-orange-700 dark:text-orange-300 mb-2"
                                                   x-text="varItem.recommendation"></p>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    <template x-for="action in varItem.actions" :key="action">
                                                        <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded"
                                                              x-text="'‚Ä¢ ' + action"></span>
                                                    </template>
                                                </div>
                                                <div x-show="varItem.sample_instance_id"
                                                     class="mt-2 text-xs bg-white dark:bg-gray-800 p-2 rounded">
                                                    <code x-text="varItem.sample_instance_id + ' | ' + (varItem.sample_business_key || 'N/A')"></code>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Outlier Warnings -->
                                <template
                                        x-if="criticalInsights.outlier_warnings && criticalInsights.outlier_warnings.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                            <i data-lucide="activity" class="h-4 w-4 mr-1 text-purple-600"></i>
                                            Outlier-Heavy Processes
                                        </h4>
                                        <template x-for="outlier in criticalInsights.outlier_warnings"
                                                  :key="outlier.process_key">
                                            <div class="p-3 bg-purple-50 dark:bg-purple-900/20 border-l-4 border-purple-600 rounded mb-2">
                                                <p class="font-medium text-gray-900 dark:text-gray-100 mb-1"
                                                   x-text="outlier.process_key"></p>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                                                    <strong x-text="outlier.outlier_pct.toFixed(1) + '%'"></strong>
                                                    outliers
                                                    (<span x-text="outlier.outlier_count"></span> of <span
                                                        x-text="outlier.total_count"></span>)
                                                </p>
                                                <p class="text-sm text-purple-700 dark:text-purple-300 mb-2"
                                                   x-text="outlier.recommendation"></p>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    <template x-for="action in outlier.actions" :key="action">
                                                        <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded"
                                                              x-text="'‚Ä¢ ' + action"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

{% endblock %}

{% block extra_scripts %}
    <script>
        function aiAnalyticsMonitor() {
            return {
                ...baseMonitor(),

                // AI/ML states
                aiLoading: false,
                aiData: null,
                aiError: null,
                lastUpdate: new Date().toISOString(),
                selectedIncident: null,
                selectedAnomaly: null,
                selectedStuckProcess: null,
                selectedVariabilityAlert: null,
                selectedOutlierProcess: null,
                selectedCategory: null,
                selectedCategoryData: null,

                // Advanced ML features states
                stuckActivitiesData: null,
                stuckActivitiesLoading: false,
                capacityForecastData: null,
                capacityForecastLoading: false,
                durationPredictions: null,
                durationPredictionsLoading: false,
                durationPredictionsLoaded: false,

                // New data block states
                processCategories: null,
                processCategoriesLoading: false,
                stuckProcesses: null,
                stuckProcessesLoading: false,
                outlierPatterns: null,
                outlierPatternsLoading: false,
                extremeVariability: null,
                extremeVariabilityLoading: false,

                // NEW: Activity Bottlenecks
                activityBottlenecks: null,
                activityBottlenecksLoading: false,

                // NEW: Version History
                versionHistory: null,
                versionHistoryLoading: false,

                // NEW: Critical Insights
                criticalInsights: null,
                criticalInsightsLoading: false,

                // NEW: Weekly Load Patterns
                weeklyLoadPatterns: null,
                weeklyLoadPatternsLoading: false,

                init() {
                    // Initialize base monitor
                    this.darkMode = localStorage.getItem('darkMode') === 'true';
                    this.applyDarkMode();

                    // Auto-load AI insights on page load
                    this.loadAIInsights();

                    this.$nextTick(() => lucide.createIcons());
                },

                async refreshData() {
                    // Refresh AI insights
                    await this.refreshAIInsights();
                },

                // AI Insights loading
                async loadAIInsights() {
                    if (this.aiLoading || this.aiData) return;

                    this.aiLoading = true;
                    this.aiError = null;

                    try {
                        const response = await fetch('/api/ai/insights');
                        if (!response.ok) {
                            throw new Error(`Server responded with ${response.status}`);
                        }
                        const data = await response.json();
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        this.aiData = data;
                        this.lastUpdate = data.timestamp || new Date().toISOString();

                        console.log('AI Data loaded:', {
                            health_score: data.health_score?.overall_score || 0,
                            anomalies: data.anomalies?.anomalies?.length || 0,
                            sla_risks: data.sla_predictions?.at_risk_tasks?.length || 0,
                            bottlenecks: data.bottlenecks?.bottlenecks?.length || 0,
                            incidents: data.incidents?.total_incidents || 0,
                            critical_insights: data.critical_insights?.total_critical_alerts || 0,
                            outliers: data.outlier_patterns?.high_outlier_count || 0
                        });
                    } catch (error) {
                        console.error('Error loading AI insights:', error);
                        this.aiError = error.message;
                    } finally {
                        this.aiLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                async refreshAIInsights() {
                    this.aiData = null;
                    this.aiLoading = false;
                    await this.loadAIInsights();
                },

                // Advanced ML Features
                loadAdvancedMLFeatures() {
                    // This method is called when the advanced features section becomes visible
                    // Features are loaded on-demand when user clicks their respective buttons
                    console.log('Advanced ML features section visible - ready for on-demand loading');
                },

                async loadStuckActivities() {
                    if (this.stuckActivitiesLoading) return;

                    this.stuckActivitiesLoading = true;
                    try {
                        const response = await fetch('/api/ai/stuck-activities-smart');
                        if (response.ok) {
                            this.stuckActivitiesData = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading stuck activities:', error);
                    } finally {
                        this.stuckActivitiesLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                async loadCapacityForecast() {
                    if (this.capacityForecastLoading) return;

                    this.capacityForecastLoading = true;
                    try {
                        const response = await fetch('/api/ai/capacity-forecast');
                        if (response.ok) {
                            this.capacityForecastData = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading capacity forecast:', error);
                    } finally {
                        this.capacityForecastLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                async loadAllDurationPredictions() {
                    if (this.durationPredictionsLoading) return;

                    this.durationPredictionsLoading = true;
                    this.durationPredictionsLoaded = true;
                    try {
                        const response = await fetch('/api/ai/predict-all-durations');
                        if (response.ok) {
                            const data = await response.json();
                            // Sort by predicted duration (longest first), treating null as 0
                            this.durationPredictions = (data.predictions || []).sort((a, b) => {
                                const aDuration = a.predicted_duration_ms != null ? a.predicted_duration_ms : 0;
                                const bDuration = b.predicted_duration_ms != null ? b.predicted_duration_ms : 0;
                                return bDuration - aDuration;
                            });
                        }
                    } catch (error) {
                        console.error('Error loading all duration predictions:', error);
                    } finally {
                        this.durationPredictionsLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Process Categories
                async loadProcessCategories() {
                    if (this.processCategoriesLoading) return;

                    this.processCategoriesLoading = true;
                    try {
                        const response = await fetch('/api/ai/process-categories');
                        if (response.ok) {
                            this.processCategories = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading process categories:', error);
                    } finally {
                        this.processCategoriesLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Stuck Processes
                async loadStuckProcesses() {
                    if (this.stuckProcessesLoading) return;

                    this.stuckProcessesLoading = true;
                    try {
                        const response = await fetch('/api/ai/stuck-processes');
                        if (response.ok) {
                            this.stuckProcesses = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading stuck processes:', error);
                    } finally {
                        this.stuckProcessesLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Outlier Patterns
                async loadOutlierPatterns() {
                    if (this.outlierPatternsLoading) return;

                    this.outlierPatternsLoading = true;
                    try {
                        const response = await fetch('/api/ai/outlier-patterns');
                        if (response.ok) {
                            this.outlierPatterns = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading outlier patterns:', error);
                    } finally {
                        this.outlierPatternsLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Extreme Variability
                async loadExtremeVariability() {
                    if (this.extremeVariabilityLoading) return;

                    this.extremeVariabilityLoading = true;
                    try {
                        const response = await fetch('/api/ai/process-variability');
                        if (response.ok) {
                            this.extremeVariability = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading extreme variability:', error);
                    } finally {
                        this.extremeVariabilityLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Activity Bottlenecks
                async loadActivityBottlenecks() {
                    if (this.activityBottlenecksLoading) return;

                    this.activityBottlenecksLoading = true;
                    try {
                        const response = await fetch('/api/ai/activity-bottlenecks?days=30&limit=30');
                        if (response.ok) {
                            this.activityBottlenecks = await response.json();
                            console.log('Activity bottlenecks loaded:', this.activityBottlenecks);
                        }
                    } catch (error) {
                        console.error('Error loading activity bottlenecks:', error);
                    } finally {
                        this.activityBottlenecksLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Version History
                async loadVersionHistory() {
                    if (this.versionHistoryLoading) return;

                    this.versionHistoryLoading = true;
                    try {
                        const response = await fetch('/api/ai/version-history?days=180');
                        if (response.ok) {
                            this.versionHistory = await response.json();
                            // Initialize expanded state for each comparison
                            if (this.versionHistory.version_comparisons) {
                                this.versionHistory.version_comparisons.forEach(comp => {
                                    comp.expanded = false;
                                });
                            }
                            console.log('Version history loaded:', this.versionHistory);
                        }
                    } catch (error) {
                        console.error('Error loading version history:', error);
                    } finally {
                        this.versionHistoryLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Critical Insights
                async loadCriticalInsights() {
                    if (this.criticalInsightsLoading) return;

                    this.criticalInsightsLoading = true;
                    try {
                        const response = await fetch('/api/ai/critical-insights?days=30');
                        if (response.ok) {
                            this.criticalInsights = await response.json();
                            console.log('Critical insights loaded:', this.criticalInsights);
                        }
                    } catch (error) {
                        console.error('Error loading critical insights:', error);
                    } finally {
                        this.criticalInsightsLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // NEW: Load Weekly Load Patterns
                async loadWeeklyLoadPatterns() {
                    if (this.weeklyLoadPatternsLoading) return;

                    this.weeklyLoadPatternsLoading = true;
                    try {
                        const response = await fetch('/api/ai/load-patterns?days=90');
                        if (response.ok) {
                            this.weeklyLoadPatterns = await response.json();
                            console.log('Weekly load patterns loaded:', this.weeklyLoadPatterns);
                        }
                    } catch (error) {
                        console.error('Error loading weekly load patterns:', error);
                    } finally {
                        this.weeklyLoadPatternsLoading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // Helper: Get category description
                getCategoryDescription(category) {
                    const descriptions = {
                        'ultra_fast': 'Extremely fast processes that complete in under 5 seconds. Perfect for real-time user interactions and synchronous operations.',
                        'very_fast': 'Very responsive processes completing in 5-30 seconds. Excellent for user-facing workflows and API responses.',
                        'fast_background': 'Fast background processes completing in under 6 minutes. Suitable for async operations and background tasks.',
                        'standard': 'Standard business processes completing in 6-30 minutes. Typical for most automated workflows.',
                        'extended': 'Extended processes taking 30 minutes to 4 hours. Often involve complex processing or external system integration.',
                        'long_running': 'Long-running processes taking 4-24 hours. Typically batch jobs or data-intensive operations.',
                        'batch_manual': 'Very long processes exceeding 24 hours. Usually batch jobs, manual workflows, or special long-running operations.'
                    };
                    return descriptions[category] || 'No description available';
                },

                // Helper: Get all processes for a specific category
                getProcessesForCategory(category) {
                    if (!this.processCategories || !this.processCategories.categories) {
                        return [];
                    }

                    const processes = [];
                    for (const [key, data] of Object.entries(this.processCategories.categories)) {
                        if (data.category === category) {
                            processes.push({
                                key: key,
                                ...data
                            });
                        }
                    }

                    // Sort by median duration (fastest first)
                    return processes.sort((a, b) => a.median_seconds - b.median_seconds);
                }
            };
        }
    </script>
{% endblock %}



